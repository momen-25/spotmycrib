{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/home/momen/projects/spotmycrib-master/packages/montiapm:agent/lib/wait_time_builder.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.linux.x86_64"},"sourceFileName":"packages/montiapm:agent/lib/wait_time_builder.js","filename":"/home/momen/projects/spotmycrib-master/packages/montiapm:agent/lib/wait_time_builder.js","targets":{},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/home/momen/projects/spotmycrib-master","root":"/home/momen/projects/spotmycrib-master","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.13.10","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":{},"_verified":{},"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/home/momen/projects/spotmycrib-master/packages/montiapm:agent/lib/wait_time_builder.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"packages/montiapm:agent/lib/wait_time_builder.js"}},"code":"var WAITON_MESSAGE_FIELDS = ['msg', 'id', 'method', 'name', 'waitTime']; // This is way how we can build waitTime and it's breakdown\n\nWaitTimeBuilder = function () {\n  this._waitListStore = {};\n  this._currentProcessingMessages = {};\n  this._messageCache = {};\n};\n\nWaitTimeBuilder.prototype.register = function (session, msgId) {\n  var self = this;\n\n  var mainKey = self._getMessageKey(session.id, msgId);\n\n  var inQueue = session.inQueue || [];\n\n  if (typeof inQueue.toArray === 'function') {\n    // latest version of Meteor uses a double-ended-queue for the inQueue\n    // info: https://www.npmjs.com/package/double-ended-queue\n    inQueue = inQueue.toArray();\n  }\n\n  var waitList = inQueue.map(function (msg) {\n    var key = self._getMessageKey(session.id, msg.id);\n\n    return self._getCacheMessage(key, msg);\n  });\n  waitList = waitList || []; //add currently processing ddp message if exists\n\n  var currentlyProcessingMessage = this._currentProcessingMessages[session.id];\n\n  if (currentlyProcessingMessage) {\n    var key = self._getMessageKey(session.id, currentlyProcessingMessage.id);\n\n    waitList.unshift(this._getCacheMessage(key, currentlyProcessingMessage));\n  }\n\n  this._waitListStore[mainKey] = waitList;\n};\n\nWaitTimeBuilder.prototype.build = function (session, msgId) {\n  var mainKey = this._getMessageKey(session.id, msgId);\n\n  var waitList = this._waitListStore[mainKey] || [];\n  delete this._waitListStore[mainKey];\n  var filteredWaitList = waitList.map(this._cleanCacheMessage.bind(this));\n  return filteredWaitList;\n};\n\nWaitTimeBuilder.prototype._getMessageKey = function (sessionId, msgId) {\n  return sessionId + \"::\" + msgId;\n};\n\nWaitTimeBuilder.prototype._getCacheMessage = function (key, msg) {\n  var self = this;\n  var cachedMessage = self._messageCache[key];\n\n  if (!cachedMessage) {\n    self._messageCache[key] = cachedMessage = _.pick(msg, WAITON_MESSAGE_FIELDS);\n    cachedMessage._key = key;\n    cachedMessage._registered = 1;\n  } else {\n    cachedMessage._registered++;\n  }\n\n  return cachedMessage;\n};\n\nWaitTimeBuilder.prototype._cleanCacheMessage = function (msg) {\n  msg._registered--;\n\n  if (msg._registered == 0) {\n    delete this._messageCache[msg._key];\n  } // need to send a clean set of objects\n  // otherwise register can go with this\n\n\n  return _.pick(msg, WAITON_MESSAGE_FIELDS);\n};\n\nWaitTimeBuilder.prototype.trackWaitTime = function (session, msg, unblock) {\n  var self = this;\n  var started = Date.now();\n  self._currentProcessingMessages[session.id] = msg;\n  var unblocked = false;\n\n  var wrappedUnblock = function () {\n    if (!unblocked) {\n      var waitTime = Date.now() - started;\n\n      var key = self._getMessageKey(session.id, msg.id);\n\n      var cachedMessage = self._messageCache[key];\n\n      if (cachedMessage) {\n        cachedMessage.waitTime = waitTime;\n      }\n\n      delete self._currentProcessingMessages[session.id];\n      unblocked = true;\n      unblock();\n    }\n  };\n\n  return wrappedUnblock;\n};","map":{"version":3,"sources":["packages/montiapm:agent/lib/wait_time_builder.js"],"names":["WAITON_MESSAGE_FIELDS","WaitTimeBuilder","_waitListStore","_currentProcessingMessages","_messageCache","prototype","register","session","msgId","self","mainKey","_getMessageKey","id","inQueue","toArray","waitList","map","msg","key","_getCacheMessage","currentlyProcessingMessage","unshift","build","filteredWaitList","_cleanCacheMessage","bind","sessionId","cachedMessage","_","pick","_key","_registered","trackWaitTime","unblock","started","Date","now","unblocked","wrappedUnblock","waitTime"],"mappings":"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","sourcesContent":["var WAITON_MESSAGE_FIELDS = ['msg', 'id', 'method', 'name', 'waitTime'];\n\n// This is way how we can build waitTime and it's breakdown\nWaitTimeBuilder = function() {\n  this._waitListStore = {};\n  this._currentProcessingMessages = {};\n  this._messageCache = {};\n};\n\nWaitTimeBuilder.prototype.register = function(session, msgId) {\n  var self = this;\n  var mainKey = self._getMessageKey(session.id, msgId);\n\n  var inQueue = session.inQueue || [];\n  if(typeof inQueue.toArray === 'function') {\n    // latest version of Meteor uses a double-ended-queue for the inQueue\n    // info: https://www.npmjs.com/package/double-ended-queue\n    inQueue = inQueue.toArray();\n  }\n\n  var waitList = inQueue.map(function(msg) {\n    var key = self._getMessageKey(session.id, msg.id);\n    return self._getCacheMessage(key, msg);\n  });\n\n  waitList = waitList || [];\n\n  //add currently processing ddp message if exists\n  var currentlyProcessingMessage = this._currentProcessingMessages[session.id];\n  if(currentlyProcessingMessage) {\n    var key = self._getMessageKey(session.id, currentlyProcessingMessage.id);\n    waitList.unshift(this._getCacheMessage(key, currentlyProcessingMessage));\n  }\n\n  this._waitListStore[mainKey] = waitList;\n};\n\nWaitTimeBuilder.prototype.build = function(session, msgId) {\n  var mainKey = this._getMessageKey(session.id, msgId);\n  var waitList = this._waitListStore[mainKey] || [];\n  delete this._waitListStore[mainKey];\n\n  var filteredWaitList =  waitList.map(this._cleanCacheMessage.bind(this));\n  return filteredWaitList;\n};\n\nWaitTimeBuilder.prototype._getMessageKey = function(sessionId, msgId) {\n  return sessionId + \"::\" + msgId;\n};\n\nWaitTimeBuilder.prototype._getCacheMessage = function(key, msg) {\n  var self = this;\n  var cachedMessage = self._messageCache[key];\n  if(!cachedMessage) {\n    self._messageCache[key] = cachedMessage = _.pick(msg, WAITON_MESSAGE_FIELDS);\n    cachedMessage._key = key;\n    cachedMessage._registered = 1;\n  } else {\n    cachedMessage._registered++;\n  }\n\n  return cachedMessage;\n};\n\nWaitTimeBuilder.prototype._cleanCacheMessage = function(msg) {\n  msg._registered--;\n  if(msg._registered == 0) {\n    delete this._messageCache[msg._key];\n  }\n\n  // need to send a clean set of objects\n  // otherwise register can go with this\n  return _.pick(msg, WAITON_MESSAGE_FIELDS);\n};\n\nWaitTimeBuilder.prototype.trackWaitTime = function(session, msg, unblock) {\n  var self = this;\n  var started = Date.now();\n  self._currentProcessingMessages[session.id] = msg;\n\n  var unblocked = false;\n  var wrappedUnblock = function() {\n    if(!unblocked) {\n      var waitTime = Date.now() - started;\n      var key = self._getMessageKey(session.id, msg.id);\n      var cachedMessage = self._messageCache[key];\n      if(cachedMessage) {\n        cachedMessage.waitTime = waitTime;\n      }\n      delete self._currentProcessingMessages[session.id];\n      unblocked = true;\n      unblock();\n    }\n  };\n\n  return wrappedUnblock;\n};"]},"sourceType":"module","hash":"b29ba39ca935d5d0e3aeb2e1fc150126e6ffebf1"}
