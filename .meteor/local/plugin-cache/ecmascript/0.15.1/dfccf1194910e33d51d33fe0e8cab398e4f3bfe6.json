{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/home/momen/projects/spotmycrib-master/packages/mdg:meteor-apm-agent/lib/models/system.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.linux.x86_64"},"sourceFileName":"packages/mdg:meteor-apm-agent/lib/models/system.js","filename":"/home/momen/projects/spotmycrib-master/packages/mdg:meteor-apm-agent/lib/models/system.js","targets":{},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/home/momen/projects/spotmycrib-master","root":"/home/momen/projects/spotmycrib-master","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.13.10","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":{},"_verified":{},"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/home/momen/projects/spotmycrib-master/packages/mdg:meteor-apm-agent/lib/models/system.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"packages/mdg:meteor-apm-agent/lib/models/system.js"}},"code":"let size;\nmodule.link(\"../utils.js\", {\n  size(v) {\n    size = v;\n  }\n\n}, 0);\n\nvar os = Npm.require('os');\n\nvar usage = Npm.require('pidusage');\n\nvar EventLoopMonitor = Npm.require('evloop-monitor');\n\nSystemModel = function () {\n  var self = this;\n  this.startTime = Ntp._now();\n  this.newSessions = 0;\n  this.sessionTimeout = 1000 * 60 * 30; //30 min\n\n  this.usageLookup = Kadira._wrapAsync(usage.stat.bind(usage));\n  this.evloopMonitor = new EventLoopMonitor(200);\n  this.evloopMonitor.start();\n};\n\nObject.assign(SystemModel.prototype, KadiraModel.prototype);\n\nSystemModel.prototype.buildPayload = function () {\n  var metrics = {};\n\n  var now = Ntp._now();\n\n  metrics.startTime = Kadira.syncedDate.syncTime(this.startTime);\n  metrics.endTime = Kadira.syncedDate.syncTime(now);\n  metrics.sessions = size(Meteor.server.sessions);\n  metrics.memory = process.memoryUsage().rss / (1024 * 1024);\n  metrics.newSessions = this.newSessions;\n  this.newSessions = 0;\n  var usage = this.getUsage();\n  metrics.pcpu = usage.cpu;\n\n  if (usage.cpuInfo) {\n    metrics.cputime = usage.cpuInfo.cpuTime;\n    metrics.pcpuUser = usage.cpuInfo.pcpuUser;\n    metrics.pcpuSystem = usage.cpuInfo.pcpuSystem;\n  } // track eventloop blockness\n\n\n  metrics.pctEvloopBlock = this.evloopMonitor.status().pctBlock;\n  this.startTime = now;\n  return {\n    systemMetrics: [metrics]\n  };\n};\n\nSystemModel.prototype.getUsage = function () {\n  var usage = this.usageLookup(process.pid) || {};\n  Kadira.docSzCache.setPcpu(usage.cpu);\n  return usage;\n};\n\nSystemModel.prototype.handleSessionActivity = function (msg, session) {\n  if (msg.msg === 'connect' && !msg.session) {\n    this.countNewSession(session);\n  } else if (['sub', 'method'].indexOf(msg.msg) != -1) {\n    if (!this.isSessionActive(session)) {\n      this.countNewSession(session);\n    }\n  }\n\n  session._activeAt = Date.now();\n};\n\nSystemModel.prototype.countNewSession = function (session) {\n  if (!isLocalAddress(session.socket)) {\n    this.newSessions++;\n  }\n};\n\nSystemModel.prototype.isSessionActive = function (session) {\n  var inactiveTime = Date.now() - session._activeAt;\n\n  return inactiveTime < this.sessionTimeout;\n}; // ------------------------------------------------------------------------- //\n// http://regex101.com/r/iF3yR3/2\n\n\nvar isLocalHostRegex = /^(?:.*\\.local|localhost)(?:\\:\\d+)?|127(?:\\.\\d{1,3}){3}|192\\.168(?:\\.\\d{1,3}){2}|10(?:\\.\\d{1,3}){3}|172\\.(?:1[6-9]|2\\d|3[0-1])(?:\\.\\d{1,3}){2}$/; // http://regex101.com/r/hM5gD8/1\n\nvar isLocalAddressRegex = /^127(?:\\.\\d{1,3}){3}|192\\.168(?:\\.\\d{1,3}){2}|10(?:\\.\\d{1,3}){3}|172\\.(?:1[6-9]|2\\d|3[0-1])(?:\\.\\d{1,3}){2}$/;\n\nfunction isLocalAddress(socket) {\n  var host = socket.headers['host'];\n  if (host) return isLocalHostRegex.test(host);\n  var address = socket.headers['x-forwarded-for'] || socket.remoteAddress;\n  if (address) return isLocalAddressRegex.test(address);\n}","map":{"version":3,"sources":["packages/mdg:meteor-apm-agent/lib/models/system.js"],"names":["size","module","link","v","os","Npm","require","usage","EventLoopMonitor","SystemModel","self","startTime","Ntp","_now","newSessions","sessionTimeout","usageLookup","Kadira","_wrapAsync","stat","bind","evloopMonitor","start","Object","assign","prototype","KadiraModel","buildPayload","metrics","now","syncedDate","syncTime","endTime","sessions","Meteor","server","memory","process","memoryUsage","rss","getUsage","pcpu","cpu","cpuInfo","cputime","cpuTime","pcpuUser","pcpuSystem","pctEvloopBlock","status","pctBlock","systemMetrics","pid","docSzCache","setPcpu","handleSessionActivity","msg","session","countNewSession","indexOf","isSessionActive","_activeAt","Date","isLocalAddress","socket","inactiveTime","isLocalHostRegex","isLocalAddressRegex","host","headers","test","address","remoteAddress"],"mappings":"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","sourcesContent":["import { size } from \"../utils.js\";\n\nvar os = Npm.require('os');\nvar usage = Npm.require('pidusage');\nvar EventLoopMonitor = Npm.require('evloop-monitor');\n\nSystemModel = function () {\n  var self = this;\n  this.startTime = Ntp._now();\n  this.newSessions = 0;\n  this.sessionTimeout = 1000 * 60 * 30; //30 min\n\n  this.usageLookup = Kadira._wrapAsync(usage.stat.bind(usage));\n  this.evloopMonitor = new EventLoopMonitor(200);\n  this.evloopMonitor.start();\n}\n\nObject.assign(SystemModel.prototype, KadiraModel.prototype);\n\nSystemModel.prototype.buildPayload = function() {\n  var metrics = {};\n  var now = Ntp._now();\n  metrics.startTime = Kadira.syncedDate.syncTime(this.startTime);\n  metrics.endTime = Kadira.syncedDate.syncTime(now);\n\n  metrics.sessions = size(Meteor.server.sessions);\n  metrics.memory = process.memoryUsage().rss / (1024*1024);\n  metrics.newSessions = this.newSessions;\n  this.newSessions = 0;\n\n  var usage = this.getUsage();\n  metrics.pcpu = usage.cpu;\n  if(usage.cpuInfo) {\n    metrics.cputime = usage.cpuInfo.cpuTime;\n    metrics.pcpuUser = usage.cpuInfo.pcpuUser;\n    metrics.pcpuSystem = usage.cpuInfo.pcpuSystem;\n  }\n\n  // track eventloop blockness\n  metrics.pctEvloopBlock = this.evloopMonitor.status().pctBlock;\n\n  this.startTime = now;\n  return {systemMetrics: [metrics]};\n};\n\nSystemModel.prototype.getUsage = function() {\n  var usage = this.usageLookup(process.pid) || {};\n  Kadira.docSzCache.setPcpu(usage.cpu);\n  return usage;\n};\n\nSystemModel.prototype.handleSessionActivity = function(msg, session) {\n  if(msg.msg === 'connect' && !msg.session) {\n    this.countNewSession(session);\n  } else if(['sub', 'method'].indexOf(msg.msg) != -1) {\n    if(!this.isSessionActive(session)) {\n      this.countNewSession(session);\n    }\n  }\n  session._activeAt = Date.now();\n}\n\nSystemModel.prototype.countNewSession = function(session) {\n  if(!isLocalAddress(session.socket)) {\n    this.newSessions++;\n  }\n}\n\nSystemModel.prototype.isSessionActive = function(session) {\n  var inactiveTime = Date.now() - session._activeAt;\n  return inactiveTime < this.sessionTimeout;\n}\n\n// ------------------------------------------------------------------------- //\n\n// http://regex101.com/r/iF3yR3/2\nvar isLocalHostRegex = /^(?:.*\\.local|localhost)(?:\\:\\d+)?|127(?:\\.\\d{1,3}){3}|192\\.168(?:\\.\\d{1,3}){2}|10(?:\\.\\d{1,3}){3}|172\\.(?:1[6-9]|2\\d|3[0-1])(?:\\.\\d{1,3}){2}$/;\n\n// http://regex101.com/r/hM5gD8/1\nvar isLocalAddressRegex = /^127(?:\\.\\d{1,3}){3}|192\\.168(?:\\.\\d{1,3}){2}|10(?:\\.\\d{1,3}){3}|172\\.(?:1[6-9]|2\\d|3[0-1])(?:\\.\\d{1,3}){2}$/;\n\nfunction isLocalAddress (socket) {\n  var host = socket.headers['host'];\n  if(host) return isLocalHostRegex.test(host);\n  var address = socket.headers['x-forwarded-for'] || socket.remoteAddress;\n  if(address) return isLocalAddressRegex.test(address);\n}\n"]},"sourceType":"module","hash":"dfccf1194910e33d51d33fe0e8cab398e4f3bfe6"}
