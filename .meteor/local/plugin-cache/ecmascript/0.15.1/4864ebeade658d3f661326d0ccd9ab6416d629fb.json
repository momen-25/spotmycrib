{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/home/momen/projects/spotmycrib-master/packages/montiapm:agent/lib/ntp.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"web.browser.legacy"},"sourceFileName":"packages/montiapm:agent/lib/ntp.js","filename":"/home/momen/projects/spotmycrib-master/packages/montiapm:agent/lib/ntp.js","targets":{},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/home/momen/projects/spotmycrib-master","root":"/home/momen/projects/spotmycrib-master","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":true,"enforceStrictMode":false,"dynamicImport":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.13.10","helpers":true,"useESModules":false,"corejs":false}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"base$0$3","visitor":{"FunctionExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$4","visitor":{"ForInStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":{},"_verified":{},"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-arrow-functions","visitor":{"ArrowFunctionExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoped-functions","visitor":{"BlockStatement":{"enter":[null]},"SwitchCase":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-block-scoping","visitor":{"VariableDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"_exploded":true,"BlockStatement":{"enter":[null]},"SwitchStatement":{"enter":[null]},"Program":{"enter":[null]},"_verified":true,"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-classes","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ClassExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-computed-properties","visitor":{"ObjectExpression":{"exit":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-destructuring","visitor":{"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"VariableDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-for-of","visitor":{"ForOfStatement":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-object-super","visitor":{"ObjectExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-shorthand-properties","visitor":{"ObjectMethod":{"enter":[null]},"ObjectProperty":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-spread","visitor":{"ArrayExpression":{"enter":[null]},"CallExpression":{"enter":[null]},"NewExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-sticky-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{"loose":true}},{"key":"transform-typeof-symbol","visitor":{"UnaryExpression":{"enter":[null]},"_exploded":true,"_verified":true,"BlockStatement":{"enter":[null]},"CatchClause":{"enter":[null]},"DoWhileStatement":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForStatement":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"Program":{"enter":[null]},"ObjectMethod":{"enter":[null]},"SwitchStatement":{"enter":[null]},"WhileStatement":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]},"ForOfStatement":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"StaticBlock":{"enter":[null]},"TSModuleBlock":{"enter":[null]},"AssignmentPattern":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectPattern":{"enter":[null]}},"options":{}},{"key":"transform-unicode-regex","visitor":{"RegExpLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-property-literals","visitor":{"ObjectProperty":{"exit":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"regenerator-transform","visitor":{"_exploded":true,"_verified":true,"ObjectMethod":{"enter":[null],"exit":[null]},"ClassMethod":{"enter":[null],"exit":[null]},"ClassPrivateMethod":{"enter":[null],"exit":[null]},"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]}},"options":{}}],"presets":[],"generatorOpts":{"filename":"/home/momen/projects/spotmycrib-master/packages/montiapm:agent/lib/ntp.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"packages/montiapm:agent/lib/ntp.js"}},"code":"var logger = getLogger();\n\nNtp = function (endpoint) {\n  this.path = '/simplentp/sync';\n  this.setEndpoint(endpoint);\n  this.diff = 0;\n  this.synced = false;\n  this.reSyncCount = 0;\n  this.reSync = new Retry({\n    baseTimeout: 1000 * 60,\n    maxTimeout: 1000 * 60 * 10,\n    minCount: 0\n  });\n};\n\nNtp._now = function () {\n  var now = Date.now();\n\n  if (typeof now == 'number') {\n    return now;\n  } else if (now instanceof Date) {\n    // some extenal JS libraries override Date.now and returns a Date object\n    // which directly affect us. So we need to prepare for that\n    return now.getTime();\n  } else {\n    // trust me. I've seen now === undefined\n    return new Date().getTime();\n  }\n};\n\nNtp.prototype.setEndpoint = function (endpoint) {\n  this.endpoint = endpoint + this.path;\n};\n\nNtp.prototype.getTime = function () {\n  return Ntp._now() + Math.round(this.diff);\n};\n\nNtp.prototype.syncTime = function (localTime) {\n  return localTime + Math.ceil(this.diff);\n};\n\nNtp.prototype.sync = function () {\n  logger('init sync');\n  var self = this;\n  var retryCount = 0;\n  var retry = new Retry({\n    baseTimeout: 1000 * 20,\n    maxTimeout: 1000 * 60,\n    minCount: 1,\n    minTimeout: 0\n  });\n  syncTime();\n\n  function syncTime() {\n    if (retryCount < 5) {\n      logger('attempt time sync with server', retryCount); // if we send 0 to the retryLater, cacheDns will run immediately\n\n      retry.retryLater(retryCount++, cacheDns);\n    } else {\n      logger('maximum retries reached');\n      self.reSync.retryLater(self.reSyncCount++, function () {\n        var args = [].slice.call(arguments);\n        self.sync.apply(self, args);\n      });\n    }\n  } // first attempt is to cache dns. So, calculation does not\n  // include DNS resolution time\n\n\n  function cacheDns() {\n    self.getServerTime(function (err) {\n      if (!err) {\n        calculateTimeDiff();\n      } else {\n        syncTime();\n      }\n    });\n  }\n\n  function calculateTimeDiff() {\n    var clientStartTime = new Date().getTime();\n    self.getServerTime(function (err, serverTime) {\n      if (!err && serverTime) {\n        // (Date.now() + clientStartTime)/2 : Midpoint between req and res\n        var networkTime = (new Date().getTime() - clientStartTime) / 2;\n        var serverStartTime = serverTime - networkTime;\n        self.diff = serverStartTime - clientStartTime;\n        self.synced = true; // we need to send 1 into retryLater.\n\n        self.reSync.retryLater(self.reSyncCount++, function () {\n          var args = [].slice.call(arguments);\n          self.sync.apply(self, args);\n        });\n        logger('successfully updated diff value', self.diff);\n      } else {\n        syncTime();\n      }\n    });\n  }\n};\n\nNtp.prototype.getServerTime = function (callback) {\n  var self = this;\n\n  if (Meteor.isServer) {\n    Kadira.coreApi.get(self.path, {\n      noRetries: true\n    }).then(function (content) {\n      var serverTime = parseInt(content);\n      callback(null, serverTime);\n    }).catch(function (err) {\n      callback(err);\n    });\n  } else {\n    httpRequest('GET', self.endpoint + (\"?noCache=\" + new Date().getTime() + \"-\" + Math.random()), function (err, res) {\n      if (err) {\n        callback(err);\n      } else {\n        var serverTime = parseInt(res.content);\n        callback(null, serverTime);\n      }\n    });\n  }\n};\n\nfunction getLogger() {\n  if (Meteor.isServer) {\n    return Npm.require('debug')(\"kadira:ntp\");\n  } else {\n    return function (message) {\n      var canLogKadira = Meteor._localStorage.getItem('LOG_KADIRA') !== null && typeof console !== 'undefined';\n\n      if (canLogKadira) {\n        if (message) {\n          message = \"kadira:ntp \" + message;\n          arguments[0] = message;\n        }\n\n        console.log.apply(console, arguments);\n      }\n    };\n  }\n}","map":{"version":3,"sources":["packages/montiapm:agent/lib/ntp.js"],"names":["logger","getLogger","Ntp","endpoint","path","setEndpoint","diff","synced","reSyncCount","reSync","Retry","baseTimeout","maxTimeout","minCount","_now","now","Date","getTime","prototype","Math","round","syncTime","localTime","ceil","sync","self","retryCount","retry","minTimeout","retryLater","cacheDns","args","slice","call","arguments","apply","getServerTime","err","calculateTimeDiff","clientStartTime","serverTime","networkTime","serverStartTime","callback","Meteor","isServer","Kadira","coreApi","get","noRetries","then","content","parseInt","catch","httpRequest","random","res","Npm","require","message","canLogKadira","_localStorage","getItem","console","log"],"mappings":"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","sourcesContent":["var logger = getLogger();\n\nNtp = function (endpoint) {\n  this.path = '/simplentp/sync';\n  this.setEndpoint(endpoint);\n  this.diff = 0;\n  this.synced = false;\n  this.reSyncCount = 0;\n  this.reSync = new Retry({\n    baseTimeout: 1000*60,\n    maxTimeout: 1000*60*10,\n    minCount: 0\n  });\n}\n\nNtp._now = function() {\n  var now = Date.now();\n  if(typeof now == 'number') {\n    return now;\n  } else if(now instanceof Date) {\n    // some extenal JS libraries override Date.now and returns a Date object\n    // which directly affect us. So we need to prepare for that\n    return now.getTime();\n  } else {\n    // trust me. I've seen now === undefined\n    return (new Date()).getTime();\n  }\n};\n\nNtp.prototype.setEndpoint = function(endpoint) {\n  this.endpoint = endpoint + this.path;\n};\n\nNtp.prototype.getTime = function() {\n  return Ntp._now() + Math.round(this.diff);\n};\n\nNtp.prototype.syncTime = function(localTime) {\n  return localTime + Math.ceil(this.diff);\n};\n\nNtp.prototype.sync = function() {\n  logger('init sync');\n  var self = this;\n  var retryCount = 0;\n  var retry = new Retry({\n    baseTimeout: 1000*20,\n    maxTimeout: 1000*60,\n    minCount: 1,\n    minTimeout: 0\n  });\n  syncTime();\n\n  function syncTime () {\n    if(retryCount<5) {\n      logger('attempt time sync with server', retryCount);\n      // if we send 0 to the retryLater, cacheDns will run immediately\n      retry.retryLater(retryCount++, cacheDns);\n    } else {\n      logger('maximum retries reached');\n      self.reSync.retryLater(self.reSyncCount++, function () {\n        var args = [].slice.call(arguments);\n        self.sync.apply(self, args);\n      });\n    }\n  }\n\n  // first attempt is to cache dns. So, calculation does not\n  // include DNS resolution time\n  function cacheDns () {\n    self.getServerTime(function(err) {\n      if(!err) {\n        calculateTimeDiff();\n      } else {\n        syncTime();\n      }\n    });\n  }\n\n  function calculateTimeDiff () {\n    var clientStartTime = (new Date()).getTime();\n    self.getServerTime(function(err, serverTime) {\n      if(!err && serverTime) {\n        // (Date.now() + clientStartTime)/2 : Midpoint between req and res\n        var networkTime = ((new Date()).getTime() - clientStartTime)/2\n        var serverStartTime = serverTime - networkTime;\n        self.diff = serverStartTime - clientStartTime;\n        self.synced = true;\n        // we need to send 1 into retryLater.\n        self.reSync.retryLater(self.reSyncCount++, function () {\n          var args = [].slice.call(arguments);\n          self.sync.apply(self, args);\n        });\n        logger('successfully updated diff value', self.diff);\n      } else {\n        syncTime();\n      }\n    });\n  }\n}\n\nNtp.prototype.getServerTime = function(callback) {\n  var self = this;\n\n  if(Meteor.isServer) {\n    Kadira.coreApi.get(self.path, { noRetries: true }).then(content => {\n      var serverTime = parseInt(content);\n      callback(null, serverTime);\n    })\n    .catch(err => {\n      callback(err);\n    });\n  } else {\n    httpRequest('GET', self.endpoint + `?noCache=${new Date().getTime()}-${Math.random()}`, function(err, res) {\n      if (err) {\n        callback(err);\n      } else {\n        var serverTime = parseInt(res.content);\n        callback(null, serverTime);\n      }\n    });\n  }\n};\n\nfunction getLogger() {\n  if(Meteor.isServer) {\n    return Npm.require('debug')(\"kadira:ntp\");\n  } else {\n    return function(message) {\n      var canLogKadira =\n        Meteor._localStorage.getItem('LOG_KADIRA') !== null\n        && typeof console !== 'undefined';\n\n      if(canLogKadira) {\n        if(message) {\n          message = \"kadira:ntp \" + message;\n          arguments[0] = message;\n        }\n        console.log.apply(console, arguments);\n      }\n    }\n  }\n}\n"]},"sourceType":"module","hash":"4864ebeade658d3f661326d0ccd9ab6416d629fb"}
