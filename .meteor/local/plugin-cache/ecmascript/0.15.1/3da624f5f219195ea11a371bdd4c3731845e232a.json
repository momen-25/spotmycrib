{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/home/momen/projects/spotmycrib-master/packages/montiapm:agent/lib/check_for_oplog.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.linux.x86_64"},"sourceFileName":"packages/montiapm:agent/lib/check_for_oplog.js","filename":"/home/momen/projects/spotmycrib-master/packages/montiapm:agent/lib/check_for_oplog.js","targets":{},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/home/momen/projects/spotmycrib-master","root":"/home/momen/projects/spotmycrib-master","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.13.10","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":{},"_verified":{},"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/home/momen/projects/spotmycrib-master/packages/montiapm:agent/lib/check_for_oplog.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"packages/montiapm:agent/lib/check_for_oplog.js"}},"code":"// expose for testing purpose\nOplogCheck = {};\n\nOplogCheck._070 = function (cursorDescription) {\n  var options = cursorDescription.options;\n\n  if (options.limit) {\n    return {\n      code: \"070_LIMIT_NOT_SUPPORTED\",\n      reason: \"Meteor 0.7.0 does not support limit with oplog.\",\n      solution: \"Upgrade your app to Meteor version 0.7.2 or later.\"\n    };\n  }\n\n  ;\n\n  var exists$ = _.any(cursorDescription.selector, function (value, field) {\n    if (field.substr(0, 1) === '$') return true;\n  });\n\n  if (exists$) {\n    return {\n      code: \"070_$_NOT_SUPPORTED\",\n      reason: \"Meteor 0.7.0 supports only equal checks with oplog.\",\n      solution: \"Upgrade your app to Meteor version 0.7.2 or later.\"\n    };\n  }\n\n  ;\n\n  var onlyScalers = _.all(cursorDescription.selector, function (value, field) {\n    return typeof value === \"string\" || typeof value === \"number\" || typeof value === \"boolean\" || value === null || value instanceof Meteor.Collection.ObjectID;\n  });\n\n  if (!onlyScalers) {\n    return {\n      code: \"070_ONLY_SCALERS\",\n      reason: \"Meteor 0.7.0 only supports scalers as comparators.\",\n      solution: \"Upgrade your app to Meteor version 0.7.2 or later.\"\n    };\n  }\n\n  return true;\n};\n\nOplogCheck._071 = function (cursorDescription) {\n  var options = cursorDescription.options;\n  var matcher = new Minimongo.Matcher(cursorDescription.selector);\n\n  if (options.limit) {\n    return {\n      code: \"071_LIMIT_NOT_SUPPORTED\",\n      reason: \"Meteor 0.7.1 does not support limit with oplog.\",\n      solution: \"Upgrade your app to Meteor version 0.7.2 or later.\"\n    };\n  }\n\n  ;\n  return true;\n};\n\nOplogCheck.env = function () {\n  if (!process.env.MONGO_OPLOG_URL) {\n    return {\n      code: \"NO_ENV\",\n      reason: \"You haven't added oplog support for your the Meteor app.\",\n      solution: \"Add oplog support for your Meteor app. see: http://goo.gl/Co1jJc\"\n    };\n  } else {\n    return true;\n  }\n};\n\nOplogCheck.disableOplog = function (cursorDescription) {\n  if (cursorDescription.options._disableOplog) {\n    return {\n      code: \"DISABLE_OPLOG\",\n      reason: \"You've disable oplog for this cursor explicitly with _disableOplog option.\"\n    };\n  } else {\n    return true;\n  }\n}; // when creating Minimongo.Matcher object, if that's throws an exception\n// meteor won't do the oplog support\n\n\nOplogCheck.miniMongoMatcher = function (cursorDescription) {\n  if (Minimongo.Matcher) {\n    try {\n      var matcher = new Minimongo.Matcher(cursorDescription.selector);\n      return true;\n    } catch (ex) {\n      return {\n        code: \"MINIMONGO_MATCHER_ERROR\",\n        reason: \"There's something wrong in your mongo query: \" + ex.message,\n        solution: \"Check your selector and change it accordingly.\"\n      };\n    }\n  } else {\n    // If there is no Minimongo.Matcher, we don't need to check this\n    return true;\n  }\n};\n\nOplogCheck.miniMongoSorter = function (cursorDescription) {\n  var matcher = new Minimongo.Matcher(cursorDescription.selector);\n\n  if (Minimongo.Sorter && cursorDescription.options.sort) {\n    try {\n      var sorter = new Minimongo.Sorter(cursorDescription.options.sort, {\n        matcher: matcher\n      });\n      return true;\n    } catch (ex) {\n      return {\n        code: \"MINIMONGO_SORTER_ERROR\",\n        reason: \"Some of your sort specifiers are not supported: \" + ex.message,\n        solution: \"Check your sort specifiers and chage them accordingly.\"\n      };\n    }\n  } else {\n    return true;\n  }\n};\n\nOplogCheck.fields = function (cursorDescription) {\n  var options = cursorDescription.options;\n\n  if (options.fields) {\n    try {\n      LocalCollection._checkSupportedProjection(options.fields);\n\n      return true;\n    } catch (e) {\n      if (e.name === \"MinimongoError\") {\n        return {\n          code: \"NOT_SUPPORTED_FIELDS\",\n          reason: \"Some of the field filters are not supported: \" + e.message,\n          solution: \"Try removing those field filters.\"\n        };\n      } else {\n        throw e;\n      }\n    }\n  }\n\n  return true;\n};\n\nOplogCheck.skip = function (cursorDescription) {\n  if (cursorDescription.options.skip) {\n    return {\n      code: \"SKIP_NOT_SUPPORTED\",\n      reason: \"Skip does not support with oplog.\",\n      solution: \"Try to avoid using skip. Use range queries instead: http://goo.gl/b522Av\"\n    };\n  }\n\n  return true;\n};\n\nOplogCheck.where = function (cursorDescription) {\n  var matcher = new Minimongo.Matcher(cursorDescription.selector);\n\n  if (matcher.hasWhere()) {\n    return {\n      code: \"WHERE_NOT_SUPPORTED\",\n      reason: \"Meteor does not support queries with $where.\",\n      solution: \"Try to remove $where from your query. Use some alternative.\"\n    };\n  }\n\n  ;\n  return true;\n};\n\nOplogCheck.geo = function (cursorDescription) {\n  var matcher = new Minimongo.Matcher(cursorDescription.selector);\n\n  if (matcher.hasGeoQuery()) {\n    return {\n      code: \"GEO_NOT_SUPPORTED\",\n      reason: \"Meteor does not support queries with geo partial operators.\",\n      solution: \"Try to remove geo partial operators from your query if possible.\"\n    };\n  }\n\n  ;\n  return true;\n};\n\nOplogCheck.limitButNoSort = function (cursorDescription) {\n  var options = cursorDescription.options;\n\n  if (options.limit && !options.sort) {\n    return {\n      code: \"LIMIT_NO_SORT\",\n      reason: \"Meteor oplog implementation does not support limit without a sort specifier.\",\n      solution: \"Try adding a sort specifier.\"\n    };\n  }\n\n  ;\n  return true;\n};\n\nOplogCheck.olderVersion = function (cursorDescription, driver) {\n  if (driver && !driver.constructor.cursorSupported) {\n    return {\n      code: \"OLDER_VERSION\",\n      reason: \"Your Meteor version does not have oplog support.\",\n      solution: \"Upgrade your app to Meteor version 0.7.2 or later.\"\n    };\n  }\n\n  return true;\n};\n\nOplogCheck.gitCheckout = function (cursorDescription, driver) {\n  if (!Meteor.release) {\n    return {\n      code: \"GIT_CHECKOUT\",\n      reason: \"Seems like your Meteor version is based on a Git checkout and it doesn't have the oplog support.\",\n      solution: \"Try to upgrade your Meteor version.\"\n    };\n  }\n\n  return true;\n};\n\nvar preRunningMatchers = [OplogCheck.env, OplogCheck.disableOplog, OplogCheck.miniMongoMatcher];\nvar globalMatchers = [OplogCheck.fields, OplogCheck.skip, OplogCheck.where, OplogCheck.geo, OplogCheck.limitButNoSort, OplogCheck.miniMongoSorter, OplogCheck.olderVersion, OplogCheck.gitCheckout];\nvar versionMatchers = [[/^0\\.7\\.1/, OplogCheck._071], [/^0\\.7\\.0/, OplogCheck._070]];\n\nKadira.checkWhyNoOplog = function (cursorDescription, observerDriver) {\n  if (typeof Minimongo == 'undefined') {\n    return {\n      code: \"CANNOT_DETECT\",\n      reason: \"You are running an older Meteor version and Kadira can't check oplog state.\",\n      solution: \"Try updating your Meteor app\"\n    };\n  }\n\n  var result = runMatchers(preRunningMatchers, cursorDescription, observerDriver);\n\n  if (result !== true) {\n    return result;\n  }\n\n  var meteorVersion = Meteor.release;\n\n  for (var lc = 0; lc < versionMatchers.length; lc++) {\n    var matcherInfo = versionMatchers[lc];\n\n    if (matcherInfo[0].test(meteorVersion)) {\n      var matched = matcherInfo[1](cursorDescription, observerDriver);\n\n      if (matched !== true) {\n        return matched;\n      }\n    }\n  }\n\n  result = runMatchers(globalMatchers, cursorDescription, observerDriver);\n\n  if (result !== true) {\n    return result;\n  }\n\n  return {\n    code: \"OPLOG_SUPPORTED\",\n    reason: \"This query should support oplog. It's weird if it's not.\",\n    solution: \"Please contact Kadira support and let's discuss.\"\n  };\n};\n\nfunction runMatchers(matcherList, cursorDescription, observerDriver) {\n  for (var lc = 0; lc < matcherList.length; lc++) {\n    var matcher = matcherList[lc];\n    var matched = matcher(cursorDescription, observerDriver);\n\n    if (matched !== true) {\n      return matched;\n    }\n  }\n\n  return true;\n}","map":{"version":3,"sources":["packages/montiapm:agent/lib/check_for_oplog.js"],"names":["OplogCheck","_070","cursorDescription","options","limit","code","reason","solution","exists$","_","any","selector","value","field","substr","onlyScalers","all","Meteor","Collection","ObjectID","_071","matcher","Minimongo","Matcher","env","process","MONGO_OPLOG_URL","disableOplog","_disableOplog","miniMongoMatcher","ex","message","miniMongoSorter","Sorter","sort","sorter","fields","LocalCollection","_checkSupportedProjection","e","name","skip","where","hasWhere","geo","hasGeoQuery","limitButNoSort","olderVersion","driver","constructor","cursorSupported","gitCheckout","release","preRunningMatchers","globalMatchers","versionMatchers","Kadira","checkWhyNoOplog","observerDriver","result","runMatchers","meteorVersion","lc","length","matcherInfo","test","matched","matcherList"],"mappings":"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","sourcesContent":["// expose for testing purpose\nOplogCheck = {};\n\nOplogCheck._070 = function(cursorDescription) {\n  var options = cursorDescription.options;\n  if (options.limit) {\n    return {\n      code: \"070_LIMIT_NOT_SUPPORTED\",\n      reason: \"Meteor 0.7.0 does not support limit with oplog.\",\n      solution: \"Upgrade your app to Meteor version 0.7.2 or later.\"\n    }\n  };\n\n  var exists$ = _.any(cursorDescription.selector, function (value, field) {\n    if (field.substr(0, 1) === '$')\n      return true;\n  });\n\n  if(exists$) {\n    return {\n      code: \"070_$_NOT_SUPPORTED\",\n      reason: \"Meteor 0.7.0 supports only equal checks with oplog.\",\n      solution: \"Upgrade your app to Meteor version 0.7.2 or later.\"\n    }\n  };\n\n  var onlyScalers = _.all(cursorDescription.selector, function (value, field) {\n    return typeof value === \"string\" ||\n      typeof value === \"number\" ||\n      typeof value === \"boolean\" ||\n      value === null ||\n      value instanceof Meteor.Collection.ObjectID;\n  });\n\n  if(!onlyScalers) {\n    return {\n      code: \"070_ONLY_SCALERS\",\n      reason: \"Meteor 0.7.0 only supports scalers as comparators.\",\n      solution: \"Upgrade your app to Meteor version 0.7.2 or later.\"\n    }\n  }\n\n  return true;\n};\n\nOplogCheck._071 = function(cursorDescription) {\n  var options = cursorDescription.options;\n  var matcher = new Minimongo.Matcher(cursorDescription.selector);\n  if (options.limit) {\n    return {\n      code: \"071_LIMIT_NOT_SUPPORTED\",\n      reason: \"Meteor 0.7.1 does not support limit with oplog.\",\n      solution: \"Upgrade your app to Meteor version 0.7.2 or later.\"\n    }\n  };\n\n  return true;\n};\n\n\nOplogCheck.env = function() {\n  if(!process.env.MONGO_OPLOG_URL) {\n    return {\n      code: \"NO_ENV\",\n      reason: \"You haven't added oplog support for your the Meteor app.\",\n      solution: \"Add oplog support for your Meteor app. see: http://goo.gl/Co1jJc\"\n    }\n  } else {\n    return true;\n  }\n};\n\nOplogCheck.disableOplog = function(cursorDescription) {\n  if(cursorDescription.options._disableOplog) {\n    return {\n      code: \"DISABLE_OPLOG\",\n      reason: \"You've disable oplog for this cursor explicitly with _disableOplog option.\"\n    };\n  } else {\n    return true;\n  }\n};\n\n// when creating Minimongo.Matcher object, if that's throws an exception\n// meteor won't do the oplog support\nOplogCheck.miniMongoMatcher = function(cursorDescription) {\n  if(Minimongo.Matcher) {\n    try {\n      var matcher = new Minimongo.Matcher(cursorDescription.selector);\n      return true;\n    } catch(ex) {\n      return {\n        code: \"MINIMONGO_MATCHER_ERROR\",\n        reason: \"There's something wrong in your mongo query: \" +  ex.message,\n        solution: \"Check your selector and change it accordingly.\"\n      };\n    }\n  } else {\n    // If there is no Minimongo.Matcher, we don't need to check this\n    return true;\n  }\n};\n\nOplogCheck.miniMongoSorter = function(cursorDescription) {\n  var matcher = new Minimongo.Matcher(cursorDescription.selector);\n  if(Minimongo.Sorter && cursorDescription.options.sort) {\n    try {\n      var sorter = new Minimongo.Sorter(\n        cursorDescription.options.sort,\n        { matcher: matcher }\n      );\n      return true;\n    } catch(ex) {\n      return {\n        code: \"MINIMONGO_SORTER_ERROR\",\n        reason: \"Some of your sort specifiers are not supported: \" + ex.message,\n        solution: \"Check your sort specifiers and chage them accordingly.\"\n      }\n    }\n  } else {\n    return true;\n  }\n};\n\nOplogCheck.fields = function(cursorDescription) {\n  var options = cursorDescription.options;\n  if(options.fields) {\n    try {\n      LocalCollection._checkSupportedProjection(options.fields);\n      return true;\n    } catch (e) {\n      if (e.name === \"MinimongoError\") {\n        return {\n          code: \"NOT_SUPPORTED_FIELDS\",\n          reason: \"Some of the field filters are not supported: \" + e.message,\n          solution: \"Try removing those field filters.\"\n        };\n      } else {\n        throw e;\n      }\n    }\n  }\n  return true;\n};\n\nOplogCheck.skip = function(cursorDescription) {\n  if(cursorDescription.options.skip) {\n    return {\n      code: \"SKIP_NOT_SUPPORTED\",\n      reason: \"Skip does not support with oplog.\",\n      solution: \"Try to avoid using skip. Use range queries instead: http://goo.gl/b522Av\"\n    };\n  }\n\n  return true;\n};\n\nOplogCheck.where = function(cursorDescription) {\n  var matcher = new Minimongo.Matcher(cursorDescription.selector);\n  if(matcher.hasWhere()) {\n    return {\n      code: \"WHERE_NOT_SUPPORTED\",\n      reason: \"Meteor does not support queries with $where.\",\n      solution: \"Try to remove $where from your query. Use some alternative.\"\n    }\n  };\n\n  return true;\n};\n\nOplogCheck.geo = function(cursorDescription) {\n  var matcher = new Minimongo.Matcher(cursorDescription.selector);\n\n  if(matcher.hasGeoQuery()) {\n    return {\n      code: \"GEO_NOT_SUPPORTED\",\n      reason: \"Meteor does not support queries with geo partial operators.\",\n      solution: \"Try to remove geo partial operators from your query if possible.\"\n    }\n  };\n\n  return true;\n};\n\nOplogCheck.limitButNoSort = function(cursorDescription) {\n  var options = cursorDescription.options;\n\n  if((options.limit && !options.sort)) {\n    return {\n      code: \"LIMIT_NO_SORT\",\n      reason: \"Meteor oplog implementation does not support limit without a sort specifier.\",\n      solution: \"Try adding a sort specifier.\"\n    }\n  };\n\n  return true;\n};\n\nOplogCheck.olderVersion = function(cursorDescription, driver) {\n  if(driver && !driver.constructor.cursorSupported) {\n    return {\n      code: \"OLDER_VERSION\",\n      reason: \"Your Meteor version does not have oplog support.\",\n      solution: \"Upgrade your app to Meteor version 0.7.2 or later.\"\n    };\n  }\n  return true;\n};\n\nOplogCheck.gitCheckout = function(cursorDescription, driver) {\n  if(!Meteor.release) {\n    return {\n      code: \"GIT_CHECKOUT\",\n      reason: \"Seems like your Meteor version is based on a Git checkout and it doesn't have the oplog support.\",\n      solution: \"Try to upgrade your Meteor version.\"\n    };\n  }\n  return true;\n};\n\nvar preRunningMatchers = [\n  OplogCheck.env,\n  OplogCheck.disableOplog,\n  OplogCheck.miniMongoMatcher\n];\n\nvar globalMatchers = [\n  OplogCheck.fields,\n  OplogCheck.skip,\n  OplogCheck.where,\n  OplogCheck.geo,\n  OplogCheck.limitButNoSort,\n  OplogCheck.miniMongoSorter,\n  OplogCheck.olderVersion,\n  OplogCheck.gitCheckout\n];\n\nvar versionMatchers = [\n  [/^0\\.7\\.1/, OplogCheck._071],\n  [/^0\\.7\\.0/, OplogCheck._070],\n];\n\nKadira.checkWhyNoOplog = function(cursorDescription, observerDriver) {\n  if(typeof Minimongo == 'undefined') {\n    return {\n      code: \"CANNOT_DETECT\",\n      reason: \"You are running an older Meteor version and Kadira can't check oplog state.\",\n      solution: \"Try updating your Meteor app\"\n    }\n  }\n\n  var result = runMatchers(preRunningMatchers, cursorDescription, observerDriver);\n  if(result !== true) {\n    return result;\n  }\n\n  var meteorVersion = Meteor.release;\n  for(var lc=0; lc<versionMatchers.length; lc++) {\n    var matcherInfo = versionMatchers[lc];\n    if(matcherInfo[0].test(meteorVersion)) {\n      var matched = matcherInfo[1](cursorDescription, observerDriver);\n      if(matched !== true) {\n        return matched;\n      }\n    }\n  }\n\n  result = runMatchers(globalMatchers, cursorDescription, observerDriver);\n  if(result !== true) {\n    return result;\n  }\n\n  return {\n    code: \"OPLOG_SUPPORTED\",\n    reason: \"This query should support oplog. It's weird if it's not.\",\n    solution: \"Please contact Kadira support and let's discuss.\"\n  };\n};\n\nfunction runMatchers(matcherList, cursorDescription, observerDriver) {\n  for(var lc=0; lc<matcherList.length; lc++) {\n    var matcher = matcherList[lc];\n    var matched = matcher(cursorDescription, observerDriver);\n    if(matched !== true) {\n      return matched;\n    }\n  }\n  return true;\n}\n"]},"sourceType":"module","hash":"3da624f5f219195ea11a371bdd4c3731845e232a"}
