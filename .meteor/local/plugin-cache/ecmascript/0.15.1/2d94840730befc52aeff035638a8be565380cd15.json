{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/home/momen/projects/spotmycrib-master/packages/mdg:meteor-apm-agent/lib/kadira.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.linux.x86_64"},"sourceFileName":"packages/mdg:meteor-apm-agent/lib/kadira.js","filename":"/home/momen/projects/spotmycrib-master/packages/mdg:meteor-apm-agent/lib/kadira.js","targets":{},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/home/momen/projects/spotmycrib-master","root":"/home/momen/projects/spotmycrib-master","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.13.10","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":{},"_verified":{},"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/home/momen/projects/spotmycrib-master/packages/mdg:meteor-apm-agent/lib/kadira.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"packages/mdg:meteor-apm-agent/lib/kadira.js"}},"code":"var hostname = Npm.require('os').hostname();\n\nvar logger = Npm.require('debug')('kadira:apm');\n\nvar Fibers = Npm.require('fibers');\n\nvar KadiraCore = Npm.require('kadira-core').Kadira;\n\nKadira.models = {};\nKadira.options = {};\nKadira.env = {\n  currentSub: null,\n  // keep current subscription inside ddp\n  kadiraInfo: new Meteor.EnvironmentVariable()\n};\nKadira.waitTimeBuilder = new WaitTimeBuilder();\nKadira.errors = [];\nKadira.errors.addFilter = Kadira.errors.push.bind(Kadira.errors);\nKadira.models.methods = new MethodsModel();\nKadira.models.pubsub = new PubsubModel();\nKadira.models.system = new SystemModel();\nKadira.docSzCache = new DocSzCache(100000, 10);\n\nKadira.connect = function (appId, appSecret, options) {\n  options = options || {};\n  options.appId = appId;\n  options.appSecret = appSecret;\n  options.payloadTimeout = options.payloadTimeout || 1000 * 20;\n  options.endpoint = options.endpoint || \"https://enginex.kadira.io\";\n  options.clientEngineSyncDelay = options.clientEngineSyncDelay || 10000;\n  options.thresholds = options.thresholds || {};\n  options.isHostNameSet = !!options.hostname;\n  options.hostname = options.hostname || hostname;\n  options.proxy = options.proxy || null;\n\n  if (options.documentSizeCacheSize) {\n    Kadira.docSzCache = new DocSzCache(options.documentSizeCacheSize, 10);\n  } // remove trailing slash from endpoint url (if any)\n\n\n  if (_.last(options.endpoint) === '/') {\n    options.endpoint = options.endpoint.substr(0, options.endpoint.length - 1);\n  } // error tracking is enabled by default\n\n\n  if (options.enableErrorTracking === undefined) {\n    options.enableErrorTracking = true;\n  }\n\n  Kadira.options = options;\n  Kadira.options.authHeaders = {\n    'KADIRA-APP-ID': Kadira.options.appId,\n    'KADIRA-APP-SECRET': Kadira.options.appSecret\n  };\n  Kadira.syncedDate = new Ntp(options.endpoint);\n  Kadira.syncedDate.sync();\n  Kadira.models.error = new ErrorModel(appId); // handle pre-added filters\n\n  var addFilterFn = Kadira.models.error.addFilter.bind(Kadira.models.error);\n  Kadira.errors.forEach(addFilterFn);\n  Kadira.errors = Kadira.models.error; // setting runtime info, which will be sent to kadira\n\n  __meteor_runtime_config__.kadira = {\n    appId: appId,\n    endpoint: options.endpoint,\n    clientEngineSyncDelay: options.clientEngineSyncDelay\n  };\n\n  if (options.enableErrorTracking) {\n    Kadira.enableErrorTracking();\n  } else {\n    Kadira.disableErrorTracking();\n  }\n\n  if (appId && appSecret) {\n    options.appId = options.appId.trim();\n    options.appSecret = options.appSecret.trim();\n    Kadira.coreApi = new KadiraCore({\n      appId: options.appId,\n      appSecret: options.appSecret,\n      endpoint: options.endpoint,\n      hostname: options.hostname\n    });\n\n    Kadira.coreApi._checkAuth().then(function () {\n      logger('connected to app: ', appId);\n      console.log('Meteor APM: Successfully connected');\n\n      Kadira._sendAppStats();\n\n      Kadira._schedulePayloadSend();\n    }).catch(function (err) {\n      console.log('Meteor APM: authentication failed - check your appId & appSecret');\n    });\n  } else {\n    throw new Error('Meteor APM: required appId and appSecret');\n  } // start tracking errors\n\n\n  Meteor.startup(function () {\n    TrackUncaughtExceptions();\n    TrackMeteorDebug();\n  });\n  Meteor.publish(null, function () {\n    var options = __meteor_runtime_config__.kadira;\n    this.added('kadira_settings', Random.id(), options);\n    this.ready();\n  }); // notify we've connected\n\n  Kadira.connected = true;\n}; //track how many times we've sent the data (once per minute)\n\n\nKadira._buildPayload = function () {\n  var payload = {\n    host: Kadira.options.hostname\n  };\n\n  var buildDetailedInfo = Kadira._isDetailedInfo();\n\n  Object.assign(payload, Kadira.models.methods.buildPayload(buildDetailedInfo));\n  Object.assign(payload, Kadira.models.pubsub.buildPayload(buildDetailedInfo));\n  Object.assign(payload, Kadira.models.system.buildPayload());\n\n  if (Kadira.options.enableErrorTracking) {\n    Object.assign(payload, Kadira.models.error.buildPayload());\n  }\n\n  return payload;\n};\n\nKadira._countDataSent = 0;\nKadira._detailInfoSentInterval = Math.ceil(1000 * 60 / Kadira.options.payloadTimeout);\n\nKadira._isDetailedInfo = function () {\n  return Kadira._countDataSent++ % Kadira._detailInfoSentInterval == 0;\n};\n\nKadira._sendAppStats = function () {\n  var appStats = {};\n  appStats.release = Meteor.release;\n  appStats.protocolVersion = '1.0.0';\n  appStats.packageVersions = [];\n  appStats.appVersions = {\n    webapp: __meteor_runtime_config__['autoupdateVersion'],\n    refreshable: __meteor_runtime_config__['autoupdateVersionRefreshable'],\n    cordova: __meteor_runtime_config__['autoupdateVersionCordova']\n  }; // TODO get version number for installed packages\n\n  _.each(Package, function (v, name) {\n    appStats.packageVersions.push({\n      name: name,\n      version: null\n    });\n  });\n\n  Kadira.coreApi.sendData({\n    startTime: new Date(),\n    appStats: appStats\n  }).catch(function (err) {\n    console.error('Kadira Error on sending appStats:', err.message);\n  });\n};\n\nKadira._schedulePayloadSend = function () {\n  setTimeout(function () {\n    Kadira._sendPayload(Kadira._schedulePayloadSend);\n  }, Kadira.options.payloadTimeout);\n};\n\nKadira._sendPayload = function (callback) {\n  new Fibers(function () {\n    var payload = Kadira._buildPayload();\n\n    Kadira.coreApi.sendData(payload).then(callback).catch(function (err) {\n      console.log('Meteor APM Error:', err.message);\n      callback();\n    });\n  }).run();\n}; // this return the __kadiraInfo from the current Fiber by default\n// if called with 2nd argument as true, it will get the kadira info from\n// Meteor.EnvironmentVariable\n//\n// WARNING: returned info object is the reference object.\n//  Changing it might cause issues when building traces. So use with care\n\n\nKadira._getInfo = function (currentFiber, useEnvironmentVariable) {\n  currentFiber = currentFiber || Fibers.current;\n\n  if (currentFiber) {\n    if (useEnvironmentVariable) {\n      return Kadira.env.kadiraInfo.get();\n    }\n\n    return currentFiber.__kadiraInfo;\n  }\n}; // this does not clone the info object. So, use with care\n\n\nKadira._setInfo = function (info) {\n  Fibers.current.__kadiraInfo = info;\n};\n\nKadira.enableErrorTracking = function () {\n  __meteor_runtime_config__.kadira.enableErrorTracking = true;\n  Kadira.options.enableErrorTracking = true;\n};\n\nKadira.disableErrorTracking = function () {\n  __meteor_runtime_config__.kadira.enableErrorTracking = false;\n  Kadira.options.enableErrorTracking = false;\n};\n\nKadira.trackError = function (type, message, options) {\n  if (Kadira.options.enableErrorTracking && type && message) {\n    options = options || {};\n    options.subType = options.subType || 'server';\n    options.stacks = options.stacks || '';\n    var error = {\n      message: message,\n      stack: options.stacks\n    };\n    var trace = {\n      type: type,\n      subType: options.subType,\n      name: message,\n      errored: true,\n      at: Kadira.syncedDate.getTime(),\n      events: [['start', 0, {}], ['error', 0, {\n        error: error\n      }]],\n      metrics: {\n        total: 0\n      }\n    };\n    Kadira.models.error.trackError(error, trace);\n  }\n};\n\nKadira.ignoreErrorTracking = function (err) {\n  err._skipKadira = true;\n};","map":{"version":3,"sources":["packages/mdg:meteor-apm-agent/lib/kadira.js"],"names":["hostname","Npm","require","logger","Fibers","KadiraCore","Kadira","models","options","env","currentSub","kadiraInfo","Meteor","EnvironmentVariable","waitTimeBuilder","WaitTimeBuilder","errors","addFilter","push","bind","methods","MethodsModel","pubsub","PubsubModel","system","SystemModel","docSzCache","DocSzCache","connect","appId","appSecret","payloadTimeout","endpoint","clientEngineSyncDelay","thresholds","isHostNameSet","proxy","documentSizeCacheSize","_","last","substr","length","enableErrorTracking","undefined","authHeaders","syncedDate","Ntp","sync","error","ErrorModel","addFilterFn","forEach","__meteor_runtime_config__","kadira","disableErrorTracking","trim","coreApi","_checkAuth","then","console","log","_sendAppStats","_schedulePayloadSend","catch","err","Error","startup","TrackUncaughtExceptions","TrackMeteorDebug","publish","added","Random","id","ready","connected","_buildPayload","payload","host","buildDetailedInfo","_isDetailedInfo","Object","assign","buildPayload","_countDataSent","_detailInfoSentInterval","Math","ceil","appStats","release","protocolVersion","packageVersions","appVersions","webapp","refreshable","cordova","each","Package","v","name","version","sendData","startTime","Date","message","setTimeout","_sendPayload","callback","run","_getInfo","currentFiber","useEnvironmentVariable","current","get","__kadiraInfo","_setInfo","info","trackError","type","subType","stacks","stack","trace","errored","at","getTime","events","metrics","total","ignoreErrorTracking","_skipKadira"],"mappings":"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","sourcesContent":["var hostname = Npm.require('os').hostname();\nvar logger = Npm.require('debug')('kadira:apm');\nvar Fibers = Npm.require('fibers');\n\nvar KadiraCore = Npm.require('kadira-core').Kadira;\n\nKadira.models = {};\nKadira.options = {};\nKadira.env = {\n  currentSub: null, // keep current subscription inside ddp\n  kadiraInfo: new Meteor.EnvironmentVariable(),\n};\nKadira.waitTimeBuilder = new WaitTimeBuilder();\nKadira.errors = [];\nKadira.errors.addFilter = Kadira.errors.push.bind(Kadira.errors);\n\nKadira.models.methods = new MethodsModel();\nKadira.models.pubsub = new PubsubModel();\nKadira.models.system = new SystemModel();\nKadira.docSzCache = new DocSzCache(100000, 10);\n\n\nKadira.connect = function(appId, appSecret, options) {\n  options = options || {};\n  options.appId = appId;\n  options.appSecret = appSecret;\n  options.payloadTimeout = options.payloadTimeout || 1000 * 20;\n  options.endpoint = options.endpoint || \"https://enginex.kadira.io\";\n  options.clientEngineSyncDelay = options.clientEngineSyncDelay || 10000;\n  options.thresholds = options.thresholds || {};\n  options.isHostNameSet = !!options.hostname;\n  options.hostname = options.hostname || hostname;\n  options.proxy = options.proxy || null;\n\n  if(options.documentSizeCacheSize) {\n    Kadira.docSzCache = new DocSzCache(options.documentSizeCacheSize, 10);\n  }\n\n  // remove trailing slash from endpoint url (if any)\n  if(_.last(options.endpoint) === '/') {\n    options.endpoint = options.endpoint.substr(0, options.endpoint.length - 1);\n  }\n\n  // error tracking is enabled by default\n  if(options.enableErrorTracking === undefined) {\n    options.enableErrorTracking = true;\n  }\n\n  Kadira.options = options;\n  Kadira.options.authHeaders = {\n    'KADIRA-APP-ID': Kadira.options.appId,\n    'KADIRA-APP-SECRET': Kadira.options.appSecret\n  };\n\n  Kadira.syncedDate = new Ntp(options.endpoint);\n  Kadira.syncedDate.sync();\n  Kadira.models.error = new ErrorModel(appId);\n\n  // handle pre-added filters\n  var addFilterFn = Kadira.models.error.addFilter.bind(Kadira.models.error);\n  Kadira.errors.forEach(addFilterFn);\n  Kadira.errors = Kadira.models.error;\n\n  // setting runtime info, which will be sent to kadira\n  __meteor_runtime_config__.kadira = {\n    appId: appId,\n    endpoint: options.endpoint,\n    clientEngineSyncDelay: options.clientEngineSyncDelay,\n  };\n\n  if(options.enableErrorTracking) {\n    Kadira.enableErrorTracking();\n  } else {\n    Kadira.disableErrorTracking();\n  }\n\n  if(appId && appSecret) {\n    options.appId = options.appId.trim();\n    options.appSecret = options.appSecret.trim();\n\n    Kadira.coreApi = new KadiraCore({\n      appId: options.appId,\n      appSecret: options.appSecret,\n      endpoint: options.endpoint,\n      hostname: options.hostname\n    });\n\n    Kadira.coreApi._checkAuth()\n      .then(function() {\n        logger('connected to app: ', appId);\n        console.log('Meteor APM: Successfully connected');\n        Kadira._sendAppStats();\n        Kadira._schedulePayloadSend();\n      })\n      .catch(function(err) {\n        console.log('Meteor APM: authentication failed - check your appId & appSecret')\n      });\n  } else {\n    throw new Error('Meteor APM: required appId and appSecret');\n  }\n\n  // start tracking errors\n  Meteor.startup(function () {\n    TrackUncaughtExceptions();\n    TrackMeteorDebug();\n  })\n\n  Meteor.publish(null, function () {\n    var options = __meteor_runtime_config__.kadira;\n    this.added('kadira_settings', Random.id(), options);\n    this.ready();\n  });\n\n  // notify we've connected\n  Kadira.connected = true;\n};\n\n//track how many times we've sent the data (once per minute)\nKadira._buildPayload = function () {\n  var payload = {host: Kadira.options.hostname};\n  var buildDetailedInfo = Kadira._isDetailedInfo();\n  Object.assign(payload, Kadira.models.methods.buildPayload(buildDetailedInfo));\n  Object.assign(payload, Kadira.models.pubsub.buildPayload(buildDetailedInfo));\n  Object.assign(payload, Kadira.models.system.buildPayload());\n  if(Kadira.options.enableErrorTracking) {\n    Object.assign(payload, Kadira.models.error.buildPayload());\n  }\n\n  return payload;\n}\n\nKadira._countDataSent = 0;\nKadira._detailInfoSentInterval = Math.ceil((1000*60) / Kadira.options.payloadTimeout);\nKadira._isDetailedInfo = function () {\n  return (Kadira._countDataSent++ % Kadira._detailInfoSentInterval) == 0;\n}\n\nKadira._sendAppStats = function () {\n  var appStats = {};\n  appStats.release = Meteor.release;\n  appStats.protocolVersion = '1.0.0';\n  appStats.packageVersions = [];\n  appStats.appVersions = {\n    webapp: __meteor_runtime_config__['autoupdateVersion'],\n    refreshable: __meteor_runtime_config__['autoupdateVersionRefreshable'],\n    cordova: __meteor_runtime_config__['autoupdateVersionCordova']\n  }\n\n  // TODO get version number for installed packages\n  _.each(Package, function (v, name) {\n    appStats.packageVersions.push({name: name, version: null});\n  });\n\n  Kadira.coreApi.sendData({\n    startTime: new Date(),\n    appStats: appStats\n  }).catch(function(err) {\n    console.error('Kadira Error on sending appStats:', err.message);\n  });\n}\n\nKadira._schedulePayloadSend = function () {\n  setTimeout(function () {\n    Kadira._sendPayload(Kadira._schedulePayloadSend);\n  }, Kadira.options.payloadTimeout);\n}\n\nKadira._sendPayload = function (callback) {\n  new Fibers(function() {\n    var payload = Kadira._buildPayload();\n    Kadira.coreApi.sendData(payload)\n    .then(callback)\n    .catch(function(err) {\n      console.log('Meteor APM Error:', err.message);\n      callback();\n    });\n  }).run();\n}\n\n// this return the __kadiraInfo from the current Fiber by default\n// if called with 2nd argument as true, it will get the kadira info from\n// Meteor.EnvironmentVariable\n//\n// WARNING: returned info object is the reference object.\n//  Changing it might cause issues when building traces. So use with care\nKadira._getInfo = function(currentFiber, useEnvironmentVariable) {\n  currentFiber = currentFiber || Fibers.current;\n  if(currentFiber) {\n    if(useEnvironmentVariable) {\n      return Kadira.env.kadiraInfo.get();\n    }\n    return currentFiber.__kadiraInfo;\n  }\n};\n\n// this does not clone the info object. So, use with care\nKadira._setInfo = function(info) {\n  Fibers.current.__kadiraInfo = info;\n};\n\nKadira.enableErrorTracking = function () {\n  __meteor_runtime_config__.kadira.enableErrorTracking = true;\n  Kadira.options.enableErrorTracking = true;\n};\n\nKadira.disableErrorTracking = function () {\n  __meteor_runtime_config__.kadira.enableErrorTracking = false;\n  Kadira.options.enableErrorTracking = false;\n};\n\nKadira.trackError = function (type, message, options) {\n  if(Kadira.options.enableErrorTracking && type && message) {\n    options = options || {};\n    options.subType = options.subType || 'server';\n    options.stacks = options.stacks || '';\n    var error = {message: message, stack: options.stacks};\n    var trace = {\n      type: type,\n      subType: options.subType,\n      name: message,\n      errored: true,\n      at: Kadira.syncedDate.getTime(),\n      events: [['start', 0, {}], ['error', 0, {error: error}]],\n      metrics: {total: 0}\n    };\n    Kadira.models.error.trackError(error, trace);\n  }\n}\n\nKadira.ignoreErrorTracking = function (err) {\n  err._skipKadira = true;\n}\n"]},"sourceType":"module","hash":"2d94840730befc52aeff035638a8be565380cd15"}
