{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/home/momen/projects/spotmycrib-master/server/cronjobs/functions.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.linux.x86_64"},"sourceFileName":"server/cronjobs/functions.js","filename":"/home/momen/projects/spotmycrib-master/server/cronjobs/functions.js","targets":{},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/home/momen/projects/spotmycrib-master","root":"/home/momen/projects/spotmycrib-master","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.13.10","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":{},"_verified":{},"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/home/momen/projects/spotmycrib-master/server/cronjobs/functions.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"server/cronjobs/functions.js"}},"code":"/**\n * Created by srikanth681 on 29/02/16.\n */\nfunction cleanText(str) {\n  if (!str) return str;\n  str = str.toString().trim();\n  str = str.replace('http://blog.spotmycrib.com', 'http://www.spotmycrib.ie/blog');\n  str = str.replace('www.spotmycrib.com', 'www.spotmycrib.ie');\n  str = str.replace(/(^,)|(,$)/g, \"\"); //\",liger, unicorn, snipe,\" will remove first and last comma\n\n  return str;\n}\n\nfunction titleCase(str) {\n  if (!str) return;\n  return str.charAt(0).toUpperCase() + str.toLowerCase().substring(1);\n}\n\nfunction decodeHTMLEntities(text) {\n  var entities = [['amp', '&'], ['apos', '\\''], ['#x27', '\\''], ['#x2F', '/'], ['#39', '\\''], ['#47', '/'], ['lt', '<'], ['gt', '>'], ['nbsp', ' '], ['raquo', ''], ['quot', '\"']];\n  if (text) for (var i = 0, max = entities.length; i < max; ++i) text = text.replace(new RegExp('&' + entities[i][0] + ';', 'g'), entities[i][1]);\n  return text;\n}\n\nfunction stripHTML(str) {\n  return str.replace(/<\\/?[^>]+(>|$)/g, \"\");\n}\n\nfunction numDifferentiation(val) {\n  if (val >= 1000000000) val = (val / 1000000000).toFixed(2) + ' Billion';else if (val >= 1000000) val = (val / 1000000).toFixed(2) + ' Million';\n  return val.toString().replace(/\\B(?=(\\d{3})+(?!\\d))/g, \",\");\n}\n\nfunction onlyUnique(value, index, self) {\n  return self.indexOf(value) === index;\n}\n\nfunction chunkify(a, n, balanced) {\n  if (n < 2) return [a];\n  if (!Array.isArray(a)) return [];\n  var len = a.length,\n      out = [],\n      i = 0,\n      size;\n\n  if (len % n === 0) {\n    size = Math.floor(len / n);\n\n    while (i < len) {\n      out.push(a.slice(i, i += size));\n    }\n  } else if (balanced) {\n    while (i < len) {\n      size = Math.ceil((len - i) / n--);\n      out.push(a.slice(i, i += size));\n    }\n  } else {\n    n--;\n    size = Math.floor(len / n);\n    if (len % size === 0) size--;\n\n    while (i < size * n) {\n      out.push(a.slice(i, i += size));\n    }\n\n    out.push(a.slice(size * n));\n  }\n\n  return out;\n}\n\nfunction chunkifyObj(a, n, balanced) {\n  let ret = chunkify(a, n, balanced);\n\n  if (ret.length > 1) {\n    let newRet = [],\n        tmp; // New Format is\n    // [\n    //   {props: [prop1, prop2, prop3]},\n    //   {props: [prop1, prop2, prop3]}\n    // ]\n\n    for (let i = 0; i < ret.length; i++) {\n      console.log(ret[i]);\n      tmp = {};\n      tmp = {\n        props: ret[i]\n      };\n      newRet.push(tmp);\n    }\n\n    ret = newRet;\n  }\n\n  return ret;\n} // todo: \n// Create indexes for emailEnquiries and emailRequests\n\n\nvar emailProcessors = {\n  emailEnquiryReceived: function () {\n    /*\n    Assumptions and requirements\n    - There can be only emailRequest / user / property\n    - There can be multiple emailRequests / user but diff properties\n    - There should be only one email send for 1 user - by this method - with a max cut of of 4 props per email\n    - One email can contain props belonging to multiple agents - there is no agent specific grouping - to reduce the number of testing scenarios and the logic simple.\n    */\n    let list = Collections.EmailRequests.find({\n      isArchived: false,\n      requestType: \"emailEnquiryReceived\"\n    }, {\n      transform: function (data) {\n        data.property = Collections.Properties.findOne({\n          _id: data.propertyId\n        });\n        data.property.address.address = cleanText(data.property.address.address);\n        data.property.address.area = cleanText(data.property.address.area);\n        data.property.address.county = cleanText(data.property.address.county);\n        let altText = '';\n        data.property.sliderImages = [];\n\n        if (data.property.gallery) {\n          for (var i = 0; i < data.property.gallery.length; i++) {\n            altText = 'Photo ' + (i + 1) + ' of ' + titleCase(data.property.address.address);\n            if (data.property.address.area) altText += ', ' + titleCase(data.property.address.area);\n            if (data.property.address.county) altText += ', ' + titleCase(data.property.address.county);\n            data.property.sliderImages.push({\n              url: data.property.gallery[i].url,\n              altText: altText\n            });\n          }\n        }\n\n        data.property.desktopHideClassName = \"desktop_hide\";\n        if (data.property.sliderImages.length == 0) data.property.desktopHideClassName = \"\";\n        data.emailEnquiry = Collections.EmailEnquiries.findOne({\n          _id: data.emailEnquiryId\n        });\n        data.propertyImage = null;\n\n        if (data.property.gallery) {\n          if (data.property.gallery[0]) data.property.propertyImage = data.property.gallery[0];\n        }\n\n        data.property.bedsCount = data.property.bedrooms.length;\n        data.auction = Collections.Auctions.findOne({\n          _id: data.property.auctionId\n        });\n        if (data.auction) //// Added to handle recoreds with no actions, we can directly archive this records. \n          data.auction.rentFormated = numDifferentiation(data.auction.price); //ToDo: What if property is deactivated in the meanwhile and property.auctionId is empty, then this will throw an error.\n\n        if (data.property) data.agent = Meteor.users.findOne({\n          _id: data.property.createdByAgent\n        });else console.log('no property found for: ' + data.propertyId);\n        return data;\n      },\n      sort: {\n        createdAt: -1\n      }\n    }).fetch();\n    if (list.length == 0) return;\n    console.log('total requests found: ' + list.length);\n    if (!list.length) return true;\n    let userEmailList = [],\n        maxPropertiesPerEmail = 4,\n        i,\n        j,\n        k,\n        a,\n        req = {},\n        listOfInvalidReqsToArchive = [],\n        listOfReqsToArchive = [],\n        listOfReqsToArchiveTmp = [],\n        user = {},\n        emailReq = {},\n        tmp = {},\n        userFirstName = '',\n        agentName = '',\n        address = '',\n        subject = '',\n        globalConfig = Collections.Config.findOne();\n\n    for (i = 0; i < list.length; i++) {\n      req = list[i];\n      listOfReqsToArchiveTmp = [];\n\n      try {\n        if (!req.auction || !req.agent) {\n          //Auction not found. \n          console.log('Auction or Agent not found for propId: ' + req.property._id);\n          listOfInvalidReqsToArchive.push(req._id);\n          continue;\n        }\n\n        console.log('Auction found for propId: ' + req.property._id);\n\n        if (listOfReqsToArchive.indexOf(req._id) != -1) {\n          // already processed\n          //duplicate request ; this user already has a fully composed object in emailReqList;\n          continue;\n        } //Now compose a new object that has a list of all emailRequests by this user for all properties\n\n\n        emailReq.userEmail = req.userEmail;\n        emailReq.fullname = req.fullname;\n        emailReq.property = req.property;\n        emailReq.auction = req.auction;\n        emailReq.agent = req.agent; ///////Easiest way - but too many DB queries\n        // emailReq.emailRequests = Collections.EmailRequests.find({isArchived:false, status:\"new\",requestType: \"emailEnquiryReceived\", userEmail: req.userEmail},{sort:{createdAt:-1}}).fetch();\n        ///////Efficient way \n\n        emailReq.emailRequests = [];\n        emailReq.landlordNames = [];\n        emailReq.propertyKeys = [];\n        k = 0; //This represents the number of sub child props per email.\n\n        for (j = 0; j < list.length; j++) {\n          tmp = list[j];\n          if (k >= maxPropertiesPerEmail) break;\n\n          if (tmp.userEmail == emailReq.userEmail) {\n            //of same user, so add it to the list\n            if (k == 0) {\n              tmp.isFirstProperty = true;\n            } else tmp.isFirstProperty = false;\n\n            emailReq.emailRequests.push(tmp);\n            k++; // increment this only of child is added via - emailReq.emailRequests.push\n\n            listOfReqsToArchiveTmp.push(tmp._id);\n            emailReq.landlordNames.push(tmp.agent.profile.name);\n            emailReq.propertyKeys.push(tmp.auction.lettingAuctionCode);\n          } else {\n            continue;\n          }\n        } // emailReqList.push(emailReq);\n        /// END OF loop; now emailReqList is a processed version of \"list\" ; it has a list of users and sub list of all their emailRequests of type emailEnquiryReceived\n\n\n        if (!emailReq.emailRequests.length) {\n          // it should be at least 1\n          console.log('No sub requests found. completely ignore this user request'); //Code should never come here, its only kept as precaution\n\n          continue;\n        } ///////////////////////////MAIL CODE - \n\n\n        address = titleCase(emailReq.property.address.address);\n        if (emailReq.property.address.area) address += ', ' + titleCase(emailReq.property.address.area);\n        if (emailReq.property.address.county) address += ', ' + titleCase(emailReq.property.address.county);\n        subject = 'Your enquiry for ' + address;\n        a = emailReq.landlordNames;\n        a = a.filter(onlyUnique); //Only unique\n\n        agentNames = [a.slice(0, -1).join(', '), a.slice(-1)[0]].join(a.length < 2 ? '' : ' and ');\n        userFirstName = emailReq.fullname;\n\n        if (userFirstName) {\n          userFirstName = titleCase(userFirstName.split(' ')[0]);\n        }\n\n        user = {\n          \"profile\": {\n            name: emailReq.fullname,\n            email: emailReq.userEmail,\n            userFirstName: userFirstName\n          }\n        };\n        var mailData = {\n          template: 'emailEnquiryReceived',\n          subject: subject,\n          mailTo: emailReq.userEmail,\n          replyTo: emailReq.agent.profile.email,\n          //He just placed the application, don't reveal the email yet, agent needs to start the communication first.\n          //mailTo: 'srikanth681@gmail.com',\n          homepage: Meteor.absoluteUrl(),\n          firstProperty: emailReq.property,\n          firstAuction: emailReq.auction,\n          emailEnquiries: emailReq.emailRequests,\n          enquiryCount: emailReq.emailRequests.length,\n          isSingleEnquiry: emailReq.emailRequests.length > 1 ? false : true,\n          propertyKeys: emailReq.propertyKeys.join('-'),\n          // propertyUrl:FlowRouter.url('rent', { slug: emailReq.property.slug, key: emailReq.auction.lettingAuctionCode }),\n          user: user,\n          //Email requests only exists for users who doesn't exist in SMC. if the user exists, then a bid is placed.\n          agentNames: agentNames\n        };\n        Meteor.call('sendNotificationEmail', mailData, true);\n        listOfReqsToArchive = listOfReqsToArchive.concat(listOfReqsToArchiveTmp); //At the end because everything should be successful, i.e without going into cache block for it to be archived.\n      } catch (e) {\n        console.log('In catch of emailEnquiryReceived email processor');\n        console.log(e);\n      }\n    }\n\n    if (listOfReqsToArchive.length) {\n      Collections.EmailRequests.update({\n        _id: {\n          $in: listOfReqsToArchive\n        }\n      }, {\n        $set: {\n          isArchived: true,\n          status: \"completed\"\n        }\n      }, {\n        multi: true\n      });\n    }\n\n    console.log('total requests completed: ' + listOfReqsToArchive.length);\n\n    if (listOfInvalidReqsToArchive.length) {\n      Collections.EmailRequests.update({\n        _id: {\n          $in: listOfInvalidReqsToArchive\n        }\n      }, {\n        $set: {\n          isArchived: true,\n          status: \"invalid\"\n        }\n      }, {\n        multi: true\n      });\n      console.log('total invalid requests archived: ' + listOfInvalidReqsToArchive.length);\n    }\n  },\n  dailyPropAlerts: function () {\n    /*\n    Assumptions and requirements\n    - There should be only one email send for 1 user - by this method - with a max cut of of 20 props per email\n    - One email can contain props belonging to multiple agents - there is no agent specific grouping - to reduce the number of testing scenarios and the logic simple.\n    - There is County wise grouping to make it simple to navigate and scroll\n    */\n    let maxPropertiesPerEmail = 20,\n        today = new Date(),\n        yesterday = new Date();\n    today.setHours(11, 59, 59, 999);\n    yesterday.setDate(today.getDate() - 1);\n    yesterday.setHours(12, 0, 0, 0); // , \"createdAt\": { $lte: today, $gte: yesterday }\n\n    let list = Collections.Auctions.find({\n      isArchived: false\n    }, {\n      transform: function (data) {\n        data.property = Collections.Properties.findOne({\n          _id: data.propertyId\n        });\n        data.property.address.address = cleanText(data.property.address.address);\n        data.property.address.area = cleanText(data.property.address.area);\n        data.property.address.county = cleanText(data.property.address.county);\n        data.property.bedsCount = data.property.bedrooms.length;\n        data.rentFormated = numDifferentiation(data.property.rentMonthly); // data.user = Meteor.users.findOne({_id:data.userId});//this userId is same as the createdByAgent\n\n        if (data.property) data.agent = Meteor.users.findOne({\n          _id: data.property.createdByAgent\n        });else console.log('no property found for: ' + data.propertyId);\n        return data;\n      },\n      sort: {\n        createdAt: -1\n      },\n      limit: maxPropertiesPerEmail\n    }).fetch();\n    console.log('total requests found: ' + list.length); // if(!list.length) return true;\n\n    let i = 0,\n        j,\n        k,\n        req = {},\n        uniqueCounties = [],\n        tmp = {},\n        tmp2 = [],\n        propertyData = [],\n        propTitle,\n        propBedNBath; //, tmpPropData = {}\n    // {\n    //   userFirstName:\"Adam\",\n    //   counties : [\n    //             {\n    //               countyName: 'Dublin',\n    //               propLines: [\n    //                 {\n    //                   props : [\n    //                     {propTitle : \"\",propType:\"House\",propBedNBath:\"3 Beds, 2 Baths\",propRent:\"1,750\" },\n    //                     {propAddress},\n    //                     {propAddress},\n    //                   ]\n    //                 }\n    //               ]\n    //             }\n    //           ]\n    // }\n    // propertyData.userFirstName = '';\n    // propertyData.numOfProps=list.length;\n    // propertyData.counties = [];\n    /// Create a list of all unique counties\n\n    for (j = 0; j < list.length; j++) {\n      tmp = list[j].property.address.county;\n      if (uniqueCounties.indexOf(tmp) == -1) uniqueCounties.push(tmp); //push if its not already found.\n    } // propertyData.countiesList = uniqueCounties;\n    /// Create a list of all props group by county\n\n\n    tmp = '';\n\n    for (k = 0; k < uniqueCounties.length; k++) {\n      tmp = uniqueCounties[k];\n      tmp2 = [];\n\n      for (j = 0; j < list.length; j++) {\n        propTitle = '', bedsCount = 0;\n        if (list[j].property.address.county != tmp) continue;\n        propTitle = titleCase(list[j].property.address.address);\n        if (list[j].property.address.area) propTitle += ', ' + titleCase(list[j].property.address.area);\n        if (list[j].property.address.county) propTitle += ', ' + titleCase(list[j].property.address.county);\n        console.log(propTitle);\n        console.log(list[j].property.address.address);\n        console.log(list[j].property.address);\n        propBedNBath = [];\n        if (bedsCount) propBedNBath.push(bedsCount + ' Beds');\n        if (list[j].property.baths) propBedNBath.push(list[j].property.baths + ' Baths');\n        propBedNBath = propBedNBath.join(', ');\n        tmp2.push({\n          propTitle: propTitle,\n          propType: titleCase(list[j].property.type),\n          propBedNBath: propBedNBath,\n          propRent: list[j].rentFormated,\n          propLink: FlowRouter.url('rent', {\n            slug: list[j].property.slug,\n            key: list[j].lettingAuctionCode\n          })\n        });\n      }\n\n      propertyData.push({\n        countyName: tmp,\n        propLinesDesktop: chunkifyObj(tmp2, 3, true),\n        propLinesMobile: chunkifyObj(tmp2, 2, true)\n      }); // break;//Temporary measure\n    }\n\n    console.log('Showing final array');\n    console.log(propertyData); // return;\n    // END\n    /// Get list of all users who needs email and send them those\n    // TODO: \n    // remove the additional anchor tag on the template for propTitle \n    // Add campaign information to all links\n    // Use MailGun template instead of PropertyAlerts.html\n    // let user = {name: }\n    // userFirstName = user.name;\n    // if(userFirstName){\n    //   userFirstName = titleCase(userFirstName.split(' ')[0]);\n    // }\n\n    let countyGroupInfo = ''; // They are grouped into Dublin, Galway, Limrick, Cork and Others.\n\n    if (uniqueCounties.length > 4) countyGroupInfo = uniqueCounties.slice(0, 3).join(', ') + ' and others';\n    if (uniqueCounties.length >= 2 && uniqueCounties.length <= 4) countyGroupInfo = uniqueCounties.slice(0, -1).join(', ') + ' and ' + uniqueCounties.slice(-1); // No need for a logic if there is only 1 \n\n    countyGroupInfo = 'They are grouped into ' + countyGroupInfo + '.';\n    if (uniqueCounties.length <= 1) countyGroupInfo = '';\n    console.log(uniqueCounties);\n    console.log('They are grouped into ' + countyGroupInfo + '.');\n    var mailData = {\n      template: 'propertyalerts',\n      subject: 'Daily Property Alerts',\n      mailTo: 'srikanth681@gmail.com',\n      data: {\n        countyGroupInfo: countyGroupInfo,\n        propertyData: propertyData\n      },\n      \"X-Mailgun-Variables\": {}\n    };\n    console.log(\"Final maildata\");\n    console.log(mailData); // return;\n\n    Meteor.call('sendNotificationEmailWithTemplate', mailData); // console.log('total requests completed: '+listOfReqsToArchive.length)\n  },\n  reminderUploadReferences: function () {\n    /*\n    Assumptions and requirements\n    - There can be only emailRequest / user / property\n    - There can be multiple emailRequests / user but diff properties\n    - There should be only one email send for 1 user - by this method - with a max cut of of 4 props per email\n    - One email can contain props belonging to multiple agents - there is no agent specific grouping - to reduce the number of testing scenarios and the logic simple.\n    */\n    let today = new Date();\n    today.setHours(0, 0, 0, 0);\n    let list = Collections.EmailRequests.find({\n      isArchived: false,\n      requestType: \"reminderUploadReferences\",\n      \"createdAt\": {\n        $lte: today\n      }\n    }, {\n      transform: function (data) {\n        data.property = Collections.Properties.findOne({\n          _id: data.propertyId\n        });\n        data.property.address.address = cleanText(data.property.address.address);\n        data.property.address.area = cleanText(data.property.address.area);\n        data.property.address.county = cleanText(data.property.address.county);\n        data.auction = Collections.Auctions.findOne({\n          _id: data.property.auctionId\n        }); // data.auction.rentFormated = numDifferentiation(data.auction.price);\n\n        data.user = Meteor.users.findOne({\n          _id: data.userId\n        });\n        if (data.property) data.agent = Meteor.users.findOne({\n          _id: data.property.createdByAgent\n        });else console.log('no property found for: ' + data.propertyId);\n        return data;\n      },\n      sort: {\n        createdAt: -1\n      }\n    }).fetch();\n    if (list.length == 0) return;\n    console.log('total requests found: ' + list.length);\n    if (!list.length) return true;\n    let userEmailList = [],\n        maxPropertiesPerEmail = 50,\n        i,\n        j,\n        k,\n        a,\n        req = {},\n        listOfReqsToArchive = [],\n        listOfReqsToArchiveTmp = [],\n        user = {},\n        emailReq = {},\n        tmp = {},\n        userFirstName = '',\n        agentName = '',\n        address = '',\n        subject = '',\n        missingReferences = [],\n        globalConfig = Collections.Config.findOne();\n\n    for (i = 0; i < list.length; i++) {\n      req = list[i];\n      listOfReqsToArchiveTmp = [];\n\n      try {\n        if (listOfReqsToArchive.indexOf(req._id) != -1) {\n          // already processed\n          //duplicate request ; this user already has a fully composed object in emailReqList;\n          continue;\n        } //Now compose a new object that has a list of all emailRequests by this user for all properties\n\n\n        emailReq.user = req.user;\n        emailReq.property = req.property; // emailReq.auction = req.auction;\n\n        emailReq.agent = req.agent; ///////Easiest way - but too many DB queries\n        // emailReq.emailRequests = Collections.EmailRequests.find({isArchived:false, status:\"new\",requestType: \"reminderUploadReferences\", userEmail: req.userEmail},{sort:{createdAt:-1}}).fetch();\n        ///////Efficient way\n\n        emailReq.emailRequests = [];\n        k = 0; //This represents the number of sub child props per email.\n\n        for (j = 0; j < list.length; j++) {\n          tmp = list[j];\n          if (k >= maxPropertiesPerEmail) break;\n\n          if (tmp.user.email == emailReq.user.email) {\n            //of same user, so add it to the list\n            emailReq.emailRequests.push(tmp);\n            k++; // increment this only of child is added via - emailReq.emailRequests.push\n\n            listOfReqsToArchiveTmp.push(tmp._id);\n          } else {\n            continue;\n          }\n        } // emailReqList.push(emailReq);\n        /// END OF loop; now emailReqList is a processed version of \"list\" ; it has a list of users and sub list of all their emailRequests of type reminderUploadReferences\n\n\n        if (!emailReq.emailRequests.length) {\n          // it should be at least 1\n          console.log('No sub requests found. completely ignore this user request'); //Code should never come here, its only kept as precaution\n\n          continue;\n        } ///////////////////////////MAIL CODE -\n\n\n        address = titleCase(emailReq.property.address.address);\n        if (emailReq.property.address.area) address += ', ' + titleCase(emailReq.property.address.area);\n        if (emailReq.property.address.county) address += ', ' + titleCase(emailReq.property.address.county);\n        subject = 'Your enquiry for ' + address;\n        userFirstName = emailReq.user.name;\n\n        if (userFirstName) {\n          userFirstName = titleCase(userFirstName.split(' ')[0]);\n        }\n\n        missingReferences = [];\n        if (emailReq.user) if (emailReq.user.profile) if (emailReq.user.profile.references) {\n          // if (!user.profile.references.hasResume) refListArr.push(\"Resume\");//Why do you need it?\n          if (!emailReq.user.profile.references.hasLandlordRef) missingReferences.push(\"Landlord reference\");\n          if (!emailReq.user.profile.references.employerName) missingReferences.push(\"Employer name\");\n          if (!emailReq.user.profile.references.hasWorkRef) missingReferences.push(\"Work reference\");\n          if (!emailReq.user.profile.references.hasFinancialRef) missingReferences.push(\"Financial reference\");\n          if (!emailReq.user.profile.references.hasGovtID) missingReferences.push(\"Government ID\");\n          if (!emailReq.user.profile.references.hasPassport) missingReferences.push(\"Passport\");\n          if (!emailReq.user.profile.references.hasPPS) missingReferences.push(\"PPS\");\n\n          try {\n            if (emailReq.user.profile.references.hasResume && emailReq.user.profile.references.hasLandlordRef && emailReq.user.profile.references.hasGovtID && emailReq.user.profile.references.hasWorkRef) hasAllReqReferences = true;\n          } catch (e) {\n            console.log(e);\n          }\n        }\n        var mailData = {\n          template: 'reminderUploadReferences',\n          subject: subject,\n          mailTo: emailReq.user.email,\n          replyTo: emailReq.agent.profile.email,\n          //He just placed the application, don't reveal the email yet, agent needs to start the communication first.\n          //mailTo: 'srikanth681@gmail.com',\n          homepage: Meteor.absoluteUrl(),\n          firstPropAddress: address,\n          missingReferences: missingReferences,\n          bidCount: emailReq.emailRequests.length,\n          isSingleEnquiry: emailReq.emailRequests.length > 1 ? false : true,\n          propertyUrl: FlowRouter.url('rent', {\n            slug: emailReq.property.slug,\n            key: emailReq.auction.lettingAuctionCode\n          }),\n          user: emailReq.user //Email requests only exists for users who doesn't exist in SMC. if the user exists, then a bid is placed.\n\n        };\n        Meteor.call('sendNotificationEmail', mailData, true);\n        listOfReqsToArchive = listOfReqsToArchive.concat(listOfReqsToArchiveTmp); //At the end because everything should be successful, i.e without going into cache block for it to be archived.\n      } catch (e) {\n        console.log('In catch of reminderUploadReferences email processor');\n        console.log(e);\n      }\n    }\n\n    Collections.EmailRequests.update({\n      _id: {\n        $in: listOfReqsToArchive\n      }\n    }, {\n      $set: {\n        isArchived: true,\n        status: \"completed\"\n      }\n    }, {\n      multi: true\n    });\n    console.log('total requests completed: ' + listOfReqsToArchive.length);\n  }\n};\nmodule.exportDefault(emailProcessors);\n\nimportBlogs = function () {\n  let url = 'http://blog.spotmycrib.com/wp-json/wp/v2/posts?status=publish&orderby=modified&per_page=10'; // let url = 'https://public-api.wordpress.com/rest/v1.1/sites/spotmycribblog.wordpress.com/posts/?status=publish&orderby=modified&per_page=10';\n  // https://developer.wordpress.com/docs/api/1.1/get/sites/%24site/posts/\n\n  try {\n    result = Meteor.http.get(url);\n  } catch (c) {\n    console.log('Failed to fetch blogs. In cache.');\n    return;\n  }\n\n  let blog = {},\n      isUpdating = false,\n      insertedListLinks = [],\n      updatedListLink = [];\n  let newBlog = {},\n      newBlogRelated = {};\n  let fromDB = {},\n      date1 = 0,\n      date2 = 0,\n      insertNewCount = 0,\n      updateCount = 0,\n      tmp = '';\n\n  if (result.statusCode != 200) {\n    console.log('Failed to fetch blogs. Status code: ' + result.statusCode);\n    return;\n  }\n\n  result = JSON.parse(result.content);\n\n  for (let i = 0; i < result.length; i++) {\n    blog = result[i];\n    fromDB = {};\n    fromDB = Collections.Blogs.findOne({\n      wpId: blog.id\n    });\n\n    if (fromDB) {\n      //Blog exists in DB.\n      if (fromDB.isArchived) continue; //Skip this blog.\n\n      if (fromDB.modified == blog.modified) continue; //Skip this blog.\n      // else there is a mismatch ; overwrite the DB with imported blog.\n\n      updateCount++;\n      console.log('Updating blog: ' + blog.title.rendered);\n      isUpdating = true;\n    } else {\n      //Blog doesn'' exist ; insert new\n      insertNewCount++;\n      console.log('Inserting blog: ' + blog.title.rendered);\n    } //////////// LOGIC TO GATHER REQUIRED FIELDS START\n\n\n    let imgHTML = '',\n        srcImg = '',\n        content = cleanText(blog.content.rendered);\n\n    try {\n      tmp = content.split('src=\"');\n\n      if (tmp.length > 1) {\n        console.log('Image found');\n        srcImage = tmp[1].split('?resize=')[0];\n        imgHTML = '<img class=\"img-responsive\" src=\"' + srcImage + '\"/><p>';\n        tmp = content.split('/>')[1];\n        if (tmp) content = imgHTML + tmp;\n      }\n    } catch (e) {\n      console.log('Failed to extract image');\n      content = cleanText(blog.content.rendered); //Reset\n    }\n\n    newBlog['wpId'] = blog.id;\n    newBlog['created'] = blog.date;\n    newBlog['modified'] = blog.modified;\n    newBlog['slug'] = blog.slug;\n    newBlog['link'] = blog.link;\n    newBlog['title'] = cleanText(blog.title.rendered);\n    newBlog['metaTitle'] = stripHTML(decodeHTMLEntities(newBlog['title']));\n    newBlog['content'] = content;\n    newBlog['excerpt'] = cleanText(blog.excerpt.rendered);\n    let metaDesc = decodeHTMLEntities(newBlog['excerpt']);\n    metaDesc = stripHTML(metaDesc);\n    metaDesc = metaDesc.replace('Read More', '');\n    newBlog['metaDesc'] = metaDesc;\n    newBlog['sticky'] = blog.sticky;\n    newBlog['categories'] = blog.categories;\n    newBlog['image'] = blog.jetpack_featured_media_url;\n    newBlog['related'] = [];\n    newBlog['isArchived'] = false;\n\n    for (let j = 0; j < blog['jetpack-related-posts'].length; j++) {\n      newBlogRelated = {};\n      newBlogRelated['wpId'] = blog['jetpack-related-posts'][j].id;\n      newBlogRelated['link'] = blog['jetpack-related-posts'][j].url; // tmp = blog['jetpack-related-posts'][j].url.split('/');\n\n      newBlogRelated['slug'] = blog['jetpack-related-posts'][j].url.split('/')[3];\n      newBlogRelated['title'] = blog['jetpack-related-posts'][j].title;\n      newBlogRelated['date'] = blog['jetpack-related-posts'][j].date;\n      newBlogRelated['excerpt'] = cleanText(blog['jetpack-related-posts'][j].excerpt);\n      newBlogRelated['context'] = blog['jetpack-related-posts'][j].context;\n      newBlogRelated['image'] = blog['jetpack-related-posts'][j].img;\n      newBlog.related.push(newBlogRelated);\n    } //////////// LOGIC TO GATHER REQUIRED FIELDS END\n\n\n    if (isUpdating) {\n      Collections.Blogs.update({\n        _id: fromDB._id\n      }, newBlog);\n      updatedListLink.push('<a href=\"http://spotmycrib.ie/blog/' + newBlog.slug + '/\" >' + newBlog.title + '</a>');\n    } else {\n      Collections.Blogs.insert(newBlog);\n      insertedListLinks.push('<a href=\"http://spotmycrib.ie/blog/' + newBlog.slug + '/\" >' + newBlog.title + '</a>');\n    }\n  }\n\n  if (updateCount > 0 || insertNewCount > 0) {\n    var sub = 'Blogs Imported';\n    var desc = \"\\nInserted Count: \" + insertNewCount + \"<br/>\\nUpdated Count: \" + updateCount + \"<br/>\\nInserted List: \" + insertedListLinks.join('<br/>') + \"<br/>\\nUpdated List: \" + updatedListLink.join('<br/>') + \"<br/>\\n\";\n    Meteor.call('notifyAdmin', sub, desc);\n  } else {\n    console.log('No blogs inserted or updated. ');\n  }\n};\n\ndeactivateProps = function () {\n  let date2daysbefore = new Date(new Date().setDate(new Date().getDate() - 2));\n  let props = Collections.Properties.find({\n    'importData.url': {\n      $gt: ''\n    },\n    'auctionId': {\n      $gt: ''\n    },\n    //Only get props that have an active auction. \n    'importData.lastCheckedDate': {\n      $lt: date2daysbefore\n    }\n  }, // Query for Studio 3T { 'importData.lastCheckedDate':{$lt: ISODate(\"2019-04-07T11:49:11.546+0000\") }, 'importData.url':{$gt:''}, 'auctionId':{$gt:''} }\n  {\n    fields: {\n      importData: 1,\n      auctionId: 1\n    }\n  }).fetch();\n  let url = '',\n      updateCount = 0,\n      propsToDeactivate = [],\n      propsCheckedIds = [];\n  console.log('deactivateProps len: ' + props.length); // console.log(props.length);\n\n  for (let i = 0; i < props.length; i++) {\n    url = props[i].importData.url; // url = 'https://www.spotmycrib.com/';\n    //console.log('Working on: '+url)\n    // Meteor.http.FollowRedirects = false; // useless as its not working\n    // Meteor.http.followAllRedirects = false; // useless as its not working\n\n    const request = require('request');\n\n    try {\n      result = Meteor.http.get(url);\n    } catch (c) {\n      console.log('Failed to get prop url: ');\n      continue;\n    }\n\n    propsCheckedIds.push(props[i]._id); //if the url check on the above line worked then do this\n    //if(result.statusCode !=200 ){\n\n    if (result.content.indexOf('- Daft.ie</title>') != -1) {\n      //Only search page has a title ending with \"- Daft.ie</title>\"\n      console.log('prop to deactivate: ' + url);\n      propsToDeactivate.push(props[i]._id); //Meteor.call('deactivateAuction',props[i].auctionId)\n\n      updateCount++;\n    }\n  }\n\n  if (propsToDeactivate.length) Meteor.call('deactivateAuctionMulti', propsToDeactivate);\n  if (propsCheckedIds.length) Collections.Properties.update({\n    _id: {\n      $in: propsCheckedIds\n    }\n  }, {\n    $set: {\n      'importData.lastCheckedDate': new Date()\n    }\n  }, {\n    multi: true\n  });\n\n  if (updateCount == 0) {\n    console.log('No props deactivated. ');\n  }\n};\n/*\n// date1 = New Date(fromDB.modified)\n            // date2 = New Date(blog.modified)\n            // if(date1 > date2){\n            //     blog is updated\n            // }else\n{\n    \"id\": 275,\n    \"date\": \"2018-02-06T02:25:37\",\n    \"date_gmt\": \"2018-02-06T02:25:37\",\n    \"guid\": {\n      \"rendered\": \"http://blog.spotmycrib.com/?p=275\"\n    },\n    \"modified\": \"2018-11-24T13:16:30\",\n    \"modified_gmt\": \"2018-11-24T13:16:30\",\n    \"slug\": \"irish-renting-will-higher-result-tech-establishments-docklands\",\n    \"status\": \"publish\",\n    \"type\": \"post\",\n    \"link\": \"http://blog.spotmycrib.com/irish-renting-will-higher-result-tech-establishments-docklands/\",\n    \"title\": {\n      \"rendered\": \"Irish renting will be higher as a result of tech establishments in Docklands\"\n    },\n    \"content\": {\n      \"rendered\": \"<p><img data-attachment-id=\\\"276\\\" data-permalink=\\\"http://blog.spotmycrib.com/irish-renting-will-higher-result-tech-establishments-docklands/irish-renting/\\\" data-orig-file=\\\"https://i0.wp.com/blog.spotmycrib.com/wp-content/uploads/2018/02/irish-renting.jpeg?fit=622%2C350\\\" data-orig-size=\\\"622,350\\\" data-comments-opened=\\\"1\\\" data-image-meta=\\\"{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}\\\" data-image-title=\\\"irish renting\\\" data-image-description=\\\"&lt;p&gt;irish renting&lt;/p&gt;\\n\\\" data-medium-file=\\\"https://i0.wp.com/blog.spotmycrib.com/wp-content/uploads/2018/02/irish-renting.jpeg?fit=300%2C169\\\" data-large-file=\\\"https://i0.wp.com/blog.spotmycrib.com/wp-content/uploads/2018/02/irish-renting.jpeg?fit=622%2C350\\\" class=\\\"aligncenter size-full wp-image-276\\\" src=\\\"https://i0.wp.com/blog.spotmycrib.com/wp-content/uploads/2018/02/irish-renting.jpeg?resize=622%2C350\\\" alt=\\\"irish renting\\\" width=\\\"622\\\" height=\\\"350\\\" srcset=\\\"https://i0.wp.com/blog.spotmycrib.com/wp-content/uploads/2018/02/irish-renting.jpeg?w=622 622w, https://i0.wp.com/blog.spotmycrib.com/wp-content/uploads/2018/02/irish-renting.jpeg?resize=300%2C169 300w\\\" sizes=\\\"(max-width: 622px) 100vw, 622px\\\" data-recalc-dims=\\\"1\\\" /></p>\\n<p>Dockland is one of the vibrant places for enterprises in the city of Dublin. The place is known to be the home to most of tech workers who pay around €2,226 per month for a two bed room property. As compared to Irish renting, the rent in Silicon Docks is higher for its establishments. Where the average rent is €1,473 in Dublin, the average capped rent in this place is €1,988. Basically tech workers buy <a href=\\\"http://www.spotmycrib.com\\\">properties</a> in this place and the landlords are Irish. They prefer to buy two bed room apartments and for rent tech workers prefer to share this two bedroom property. Due to rising demand for the rental property, rent increased by 10.8 per cent in 2017. The dwellers in the Dock area are mostly Europeans. Where around 63 per cent are Europeans, 22 per cent are non-Europeans.</p>\\n<p>The rental sector and buying of houses in this area are mostly acquired by European and British nationals working with a number of international companies engaged in technical sector.  The estate agents report that 92 per cent of tenants are non- Irish tech workers. The Irish renting witnesses an increase due to the dwelling of non-Irish tech population. The engagement of tech professionals in <a href=\\\"http://www.spotmycrib.com\\\">large companies</a> such as Google, facebook, LinkedIn and Twitter is one of the reasons for rising the Irish renting. The tech professionals prefer living nearer to their office and they offer higher price for eliminating traveling.</p>\\n<p>The data from the Docklands Residential Report for the year 2018 says that the Irish renting has been decreasing and non-Irish tenants are increasing. Within three years, the population of Irish tenants has been diminished from 35 per cent to 15 per cent. This is another reason why the Irish renting is soaring in this area. Most of the tech workers are German, French, Spanish and Scandinavians. These people who have been working in the tech companies for more than five years have bought houses in this area. They prefer to buy two bed room houses in this area. So, the price of the two bed apartments has also increased from €355,000 to €400,000 in a year.</p>\\n<p>In Dublin 2, the price has increased by 12 per cent in 2017 where in Dublin 4, the price of properties has increased by 7 per cent. Dublin 4 is also mostly referred by the tech workers. More price hike is expected towards the end of 2018 due to the buying of houses in these areas. Again, Irish landlords are getting more interested to buy property in these areas due to higher return on investment. They will be getting higher rent in Dublin 2 and Dublin 4 regions. For getting a higher Irish renting, the landlords are purchasing houses in these regions.</p>\\n<p>One of the increasing Irish renting is the establishment of enterprises and coming of large companies. One cannot avoid establishing the larger establishments so the Irish renting. As far as the tech world will be active in the docklands, the Irish renting will be higher. Visit <a href=\\\"http://www.spotmycrib.com\\\">www.spotmycrib.com</a> and know more about Irish renting.</p>\\n<p>&nbsp;</p>\\n\",\n      \"protected\": false\n    },\n    \"excerpt\": {\n      \"rendered\": \"<p>Dockland is one of the vibrant places for enterprises in the city of Dublin. The place is known to be the home to most of tech workers who pay around €2,226 per month for a two bed room property. As compared to Irish renting, the rent in Silicon Docks is higher for its establishments. Where… <span class=\\\"read-more\\\"><a href=\\\"http://blog.spotmycrib.com/irish-renting-will-higher-result-tech-establishments-docklands/\\\">Read More &raquo;</a></span></p>\\n\",\n      \"protected\": false\n    },\n    \"author\": 2,\n    \"featured_media\": 276,\n    \"comment_status\": \"open\",\n    \"ping_status\": \"open\",\n    \"sticky\": false,\n    \"template\": \"\",\n    \"format\": \"standard\",\n    \"meta\": [],\n    \"categories\": [\n      1\n    ],\n    \"tags\": [],\n    \"jetpack_featured_media_url\": \"https://i0.wp.com/blog.spotmycrib.com/wp-content/uploads/2018/02/irish-renting.jpeg?fit=622%2C350\",\n    \"jetpack-related-posts\": [\n      {\n        \"id\": 243,\n        \"url\": \"http://blog.spotmycrib.com/price-property-rent-dublin-increase-25-percent-2018/\",\n        \"url_meta\": {\n          \"origin\": 275,\n          \"position\": 0\n        },\n        \"title\": \"The price of property to rent in Dublin is going to increase by 25 percent by the end of 2018\",\n        \"date\": \"January 26, 2018\",\n        \"format\": false,\n        \"excerpt\": \"According to The Irish Times, the rent is going to increase further in the year 2018.  While the government is planning to bring down the price of property to rent in Dublin, the assessment shows a different figure. The economic factors which are not under the control of government are…\",\n        \"rel\": \"nofollow\",\n        \"context\": \"In \\\"General\\\"\",\n        \"img\": {\n          \"src\": \"https://i2.wp.com/blog.spotmycrib.com/wp-content/uploads/2018/01/prioperty-to-rent-in-dublin.jpeg?fit=466%2C350&resize=350%2C200\",\n          \"width\": 350,\n          \"height\": 200\n        },\n        \"classes\": []\n      },\n      {\n        \"id\": 285,\n        \"url\": \"http://blog.spotmycrib.com/rental-cap-able-control-housing-market-crisis/\",\n        \"url_meta\": {\n          \"origin\": 275,\n          \"position\": 1\n        },\n        \"title\": \"Is Rental Cap Able to Control the Housing Market Crisis?\",\n        \"date\": \"February 19, 2018\",\n        \"format\": false,\n        \"excerpt\": \"Rental cap introduced by the Irish government is becoming an issue for the rental sector. The government issued the rental cap for capturing the price hike. The increasing rent of the properties in Dublin and cork region forced the government to set rental caps. The landlords were barred from increasing…\",\n        \"rel\": \"nofollow\",\n        \"context\": \"In \\\"General\\\"\",\n        \"img\": {\n          \"src\": \"https://i2.wp.com/blog.spotmycrib.com/wp-content/uploads/2018/02/rental-capp-in-rent-pressure-zone.jpeg?fit=523%2C350&resize=350%2C200\",\n          \"width\": 350,\n          \"height\": 200\n        },\n        \"classes\": []\n      },\n      {\n        \"id\": 174,\n        \"url\": \"http://blog.spotmycrib.com/building-more-houses-rent-dublin-affecting-rent/\",\n        \"url_meta\": {\n          \"origin\": 275,\n          \"position\": 2\n        },\n        \"title\": \"Is Building More Houses for rent in Dublin is affecting rent?\",\n        \"date\": \"January 2, 2018\",\n        \"format\": false,\n        \"excerpt\": \"Most of us may think that building more houses for rent in Dublin and nearby areas can mitigate the issues related to the housing crisis. It is impossible to predict that to what extent it can reduce the rental crisis. There has been a lot of discussion on this issue…\",\n        \"rel\": \"nofollow\",\n        \"context\": \"In \\\"General\\\"\",\n        \"img\": {\n          \"src\": \"https://i0.wp.com/blog.spotmycrib.com/wp-content/uploads/2018/01/rent-in-Dublin.jpeg?fit=525%2C350&resize=350%2C200\",\n          \"width\": 350,\n          \"height\": 200\n        },\n        \"classes\": []\n      }\n    ],\n    \"_links\": {\n      \"self\": [\n        {\n          \"href\": \"http://blog.spotmycrib.com/wp-json/wp/v2/posts/275\"\n        }\n      ],\n      \"collection\": [\n        {\n          \"href\": \"http://blog.spotmycrib.com/wp-json/wp/v2/posts\"\n        }\n      ],\n      \"about\": [\n        {\n          \"href\": \"http://blog.spotmycrib.com/wp-json/wp/v2/types/post\"\n        }\n      ],\n      \"author\": [\n        {\n          \"embeddable\": true,\n          \"href\": \"http://blog.spotmycrib.com/wp-json/wp/v2/users/2\"\n        }\n      ],\n      \"replies\": [\n        {\n          \"embeddable\": true,\n          \"href\": \"http://blog.spotmycrib.com/wp-json/wp/v2/comments?post=275\"\n        }\n      ],\n      \"version-history\": [\n        {\n          \"count\": 2,\n          \"href\": \"http://blog.spotmycrib.com/wp-json/wp/v2/posts/275/revisions\"\n        }\n      ],\n      \"predecessor-version\": [\n        {\n          \"id\": 308,\n          \"href\": \"http://blog.spotmycrib.com/wp-json/wp/v2/posts/275/revisions/308\"\n        }\n      ],\n      \"wp:featuredmedia\": [\n        {\n          \"embeddable\": true,\n          \"href\": \"http://blog.spotmycrib.com/wp-json/wp/v2/media/276\"\n        }\n      ],\n      \"wp:attachment\": [\n        {\n          \"href\": \"http://blog.spotmycrib.com/wp-json/wp/v2/media?parent=275\"\n        }\n      ],\n      \"wp:term\": [\n        {\n          \"taxonomy\": \"category\",\n          \"embeddable\": true,\n          \"href\": \"http://blog.spotmycrib.com/wp-json/wp/v2/categories?post=275\"\n        },\n        {\n          \"taxonomy\": \"post_tag\",\n          \"embeddable\": true,\n          \"href\": \"http://blog.spotmycrib.com/wp-json/wp/v2/tags?post=275\"\n        }\n      ],\n      \"curies\": [\n        {\n          \"name\": \"wp\",\n          \"href\": \"https://api.w.org/{rel}\",\n          \"templated\": true\n        }\n      ]\n    }\n  },\n\n\n\n\n\n\nsendAuctionWonMails = function(){\n  //To be executed at 12:00 am, mid night, once the day is closed.\n\n  today = new Date();\n  yesterday = new Date(today);\n  yesterday.setDate(today.getDate() - 1);\n  var start = yesterday\n  // start.setHours(0,0,0,0);\n  start = start.setHours(0,0,0,0);\n  start = new Date(start)\n  var end = yesterday\n  end.setHours(23,59,59,999);\n\n  // debugger;\n  // var AuctionDocuments = ReactionCore.Collections.Auctions.find({endDate:{$gte: start, $lte: end}},{\n  //   transform: function(doc){\n  //     if(doc.highestBid)\n  //       doc.highestBidUser = Meteor.users.findOne({_id:doc.highestBid});\n  //     if(doc.secondHighestBidUser)\n  //       doc.secondHighestBidUser = Meteor.users.findOne({_id:doc.secondHighestBid});\n  //\n  //     return doc;\n  //   }\n  // }).fetch();\n\n  var globalConfig = ReactionCore.Collections.Config.findOne();\n\n  //fetch list to whom highest bid email is to be send\n  var AuctionDocuments = ReactionCore.Collections.Auctions.find({\n      \"endDate\": {$lte: end},\n      $or      : [\n        {\"highestBid\": {$ne: \"\"}, \"isHighestBidWonEmailSent\": false},\n        {\"secondHighestBid\": {$ne: \"\"}, \"isSecondHighestBidWonEmailSent\": false}]\n    },\n    {\n    transform: function(doc){\n      if (doc.highestBid && !doc.isHighestBidWonEmailSent)\n        doc.highestBidUser = Meteor.users.findOne({_id:doc.highestBid});\n      if (doc.secondHighestBid && !doc.isSecondHighestBidWonEmailSent)\n        doc.secondHighestBidUser = Meteor.users.findOne({_id:doc.secondHighestBid});\n\n      return doc;\n    }\n  }).fetch();\n\n  for (var i = 0; i < AuctionDocuments.length; i++) {\n    var auction                   = AuctionDocuments[i]\n    var endDate = new Date(auction.endDate);\n    var firstHigestBidderEndDate = new Date(endDate.setDate(endDate.getDate() + 2));\n    var secondHigestBidderEndDate = new Date(endDate.setDate(endDate.getDate() + 4));\n\n    if (auction.highestBidUser && !auction.isHighestBidWonEmailSent) {\n      var mailDataHighestBidUser = {\n        template: 'userWonBid',\n        subject: \"Congratulation! You have placed the winning bid.\",\n        mailTo: auction.highestBidUser.emails[0].address,\n        //mailTo: 'srikanth681@gmail.com',\n        homepage: Meteor.absoluteUrl(),\n        auction: auction,\n        user:auction.highestBidUser,\n        endDate: endDate.toDateString(),\n        firstHigestBidderEndDate: firstHigestBidderEndDate.toDateString(),\n        secondHigestBidderEndDate: secondHigestBidderEndDate.toDateString(),\n        conf: globalConfig\n      }\n      Meteor.call('sendNotificationEmail',mailDataHighestBidUser)\n      var smsText = 'Hi ' + auction.highestBidUser.profile.username + '. Congratulations! You bid is the highest. Login to ibidmyhome.com and confirm your unit!';\n      Meteor.call('sendSMS',[auction.highestBidUser.profile.mobile[0], smsText]);\n\n      //update email sent flag\n      ReactionCore.Collections.Auctions.update({_id: auction._id},\n        {$set: {isHighestBidWonEmailSent: true}});\n    }\n    if (auction.secondHighestBidUser && !auction.isSecondHighestBidWonEmailSent) {\n      var mailDataSecondHighestBidUser = {\n        template: 'userAnnouncedAsSecondHigest',\n        subject: \"Congratulations! You have placed the 2nd highest bid.\",\n        mailTo: auction.secondHighestBidUser.emails[0].address,\n        //mailTo: 'srikanth681@gmail.com',\n        homepage: Meteor.absoluteUrl(),\n        auction: auction,\n        user:auction.secondHighestBidUser,\n        endDate: endDate.toDateString(),\n        firstHigestBidderEndDate: firstHigestBidderEndDate.toDateString(),\n        secondHigestBidderEndDate: secondHigestBidderEndDate.toDateString(),\n        conf: globalConfig\n      }\n      Meteor.call('sendNotificationEmail',mailDataSecondHighestBidUser)\n      var smsText = 'Hi '+auction.secondHighestBidUser.profile.username+'. You have placed the 2nd highest bid. You have a chance to buy it. Login to follow the post-auction procedure closely.';\n      Meteor.call('sendSMS',[auction.secondHighestBidUser.profile.mobile[0], smsText]);\n\n      //update email sent flag\n      ReactionCore.Collections.Auctions.update({_id: auction._id},\n        {$set: {isSecondHighestBidWonEmailSent: true}});\n    }\n  }\n\n  return true;\n}\nnotYetARegisteredBidder = function(){\n  var today = new Date()\n  var start = new Date(today.getYear() , today.getMonth() , today.getDate() , today.getHours() , today.getMinutes(), 0, 0);\n  var end = new Date(today.getYear() , today.getMonth() , today.getDate() , today.getHours() , today.getMinutes(), 59, 999);\n\n  // var data = Meteor.users.find({\n  //   \"profile.isRegisteredBidder\":false,\n  //   createdAt:{$gte: start, $lte: end}\n  // }).fetch();\n  var data = Meteor.users.find({\n    \"profile.hasSignedUpButNotPaidRegistrationAmount\": true,\n    \"profile.isRegistrationPaymentReminderSent\"      : false\n  }).fetch();\n\n  var globalConfig = ReactionCore.Collections.Config.findOne();\n\n  for(var i=0;i<data.length;i++) {\n    var user = data[i]\n\n    var mailData = {\n      template: 'notYetARegisteredBidder',\n      subject : \"Created account but not paid Rs 499\",\n      //mailTo: 'srikanth681@gmail.com',\n      mailTo  : user.emails[0].address,\n      homepage: Meteor.absoluteUrl(),\n      user    : user,\n      conf    : globalConfig\n    }\n    Meteor.call('sendNotificationEmail', mailData)\n    ///////////////////////////MAIL CODE END  - SMS CODE START ////\n\n    var smsText = 'Hi ' + user.profile.username + '. Now that you have signed in, select an apartment and proceed to bid by paying an auction amount of Rs.499';\n    Meteor.call('sendSMS', [user.profile.mobile[0], smsText]);\n\n    ///////////////////////////SMS END  - SMS CODE START ////\n\n    //update email remidner flags\n    Meteor.users.update({\"_id\": user._id}, {\n      $set: {\n        \"profile.isRegistrationPaymentReminderSent\": true\n      }\n    });\n  }\n}\nnotYetBidOnProperty = function(){\n  // debugger;\n  var auctionDocuments = ReactionCore.Collections.Auctions.find({\n      propertyConfirmationNotificationNeededForBidders: {$exists: true, $ne: []},\n    },\n    {\n      transform: function (doc) {\n        doc.userDocuments = Meteor.users.find({\n            _id: {$in: doc.propertyConfirmationNotificationNeededForBidders}\n          }\n        ).fetch();\n\n        return doc;\n      }\n    }).fetch();\n\n  var globalConfig = ReactionCore.Collections.Config.findOne();\n\n  //loop on all auctionDocuments\n  for (var i = 0; i < auctionDocuments.length; i++) {\n    //loop on all users in auctionDocuments.userDocuments\n    for (var j = 0; j < auctionDocuments[i].userDocuments.length; j++) {\n      var user = auctionDocuments[i].userDocuments[j];\n\n      var mailData = {\n        template: 'notYetBidOnProperty',\n        subject : \"We have observed that you are yet to place the bid on ibidmyhome.com.\",\n        //mailTo: 'srikanth681@gmail.com',\n        mailTo  : user.emails[0].address,\n        homepage: Meteor.absoluteUrl(),\n        user    : user,\n        conf    : globalConfig\n      }\n      Meteor.call('sendNotificationEmail', mailData)\n      ///////////////////////////MAIL CODE END  - SMS CODE START ////\n\n      var smsText = 'Hi ' + user.profile.username + '. You are now a registered bidder, but have not placed your bid. Avail the apartment by outbidding current highest bid.';\n      Meteor.call('sendSMS', [user.profile.mobile[0], smsText]);\n\n      ///////////////////////////SMS END  - SMS CODE START ////\n\n      //update email reminder flags\n      ReactionCore.Collections.Auctions.update({_id: auctionDocuments[i]._id},\n        {\n          $pull: {\n            propertyConfirmationNotificationNeededForBidders: user._id\n          }\n        });\n    }\n  }\n\n};\nprocessRefunds = function(){\n  //To be executed at 12:00 am, mid night, once the auction winner is diclared, auction is closed 5 days ago.\n  today = new Date();\n  yesterday = new Date($today);\n  yesterday.setDate(today.getDate() - 5);\n  var start = yesterday\n  start = start.setHours(0,0,0,0);\n  start = new Date(start)\n  var end = yesterday\n  end.setHours(23,59,59,999);\n\n  //isAuctionConfirmed: true\n  var data = ReactionCore.Collections.Auctions.find({endDate:{$gte: start, $lte: end}},{}).fetch();\n\n  for(var i=0;i<data.length;i++){\n    var auction = data[i]\n    var user;\n    for (var i=0;i<auction.registeredBidders.length;i++){\n      userId = auction.registeredBidders[i]\n\n      if(auction.highestBid == userId && !auction.highestBidWithdrawed){continue;}\n      if(auction.highestBidWithdrawed && auction.secondHighestBid){continue;}\n      //if(auction.auctionConfirmedUser  == userId ){continue;}\n\n      var payment = ReactionCore.Collections.Payments.findOne({_id:userId, auctionId:auction._id });\n      Meteor.call('requestRefund',[payment._id,'Bidder registration amount refunded as unit is confirmed to another user.'])\n    }\n\n\n    //var mailDataHighestBidUser = {\n    //  template: 'userWonBid',\n    //  subject: \"Congratulation! You have placed the winning bid.\",\n    //  mailTo: auction.highestBidUser.emails[0].address,\n    //  //mailTo: 'srikanth681@gmail.com',\n    //  homepage: Meteor.absoluteUrl(),\n    //  data: auction,\n    //  conf: globalConfig\n    //}\n    //var mailDataSecondHighestBidUser = {\n    //  template: 'userAnnouncedAsSecondHigest',\n    //  subject: \"Congratulations! You have placed the 2nd highest bid.\",\n    //  mailTo: auction.highestBidUser.emails[0].address,\n    //  //mailTo: 'srikanth681@gmail.com',\n    //  homepage: Meteor.absoluteUrl(),\n    //  data: auction,\n    //  conf: globalConfig\n    //}\n    //Meteor.call('sendNotificationEmail',mailDataHighestBidUser)\n    //Meteor.call('sendNotificationEmail',mailDataSecondHighestBidUser)\n\n  }\n\n  return true;\n}\n\n transform: function(doc){\n doc.registeredBidUsers = []\n if(doc.registeredBidders){\n for (var i=0;i<doc.registeredBidders.length;i++){\n if(doc.highestBid == doc.registeredBidders[i] && !doc.highestBidWithdrawed){continue;}\n if(doc.highestBidWithdrawed && doc.secondHighestBid){continue;}\n //if(doc.auctionConfirmedUser  == doc.registeredBidders[i] ){continue;}\n var user = Meteor.users.findOne({_id:doc.registeredBidders[i] });\n doc.registeredBidUsers.push(user);\n }\n }\n return doc;\n }\n\n\n\n var user;\n for (var i=0;i<auction.registeredBidUsers.length;i++){\n user = auction.registeredBidUsers[i]\n var payment = ReactionCore.Collections.Payments.findOne({_id:user._id, auctionId:auction._id });\n Meteor.call('requestRefund',[payment._id,'Bidder registration amount refunded as unit is confirmed to another user.'])\n }\n\n */\n\n\nfunction getUserProfileScore(user) {\n  let score = 0;\n\n  if (user.profile.mobile) {\n    score += 15;\n  }\n\n  if (!user.services) user.services = {};\n\n  if (user.services.facebook) {\n    score += 15;\n  } // if(user.services.google){score += 10;}\n\n\n  if (user.services.twitter) {\n    score += 10;\n  }\n\n  if (user.services.linkedin) {\n    score += 15;\n  }\n\n  if (user.profile.references.hasPassport) {\n    score += 10;\n  }\n\n  if (user.profile.references.employerName) {\n    score += 3;\n  }\n\n  if (user.profile.references.employerTakeHome) {\n    score += 2;\n  }\n\n  if (user.profile.references.hasWorkRef) {\n    score += 10;\n  }\n\n  if (user.profile.references.hasLandlordRef) {\n    score += 10;\n  }\n\n  if (user.profile.references.hasPPS) {\n    score += 3;\n  } // if(user.profile.references.hasFinancialRef){score += 0;}\n\n\n  if (user.profile.references.hasGovtID) {\n    score += 4;\n  }\n\n  if (user.profile.references.hasResume) {\n    score += 3;\n  }\n\n  if (score > 100) score = 100;\n  return score;\n}","map":{"version":3,"sources":["server/cronjobs/functions.js"],"names":["cleanText","str","toString","trim","replace","titleCase","charAt","toUpperCase","toLowerCase","substring","decodeHTMLEntities","text","entities","i","max","length","RegExp","stripHTML","numDifferentiation","val","toFixed","onlyUnique","value","index","self","indexOf","chunkify","a","n","balanced","Array","isArray","len","out","size","Math","floor","push","slice","ceil","chunkifyObj","ret","newRet","tmp","console","log","props","emailProcessors","emailEnquiryReceived","list","Collections","EmailRequests","find","isArchived","requestType","transform","data","property","Properties","findOne","_id","propertyId","address","area","county","altText","sliderImages","gallery","url","desktopHideClassName","emailEnquiry","EmailEnquiries","emailEnquiryId","propertyImage","bedsCount","bedrooms","auction","Auctions","auctionId","rentFormated","price","agent","Meteor","users","createdByAgent","sort","createdAt","fetch","userEmailList","maxPropertiesPerEmail","j","k","req","listOfInvalidReqsToArchive","listOfReqsToArchive","listOfReqsToArchiveTmp","user","emailReq","userFirstName","agentName","subject","globalConfig","Config","userEmail","fullname","emailRequests","landlordNames","propertyKeys","isFirstProperty","profile","name","lettingAuctionCode","filter","agentNames","join","split","email","mailData","template","mailTo","replyTo","homepage","absoluteUrl","firstProperty","firstAuction","emailEnquiries","enquiryCount","isSingleEnquiry","call","concat","e","update","$in","$set","status","multi","dailyPropAlerts","today","Date","yesterday","setHours","setDate","getDate","rentMonthly","limit","uniqueCounties","tmp2","propertyData","propTitle","propBedNBath","baths","propType","type","propRent","propLink","FlowRouter","slug","key","countyName","propLinesDesktop","propLinesMobile","countyGroupInfo","reminderUploadReferences","$lte","userId","missingReferences","references","hasLandlordRef","employerName","hasWorkRef","hasFinancialRef","hasGovtID","hasPassport","hasPPS","hasResume","hasAllReqReferences","firstPropAddress","bidCount","propertyUrl","module","exportDefault","importBlogs","result","http","get","c","blog","isUpdating","insertedListLinks","updatedListLink","newBlog","newBlogRelated","fromDB","date1","date2","insertNewCount","updateCount","statusCode","JSON","parse","content","Blogs","wpId","id","modified","title","rendered","imgHTML","srcImg","srcImage","date","link","excerpt","metaDesc","sticky","categories","jetpack_featured_media_url","context","img","related","insert","sub","desc","deactivateProps","date2daysbefore","$gt","$lt","fields","importData","propsToDeactivate","propsCheckedIds","request","require","getUserProfileScore","score","mobile","services","facebook","twitter","linkedin","employerTakeHome"],"mappings":"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mBAAvB,KAA6C,CAAC,CAAjD,EAAmD;AAAC;AAClDmB,MAAAA,OAAO,CAACC,GAAR,CAAY,yBAAuBuB,GAAnC;AACAiK,MAAAA,iBAAiB,CAAChM,IAAlB,CAAuBS,KAAK,CAACjC,CAAD,CAAL,CAAS+C,GAAhC,EAFiD,CAGjD;;AACAwI,MAAAA,WAAW;AACZ;AACF;;AACD,MAAGiC,iBAAiB,CAACtN,MAArB,EAA6BmE,MAAM,CAAC8C,IAAP,CAAY,wBAAZ,EAAqCqG,iBAArC;AAC7B,MAAGC,eAAe,CAACvN,MAAnB,EAA2BmC,WAAW,CAACQ,UAAZ,CAAuByE,MAAvB,CAA8B;AAACvE,IAAAA,GAAG,EAAC;AAACwE,MAAAA,GAAG,EAACkG;AAAL;AAAL,GAA9B,EAA0D;AAACjG,IAAAA,IAAI,EAAC;AAAC,oCAA6B,IAAIK,IAAJ;AAA9B;AAAN,GAA1D,EAA2G;AAACH,IAAAA,KAAK,EAAC;AAAP,GAA3G;;AAE3B,MAAG6D,WAAW,IAAE,CAAhB,EAAkB;AACdxJ,IAAAA,OAAO,CAACC,GAAR,CAAY,wBAAZ;AACH;AAEJ,CA1CD;AA2CA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AACA,SAAS4L,mBAAT,CAA8BzI,IAA9B,EAAoC;AAChC,MAAI0I,KAAK,GAAG,CAAZ;;AAEA,MAAG1I,IAAI,CAACa,OAAL,CAAa8H,MAAhB,EAAuB;AAACD,IAAAA,KAAK,IAAI,EAAT;AAAa;;AACrC,MAAG,CAAC1I,IAAI,CAAC4I,QAAT,EAAkB5I,IAAI,CAAC4I,QAAL,GAAc,EAAd;;AAClB,MAAG5I,IAAI,CAAC4I,QAAL,CAAcC,QAAjB,EAA0B;AAACH,IAAAA,KAAK,IAAI,EAAT;AAAa,GALR,CAMhC;;;AACA,MAAG1I,IAAI,CAAC4I,QAAL,CAAcE,OAAjB,EAAyB;AAACJ,IAAAA,KAAK,IAAI,EAAT;AAAa;;AACvC,MAAG1I,IAAI,CAAC4I,QAAL,CAAcG,QAAjB,EAA0B;AAACL,IAAAA,KAAK,IAAI,EAAT;AAAa;;AACxC,MAAG1I,IAAI,CAACa,OAAL,CAAayD,UAAb,CAAwBM,WAA3B,EAAuC;AAAC8D,IAAAA,KAAK,IAAI,EAAT;AAAa;;AACrD,MAAG1I,IAAI,CAACa,OAAL,CAAayD,UAAb,CAAwBE,YAA3B,EAAwC;AAACkE,IAAAA,KAAK,IAAI,CAAT;AAAY;;AACrD,MAAG1I,IAAI,CAACa,OAAL,CAAayD,UAAb,CAAwB0E,gBAA3B,EAA4C;AAACN,IAAAA,KAAK,IAAI,CAAT;AAAY;;AACzD,MAAG1I,IAAI,CAACa,OAAL,CAAayD,UAAb,CAAwBG,UAA3B,EAAsC;AAACiE,IAAAA,KAAK,IAAI,EAAT;AAAa;;AACpD,MAAG1I,IAAI,CAACa,OAAL,CAAayD,UAAb,CAAwBC,cAA3B,EAA0C;AAACmE,IAAAA,KAAK,IAAI,EAAT;AAAa;;AACxD,MAAG1I,IAAI,CAACa,OAAL,CAAayD,UAAb,CAAwBO,MAA3B,EAAkC;AAAC6D,IAAAA,KAAK,IAAI,CAAT;AAAY,GAdf,CAehC;;;AACA,MAAG1I,IAAI,CAACa,OAAL,CAAayD,UAAb,CAAwBK,SAA3B,EAAqC;AAAC+D,IAAAA,KAAK,IAAI,CAAT;AAAY;;AAClD,MAAG1I,IAAI,CAACa,OAAL,CAAayD,UAAb,CAAwBQ,SAA3B,EAAqC;AAAC4D,IAAAA,KAAK,IAAI,CAAT;AAAY;;AAElD,MAAGA,KAAK,GAAC,GAAT,EAAaA,KAAK,GAAG,GAAR;AACb,SAAOA,KAAP;AACH","sourcesContent":["/**\n * Created by srikanth681 on 29/02/16.\n */\nfunction cleanText(str){\n    if(!str)return str;\n    str = str.toString().trim();\n    str = str.replace('http://blog.spotmycrib.com','http://www.spotmycrib.ie/blog');\n    str = str.replace('www.spotmycrib.com','www.spotmycrib.ie');\n    str = str.replace(/(^,)|(,$)/g, \"\") //\",liger, unicorn, snipe,\" will remove first and last comma\n    return str\n}\nfunction titleCase(str) {\n  if(!str)return;\n  return str.charAt(0).toUpperCase() + str.toLowerCase().substring(1);\n}\nfunction decodeHTMLEntities(text) {\n    var entities = [\n        ['amp', '&'],\n        ['apos', '\\''],\n        ['#x27', '\\''],\n        ['#x2F', '/'],\n        ['#39', '\\''],\n        ['#47', '/'],\n        ['lt', '<'],\n        ['gt', '>'],\n        ['nbsp', ' '], ['raquo', ''],\n        ['quot', '\"']\n    ];\n\n    if(text)\n    for (var i = 0, max = entities.length; i < max; ++i)\n        text = text.replace(new RegExp('&'+entities[i][0]+';', 'g'), entities[i][1]);\n\n    return text;\n}\nfunction stripHTML(str){\n    return str.replace(/<\\/?[^>]+(>|$)/g, \"\");\n}\nfunction numDifferentiation(val) {\n    if(val >= 1000000000) val = (val/1000000000).toFixed(2) + ' Billion';\n    else if(val >= 1000000) val = (val/1000000).toFixed(2) + ' Million';\n    return val.toString().replace(/\\B(?=(\\d{3})+(?!\\d))/g, \",\");\n}\nfunction onlyUnique(value, index, self) {\n    return self.indexOf(value) === index;\n}\nfunction chunkify(a, n, balanced) {\n\n  if (n < 2)\n      return [a];\n\n  if(!Array.isArray(a))return [];\n\n  var len = a.length,\n      out = [],\n      i = 0,\n      size;\n\n  if (len % n === 0) {\n      size = Math.floor(len / n);\n      while (i < len) {\n          out.push(a.slice(i, i += size));\n      }\n  }\n\n  else if (balanced) {\n      while (i < len) {\n          size = Math.ceil((len - i) / n--);\n          out.push(a.slice(i, i += size));\n      }\n  }\n\n  else {\n\n      n--;\n      size = Math.floor(len / n);\n      if (len % size === 0)\n          size--;\n      while (i < size * n) {\n          out.push(a.slice(i, i += size));\n      }\n      out.push(a.slice(size * n));\n\n  }\n\n  return out;\n}\nfunction chunkifyObj(a, n, balanced){\n  let ret = chunkify(a, n, balanced);\n  if(ret.length > 1){\n    let newRet = [], tmp;\n    // New Format is\n    // [\n    //   {props: [prop1, prop2, prop3]},\n    //   {props: [prop1, prop2, prop3]}\n    // ]\n    for(let i=0;i<ret.length;i++){\n      console.log(ret[i]);\n      tmp = {};\n      tmp = {props: ret[i] };\n      newRet.push(tmp);\n    }\n    ret = newRet;\n  }\n  return ret;\n}\n// todo: \n// Create indexes for emailEnquiries and emailRequests\nvar emailProcessors = {\n  emailEnquiryReceived : function(){\n    /*\n    Assumptions and requirements\n    - There can be only emailRequest / user / property\n    - There can be multiple emailRequests / user but diff properties\n    - There should be only one email send for 1 user - by this method - with a max cut of of 4 props per email\n    - One email can contain props belonging to multiple agents - there is no agent specific grouping - to reduce the number of testing scenarios and the logic simple.\n    */\n    let list = Collections.EmailRequests.find({isArchived:false, requestType: \"emailEnquiryReceived\"},{\n      transform: function(data){\n        data.property = Collections.Properties.findOne({_id:data.propertyId});\n        data.property.address.address = cleanText(data.property.address.address)\n        data.property.address.area = cleanText(data.property.address.area)\n        data.property.address.county = cleanText(data.property.address.county)\n          let altText = '';\n          data.property.sliderImages = []\n          if(data.property.gallery){\n              for(var i=0;i<data.property.gallery.length;i++){\n                  altText = 'Photo '+(i+1)+' of '+titleCase(data.property.address.address)\n                  if (data.property.address.area) altText +=', '+titleCase(data.property.address.area)\n                  if (data.property.address.county) altText +=', '+titleCase(data.property.address.county)\n\n                  data.property.sliderImages.push({url:data.property.gallery[i].url,altText:altText})\n              }\n          }\n          data.property.desktopHideClassName = \"desktop_hide\";\n          if(data.property.sliderImages.length==0)data.property.desktopHideClassName = \"\";\n\n        data.emailEnquiry = Collections.EmailEnquiries.findOne({_id:data.emailEnquiryId});\n        data.propertyImage = null;\n        if(data.property.gallery){\n          if(data.property.gallery[0])data.property.propertyImage = data.property.gallery[0]\n        }\n\n        data.property.bedsCount = data.property.bedrooms.length;\n        data.auction = Collections.Auctions.findOne({_id:data.property.auctionId});\n        if(data.auction)//// Added to handle recoreds with no actions, we can directly archive this records. \n        data.auction.rentFormated = numDifferentiation(data.auction.price);\n        //ToDo: What if property is deactivated in the meanwhile and property.auctionId is empty, then this will throw an error.\n\n        if(data.property)\n            data.agent = Meteor.users.findOne({_id:data.property.createdByAgent});\n        else console.log('no property found for: '+data.propertyId)\n        return data;\n      },\n      sort:{createdAt:-1}\n    }).fetch();\n    if(list.length==0)return;\n    console.log('total requests found: '+list.length)\n    if(!list.length) return true;\n    let userEmailList = [], maxPropertiesPerEmail = 4, i, j, k, a, req = {}, listOfInvalidReqsToArchive = [], listOfReqsToArchive = [], listOfReqsToArchiveTmp = [], user={}, emailReq = {}, tmp = {}, userFirstName='', agentName ='', address='', subject = '', globalConfig = Collections.Config.findOne();\n    for(i=0;i<list.length;i++){\n      req = list[i];\n      listOfReqsToArchiveTmp = []\n      try{\n        if(!req.auction || !req.agent){\n          //Auction not found. \n          console.log('Auction or Agent not found for propId: '+req.property._id)\n          listOfInvalidReqsToArchive.push(req._id);\n          continue;\n        }\n        console.log('Auction found for propId: '+req.property._id)\n        if(listOfReqsToArchive.indexOf(req._id)!=-1){// already processed\n          //duplicate request ; this user already has a fully composed object in emailReqList;\n          continue;\n        }\n        //Now compose a new object that has a list of all emailRequests by this user for all properties\n        emailReq.userEmail = req.userEmail;\n        emailReq.fullname = req.fullname;\n        emailReq.property = req.property;\n        emailReq.auction = req.auction;\n        emailReq.agent = req.agent;\n        ///////Easiest way - but too many DB queries\n        // emailReq.emailRequests = Collections.EmailRequests.find({isArchived:false, status:\"new\",requestType: \"emailEnquiryReceived\", userEmail: req.userEmail},{sort:{createdAt:-1}}).fetch();\n        ///////Efficient way \n        emailReq.emailRequests = []\n        emailReq.landlordNames = []\n        emailReq.propertyKeys = []\n\n        k=0;//This represents the number of sub child props per email.\n        for(j=0;j<list.length;j++){\n          tmp = list[j];\n          if(k >= maxPropertiesPerEmail) break;\n          if(tmp.userEmail == emailReq.userEmail){//of same user, so add it to the list\n            if(k==0){tmp.isFirstProperty=true}else tmp.isFirstProperty=false\n            emailReq.emailRequests.push(tmp);\n            k++;// increment this only of child is added via - emailReq.emailRequests.push\n\n            listOfReqsToArchiveTmp.push(tmp._id);\n            emailReq.landlordNames.push(tmp.agent.profile.name)\n            emailReq.propertyKeys.push(tmp.auction.lettingAuctionCode)\n          }else{continue;}\n        }\n        // emailReqList.push(emailReq);\n        /// END OF loop; now emailReqList is a processed version of \"list\" ; it has a list of users and sub list of all their emailRequests of type emailEnquiryReceived\n        if(!emailReq.emailRequests.length) {// it should be at least 1\n          console.log('No sub requests found. completely ignore this user request');//Code should never come here, its only kept as precaution\n          continue;\n        }\n        ///////////////////////////MAIL CODE - \n        address = titleCase(emailReq.property.address.address);\n        if (emailReq.property.address.area) address +=', '+titleCase(emailReq.property.address.area)\n        if (emailReq.property.address.county) address +=', '+titleCase(emailReq.property.address.county)\n        subject = 'Your enquiry for '+address;\n        a = emailReq.landlordNames;\n        a = a.filter( onlyUnique );//Only unique\n        agentNames = [a.slice(0, -1).join(', '), a.slice(-1)[0]].join(a.length < 2 ? '' : ' and ')\n        userFirstName = emailReq.fullname;\n        if(userFirstName){\n          userFirstName = titleCase(userFirstName.split(' ')[0]);\n        }\n\n        user = {\n            \"profile\":{\n                name:emailReq.fullname,\n                email:emailReq.userEmail,\n                userFirstName:userFirstName\n            }\n        }\n        var mailData     = {\n            template    : 'emailEnquiryReceived',\n            subject     : subject,\n            mailTo      : emailReq.userEmail,\n            replyTo      : emailReq.agent.profile.email,//He just placed the application, don't reveal the email yet, agent needs to start the communication first.\n            //mailTo: 'srikanth681@gmail.com',\n            homepage    : Meteor.absoluteUrl(),\n            firstProperty: emailReq.property,\n            firstAuction: emailReq.auction,\n            emailEnquiries     : emailReq.emailRequests,\n            enquiryCount     : emailReq.emailRequests.length,\n            isSingleEnquiry     : emailReq.emailRequests.length > 1 ? false : true,\n            propertyKeys     : emailReq.propertyKeys.join('-'),\n            // propertyUrl:FlowRouter.url('rent', { slug: emailReq.property.slug, key: emailReq.auction.lettingAuctionCode }),\n            user        : user,//Email requests only exists for users who doesn't exist in SMC. if the user exists, then a bid is placed.\n            agentNames        : agentNames\n        };\n        Meteor.call('sendNotificationEmail', mailData,true);\n        listOfReqsToArchive = listOfReqsToArchive.concat(listOfReqsToArchiveTmp)//At the end because everything should be successful, i.e without going into cache block for it to be archived.\n      }catch(e){\n        console.log('In catch of emailEnquiryReceived email processor')\n        console.log(e);\n      }\n  }\n    if(listOfReqsToArchive.length){\n      Collections.EmailRequests.update({_id : {$in:listOfReqsToArchive} },{$set: {isArchived:true,status:\"completed\"} }, {multi:true});\n    }\n    console.log('total requests completed: '+listOfReqsToArchive.length)\n    if(listOfInvalidReqsToArchive.length){\n      Collections.EmailRequests.update({_id : {$in:listOfInvalidReqsToArchive} },{$set: {isArchived:true,status:\"invalid\"} }, {multi:true});\n      console.log('total invalid requests archived: '+listOfInvalidReqsToArchive.length)\n    }\n\n  },\n  dailyPropAlerts : function(){\n    /*\n    Assumptions and requirements\n    - There should be only one email send for 1 user - by this method - with a max cut of of 20 props per email\n    - One email can contain props belonging to multiple agents - there is no agent specific grouping - to reduce the number of testing scenarios and the logic simple.\n    - There is County wise grouping to make it simple to navigate and scroll\n    */\n    let maxPropertiesPerEmail = 20, today = new Date(), yesterday = new Date();\n    today.setHours(11,59,59,999);\n    yesterday.setDate(today.getDate() - 1);\n    yesterday.setHours(12,0,0,0);\n    // , \"createdAt\": { $lte: today, $gte: yesterday }\n    let list = Collections.Auctions.find({isArchived:false },{\n      transform: function(data){\n        data.property = Collections.Properties.findOne({_id:data.propertyId});\n        data.property.address.address = cleanText(data.property.address.address)\n        data.property.address.area = cleanText(data.property.address.area)\n        data.property.address.county = cleanText(data.property.address.county)\n        data.property.bedsCount = data.property.bedrooms.length;\n        data.rentFormated = numDifferentiation(data.property.rentMonthly);\n        // data.user = Meteor.users.findOne({_id:data.userId});//this userId is same as the createdByAgent\n\n        if(data.property)\n            data.agent = Meteor.users.findOne({_id:data.property.createdByAgent});\n        else console.log('no property found for: '+data.propertyId)\n        return data;\n      },\n      sort:{createdAt:-1},\n      limit:maxPropertiesPerEmail\n    }).fetch();\n    console.log('total requests found: '+list.length)\n    // if(!list.length) return true;\n\n    let i=0, j, k, req = {}, uniqueCounties = [],tmp = {}, tmp2=[], propertyData = [], propTitle, propBedNBath//, tmpPropData = {}\n    \n    // {\n    //   userFirstName:\"Adam\",\n    //   counties : [\n    //             {\n    //               countyName: 'Dublin',\n    //               propLines: [\n    //                 {\n    //                   props : [\n    //                     {propTitle : \"\",propType:\"House\",propBedNBath:\"3 Beds, 2 Baths\",propRent:\"1,750\" },\n    //                     {propAddress},\n    //                     {propAddress},\n    //                   ]\n    //                 }\n    //               ]\n    //             }\n    //           ]\n    // }\n    // propertyData.userFirstName = '';\n    // propertyData.numOfProps=list.length;\n    // propertyData.counties = [];\n\n    /// Create a list of all unique counties\n    for(j=0;j<list.length;j++){\n      tmp = list[j].property.address.county;\n      if(uniqueCounties.indexOf(tmp)== -1)uniqueCounties.push(tmp)//push if its not already found.\n    }\n    // propertyData.countiesList = uniqueCounties;\n    \n    /// Create a list of all props group by county\n    tmp = '';\n    for(k=0;k<uniqueCounties.length;k++){\n      tmp = uniqueCounties[k];\n      tmp2 = [];\n      for(j=0;j<list.length;j++){\n        propTitle = '',bedsCount=0;\n        if(list[j].property.address.county != tmp)continue;\n\n        propTitle = titleCase(list[j].property.address.address);\n        if (list[j].property.address.area) propTitle +=', '+titleCase(list[j].property.address.area)\n        if (list[j].property.address.county) propTitle +=', '+titleCase(list[j].property.address.county)\n        console.log(propTitle);\n        console.log(list[j].property.address.address);\n        console.log(list[j].property.address);\n        propBedNBath = []\n        if(bedsCount) propBedNBath.push(bedsCount+' Beds');\n        if(list[j].property.baths) propBedNBath.push(list[j].property.baths+' Baths');\n        propBedNBath = propBedNBath.join(', ')\n\n        tmp2.push( {\n          propTitle: propTitle,\n          propType: titleCase(list[j].property.type),\n          propBedNBath: propBedNBath,\n          propRent: list[j].rentFormated,\n          propLink: FlowRouter.url('rent', { slug: list[j].property.slug, key: list[j].lettingAuctionCode }),\n        });\n      }\n      propertyData.push({countyName: tmp, propLinesDesktop:chunkifyObj(tmp2,3,true), propLinesMobile:chunkifyObj(tmp2,2,true) })\n      // break;//Temporary measure\n    }\n    console.log('Showing final array')\n    console.log(propertyData);\n    // return;\n    // END\n\n    /// Get list of all users who needs email and send them those\n\n\n    // TODO: \n    // remove the additional anchor tag on the template for propTitle \n    // Add campaign information to all links\n    // Use MailGun template instead of PropertyAlerts.html\n\n    // let user = {name: }\n    // userFirstName = user.name;\n    // if(userFirstName){\n    //   userFirstName = titleCase(userFirstName.split(' ')[0]);\n    // }\n    let countyGroupInfo = '';\n    // They are grouped into Dublin, Galway, Limrick, Cork and Others.\n    if(uniqueCounties.length > 4) countyGroupInfo = uniqueCounties.slice(0, 3).join(', ')+' and others';\n    if(uniqueCounties.length >= 2 && uniqueCounties.length <= 4) countyGroupInfo = uniqueCounties.slice(0, -1).join(', ')+' and '+uniqueCounties.slice(-1);\n    // No need for a logic if there is only 1 \n    countyGroupInfo = 'They are grouped into '+countyGroupInfo+'.';\n    if(uniqueCounties.length <= 1)countyGroupInfo = '';\n    console.log(uniqueCounties)\n    console.log('They are grouped into '+countyGroupInfo+'.')\n\n    var mailData     = {\n      template    : 'propertyalerts',\n      subject     : 'Daily Property Alerts',\n      mailTo: 'srikanth681@gmail.com',\n      data:{\n        countyGroupInfo     : countyGroupInfo,\n        propertyData     : propertyData\n      },\n      \"X-Mailgun-Variables\" :{}\n    };\n    console.log(\"Final maildata\");\n    console.log(mailData);\n    // return;\n    Meteor.call('sendNotificationEmailWithTemplate', mailData);\n    \n\n\n    // console.log('total requests completed: '+listOfReqsToArchive.length)\n\n  },\n    reminderUploadReferences : function(){\n      /*\n      Assumptions and requirements\n      - There can be only emailRequest / user / property\n      - There can be multiple emailRequests / user but diff properties\n      - There should be only one email send for 1 user - by this method - with a max cut of of 4 props per email\n      - One email can contain props belonging to multiple agents - there is no agent specific grouping - to reduce the number of testing scenarios and the logic simple.\n      */\n      let today = new Date();\n          today.setHours(0,0,0,0);\n      let list = Collections.EmailRequests.find({isArchived:false, requestType: \"reminderUploadReferences\", \"createdAt\": { $lte: today } },{\n        transform: function(data){\n          data.property = Collections.Properties.findOne({_id:data.propertyId});\n          data.property.address.address = cleanText(data.property.address.address)\n          data.property.address.area = cleanText(data.property.address.area)\n          data.property.address.county = cleanText(data.property.address.county)\n          data.auction = Collections.Auctions.findOne({_id:data.property.auctionId});\n          // data.auction.rentFormated = numDifferentiation(data.auction.price);\n          data.user = Meteor.users.findOne({_id:data.userId});\n\n          if(data.property)\n              data.agent = Meteor.users.findOne({_id:data.property.createdByAgent});\n          else console.log('no property found for: '+data.propertyId)\n          return data;\n        },\n        sort:{createdAt:-1}\n      }).fetch();\n      if(list.length==0)return;\n      console.log('total requests found: '+list.length)\n      if(!list.length) return true;\n      let userEmailList = [], maxPropertiesPerEmail = 50, i, j, k, a, req = {}, listOfReqsToArchive = [], listOfReqsToArchiveTmp = [], user={}, emailReq = {}, tmp = {}, userFirstName='', agentName ='', address='', subject = '', missingReferences = [], globalConfig = Collections.Config.findOne();\n      for(i=0;i<list.length;i++){\n        req = list[i];\n        listOfReqsToArchiveTmp = []\n        try{\n\n          if(listOfReqsToArchive.indexOf(req._id)!=-1){// already processed\n            //duplicate request ; this user already has a fully composed object in emailReqList;\n            continue;\n          }\n          //Now compose a new object that has a list of all emailRequests by this user for all properties\n          emailReq.user = req.user;\n          emailReq.property = req.property;\n          // emailReq.auction = req.auction;\n          emailReq.agent = req.agent;\n          ///////Easiest way - but too many DB queries\n          // emailReq.emailRequests = Collections.EmailRequests.find({isArchived:false, status:\"new\",requestType: \"reminderUploadReferences\", userEmail: req.userEmail},{sort:{createdAt:-1}}).fetch();\n          ///////Efficient way\n          emailReq.emailRequests = []\n\n          k=0;//This represents the number of sub child props per email.\n          for(j=0;j<list.length;j++){\n            tmp = list[j];\n            if(k >= maxPropertiesPerEmail) break;\n            if(tmp.user.email == emailReq.user.email){//of same user, so add it to the list\n              emailReq.emailRequests.push(tmp);\n              k++;// increment this only of child is added via - emailReq.emailRequests.push\n\n              listOfReqsToArchiveTmp.push(tmp._id);\n            }else{continue;}\n          }\n          // emailReqList.push(emailReq);\n          /// END OF loop; now emailReqList is a processed version of \"list\" ; it has a list of users and sub list of all their emailRequests of type reminderUploadReferences\n          if(!emailReq.emailRequests.length) {// it should be at least 1\n            console.log('No sub requests found. completely ignore this user request');//Code should never come here, its only kept as precaution\n            continue;\n          }\n          ///////////////////////////MAIL CODE -\n          address = titleCase(emailReq.property.address.address);\n          if (emailReq.property.address.area) address +=', '+titleCase(emailReq.property.address.area)\n          if (emailReq.property.address.county) address +=', '+titleCase(emailReq.property.address.county)\n          subject = 'Your enquiry for '+address;\n\n          userFirstName = emailReq.user.name;\n          if(userFirstName){\n            userFirstName = titleCase(userFirstName.split(' ')[0]);\n          }\n\n          missingReferences = [];\n          if(emailReq.user)\n            if(emailReq.user.profile)\n                if(emailReq.user.profile.references) {\n                    // if (!user.profile.references.hasResume) refListArr.push(\"Resume\");//Why do you need it?\n                    if (!emailReq.user.profile.references.hasLandlordRef) missingReferences.push(\"Landlord reference\");\n                    if (!emailReq.user.profile.references.employerName) missingReferences.push(\"Employer name\");\n                    if (!emailReq.user.profile.references.hasWorkRef) missingReferences.push(\"Work reference\");\n                    if (!emailReq.user.profile.references.hasFinancialRef) missingReferences.push(\"Financial reference\");\n                    if (!emailReq.user.profile.references.hasGovtID) missingReferences.push(\"Government ID\");\n                    if (!emailReq.user.profile.references.hasPassport) missingReferences.push(\"Passport\");\n                    if (!emailReq.user.profile.references.hasPPS) missingReferences.push(\"PPS\");\n                    try{\n                        if(emailReq.user.profile.references.hasResume && emailReq.user.profile.references.hasLandlordRef && emailReq.user.profile.references.hasGovtID && emailReq.user.profile.references.hasWorkRef )hasAllReqReferences = true;\n                    }catch(e){console.log(e)}\n                }\n\n          var mailData     = {\n              template    : 'reminderUploadReferences',\n              subject     : subject,\n              mailTo      : emailReq.user.email,\n              replyTo      : emailReq.agent.profile.email,//He just placed the application, don't reveal the email yet, agent needs to start the communication first.\n              //mailTo: 'srikanth681@gmail.com',\n              homepage    : Meteor.absoluteUrl(),\n              firstPropAddress     : address,\n              missingReferences     : missingReferences,\n              bidCount     : emailReq.emailRequests.length,\n              isSingleEnquiry     : emailReq.emailRequests.length > 1 ? false : true,\n              propertyUrl:FlowRouter.url('rent', { slug: emailReq.property.slug, key: emailReq.auction.lettingAuctionCode }),\n              user        : emailReq.user,//Email requests only exists for users who doesn't exist in SMC. if the user exists, then a bid is placed.\n\n          };\n          Meteor.call('sendNotificationEmail', mailData,true);\n          listOfReqsToArchive = listOfReqsToArchive.concat(listOfReqsToArchiveTmp)//At the end because everything should be successful, i.e without going into cache block for it to be archived.\n        }catch(e){\n          console.log('In catch of reminderUploadReferences email processor')\n          console.log(e);\n        }\n      }\n      Collections.EmailRequests.update({_id : {$in:listOfReqsToArchive} },{$set: {isArchived:true,status:\"completed\"} }, {multi:true});\n      console.log('total requests completed: '+listOfReqsToArchive.length)\n\n    },\n}\nexport default emailProcessors;\n\nimportBlogs = function(){\n    let url = 'http://blog.spotmycrib.com/wp-json/wp/v2/posts?status=publish&orderby=modified&per_page=10';\n    // let url = 'https://public-api.wordpress.com/rest/v1.1/sites/spotmycribblog.wordpress.com/posts/?status=publish&orderby=modified&per_page=10';\n    // https://developer.wordpress.com/docs/api/1.1/get/sites/%24site/posts/\n    try{result = Meteor.http.get(url);}catch(c){\n        console.log('Failed to fetch blogs. In cache.'); return;\n    }\n    let blog = {}, isUpdating = false, insertedListLinks = [], updatedListLink = []\n    let newBlog = {}, newBlogRelated = {}\n    let fromDB = {}  , date1 =0 , date2 = 0, insertNewCount = 0, updateCount=0, tmp='';\n    if(result.statusCode !=200){console.log('Failed to fetch blogs. Status code: '+result.statusCode); return;}\n    result = JSON.parse(result.content);\n    for(let i=0;i<result.length;i++){\n        blog = result[i];\n        fromDB = {}\n        fromDB = Collections.Blogs.findOne({wpId:blog.id});\n        if(fromDB){//Blog exists in DB.\n            if(fromDB.isArchived) continue;//Skip this blog.\n            if(fromDB.modified == blog.modified) continue;//Skip this blog.\n            // else there is a mismatch ; overwrite the DB with imported blog.\n            updateCount++;\n            console.log('Updating blog: '+blog.title.rendered)\n            isUpdating = true;\n        }else{//Blog doesn'' exist ; insert new\n            insertNewCount++;\n            console.log('Inserting blog: '+blog.title.rendered)\n        }\n\n        //////////// LOGIC TO GATHER REQUIRED FIELDS START\n        let imgHTML = '', srcImg = '', content = cleanText(blog.content.rendered);\n\n        try {\n            tmp = content.split('src=\"')\n            if (tmp.length > 1) {\n                console.log('Image found');\n                srcImage = tmp[1].split('?resize=')[0];\n                imgHTML = '<img class=\"img-responsive\" src=\"' + srcImage + '\"/><p>';\n                tmp = content.split('/>')[1];\n                if(tmp)content = imgHTML + tmp;\n            }\n        }catch(e){\n            console.log('Failed to extract image');\n            content = cleanText(blog.content.rendered);//Reset\n        }\n\n        newBlog['wpId'] = blog.id;\n        newBlog['created'] = blog.date;\n        newBlog['modified'] = blog.modified;\n        newBlog['slug'] = blog.slug;\n        newBlog['link'] = blog.link;\n        newBlog['title'] = cleanText(blog.title.rendered);\n        newBlog['metaTitle'] = stripHTML(decodeHTMLEntities(newBlog['title']));\n        newBlog['content'] = content;\n        newBlog['excerpt'] = cleanText(blog.excerpt.rendered);\n\n        let metaDesc = decodeHTMLEntities(newBlog['excerpt']);\n        metaDesc = stripHTML(metaDesc);\n        metaDesc = metaDesc.replace('Read More','');\n\n        newBlog['metaDesc'] = metaDesc;\n        newBlog['sticky'] = blog.sticky;\n        newBlog['categories'] = blog.categories;\n        newBlog['image'] = blog.jetpack_featured_media_url;\n        newBlog['related'] = []\n        newBlog['isArchived'] = false\n\n        for(let j=0;j<blog['jetpack-related-posts'].length;j++){\n            newBlogRelated = {}\n            newBlogRelated['wpId'] = blog['jetpack-related-posts'][j].id;\n            newBlogRelated['link'] = blog['jetpack-related-posts'][j].url;\n            // tmp = blog['jetpack-related-posts'][j].url.split('/');\n            newBlogRelated['slug'] = blog['jetpack-related-posts'][j].url.split('/')[3];\n            newBlogRelated['title'] = blog['jetpack-related-posts'][j].title;\n            newBlogRelated['date'] = blog['jetpack-related-posts'][j].date;\n            newBlogRelated['excerpt'] = cleanText(blog['jetpack-related-posts'][j].excerpt);\n            newBlogRelated['context'] = blog['jetpack-related-posts'][j].context;\n            newBlogRelated['image'] = blog['jetpack-related-posts'][j].img;\n            newBlog.related.push(newBlogRelated)\n        }\n        //////////// LOGIC TO GATHER REQUIRED FIELDS END\n        if(isUpdating){\n            Collections.Blogs.update({_id:fromDB._id},newBlog);\n            updatedListLink.push('<a href=\"http://spotmycrib.ie/blog/'+newBlog.slug+'/\" >'+newBlog.title+'</a>')\n        }else{\n            Collections.Blogs.insert(newBlog);\n            insertedListLinks.push('<a href=\"http://spotmycrib.ie/blog/'+newBlog.slug+'/\" >'+newBlog.title+'</a>')\n        }\n\n\n    }\n\n    if(updateCount>0 || insertNewCount>0){\n        var sub = 'Blogs Imported'\n        var desc = `\nInserted Count: `+insertNewCount+`<br/>\nUpdated Count: `+updateCount+`<br/>\nInserted List: `+insertedListLinks.join('<br/>')+`<br/>\nUpdated List: `+updatedListLink.join('<br/>')+`<br/>\n`\n        Meteor.call('notifyAdmin', sub, desc);\n    }else{\n        console.log('No blogs inserted or updated. ');\n    }\n\n}\n\n\n\ndeactivateProps = function(){\n\n  let date2daysbefore = new Date(new Date().setDate(new Date().getDate()-2));\n  let props = Collections.Properties.find(\n      {\n        'importData.url':{$gt:''},\n        'auctionId':{$gt:''},//Only get props that have an active auction. \n        'importData.lastCheckedDate':{$lt:date2daysbefore}  \n      }, // Query for Studio 3T { 'importData.lastCheckedDate':{$lt: ISODate(\"2019-04-07T11:49:11.546+0000\") }, 'importData.url':{$gt:''}, 'auctionId':{$gt:''} }\n      {fields:{importData:1,auctionId:1} }   \n    ).fetch();\n    let url = '',updateCount=0,propsToDeactivate = [],propsCheckedIds = [];\n    \n    console.log('deactivateProps len: '+props.length)\n    // console.log(props.length);\n    for(let i=0;i<props.length;i++){\n      url = props[i].importData.url;\n      // url = 'https://www.spotmycrib.com/';\n      //console.log('Working on: '+url)\n      // Meteor.http.FollowRedirects = false; // useless as its not working\n      // Meteor.http.followAllRedirects = false; // useless as its not working\n      const request = require('request');\n\n      try{result = Meteor.http.get(url);}catch(c){\n        console.log('Failed to get prop url: '); continue;\n      }\n      propsCheckedIds.push(props[i]._id) //if the url check on the above line worked then do this\n      //if(result.statusCode !=200 ){\n      if(result.content.indexOf('- Daft.ie</title>')!=-1){//Only search page has a title ending with \"- Daft.ie</title>\"\n        console.log('prop to deactivate: '+url); \n        propsToDeactivate.push(props[i]._id)\n        //Meteor.call('deactivateAuction',props[i].auctionId)\n        updateCount++;\n      }\n    }\n    if(propsToDeactivate.length) Meteor.call('deactivateAuctionMulti',propsToDeactivate)\n    if(propsCheckedIds.length) Collections.Properties.update({_id:{$in:propsCheckedIds}},{$set:{'importData.lastCheckedDate':new Date()}},{multi:true})\n    \n    if(updateCount==0){\n        console.log('No props deactivated. ');\n    }\n\n}\n/*\n// date1 = New Date(fromDB.modified)\n            // date2 = New Date(blog.modified)\n            // if(date1 > date2){\n            //     blog is updated\n            // }else\n{\n    \"id\": 275,\n    \"date\": \"2018-02-06T02:25:37\",\n    \"date_gmt\": \"2018-02-06T02:25:37\",\n    \"guid\": {\n      \"rendered\": \"http://blog.spotmycrib.com/?p=275\"\n    },\n    \"modified\": \"2018-11-24T13:16:30\",\n    \"modified_gmt\": \"2018-11-24T13:16:30\",\n    \"slug\": \"irish-renting-will-higher-result-tech-establishments-docklands\",\n    \"status\": \"publish\",\n    \"type\": \"post\",\n    \"link\": \"http://blog.spotmycrib.com/irish-renting-will-higher-result-tech-establishments-docklands/\",\n    \"title\": {\n      \"rendered\": \"Irish renting will be higher as a result of tech establishments in Docklands\"\n    },\n    \"content\": {\n      \"rendered\": \"<p><img data-attachment-id=\\\"276\\\" data-permalink=\\\"http://blog.spotmycrib.com/irish-renting-will-higher-result-tech-establishments-docklands/irish-renting/\\\" data-orig-file=\\\"https://i0.wp.com/blog.spotmycrib.com/wp-content/uploads/2018/02/irish-renting.jpeg?fit=622%2C350\\\" data-orig-size=\\\"622,350\\\" data-comments-opened=\\\"1\\\" data-image-meta=\\\"{&quot;aperture&quot;:&quot;0&quot;,&quot;credit&quot;:&quot;&quot;,&quot;camera&quot;:&quot;&quot;,&quot;caption&quot;:&quot;&quot;,&quot;created_timestamp&quot;:&quot;0&quot;,&quot;copyright&quot;:&quot;&quot;,&quot;focal_length&quot;:&quot;0&quot;,&quot;iso&quot;:&quot;0&quot;,&quot;shutter_speed&quot;:&quot;0&quot;,&quot;title&quot;:&quot;&quot;,&quot;orientation&quot;:&quot;0&quot;}\\\" data-image-title=\\\"irish renting\\\" data-image-description=\\\"&lt;p&gt;irish renting&lt;/p&gt;\\n\\\" data-medium-file=\\\"https://i0.wp.com/blog.spotmycrib.com/wp-content/uploads/2018/02/irish-renting.jpeg?fit=300%2C169\\\" data-large-file=\\\"https://i0.wp.com/blog.spotmycrib.com/wp-content/uploads/2018/02/irish-renting.jpeg?fit=622%2C350\\\" class=\\\"aligncenter size-full wp-image-276\\\" src=\\\"https://i0.wp.com/blog.spotmycrib.com/wp-content/uploads/2018/02/irish-renting.jpeg?resize=622%2C350\\\" alt=\\\"irish renting\\\" width=\\\"622\\\" height=\\\"350\\\" srcset=\\\"https://i0.wp.com/blog.spotmycrib.com/wp-content/uploads/2018/02/irish-renting.jpeg?w=622 622w, https://i0.wp.com/blog.spotmycrib.com/wp-content/uploads/2018/02/irish-renting.jpeg?resize=300%2C169 300w\\\" sizes=\\\"(max-width: 622px) 100vw, 622px\\\" data-recalc-dims=\\\"1\\\" /></p>\\n<p>Dockland is one of the vibrant places for enterprises in the city of Dublin. The place is known to be the home to most of tech workers who pay around €2,226 per month for a two bed room property. As compared to Irish renting, the rent in Silicon Docks is higher for its establishments. Where the average rent is €1,473 in Dublin, the average capped rent in this place is €1,988. Basically tech workers buy <a href=\\\"http://www.spotmycrib.com\\\">properties</a> in this place and the landlords are Irish. They prefer to buy two bed room apartments and for rent tech workers prefer to share this two bedroom property. Due to rising demand for the rental property, rent increased by 10.8 per cent in 2017. The dwellers in the Dock area are mostly Europeans. Where around 63 per cent are Europeans, 22 per cent are non-Europeans.</p>\\n<p>The rental sector and buying of houses in this area are mostly acquired by European and British nationals working with a number of international companies engaged in technical sector.  The estate agents report that 92 per cent of tenants are non- Irish tech workers. The Irish renting witnesses an increase due to the dwelling of non-Irish tech population. The engagement of tech professionals in <a href=\\\"http://www.spotmycrib.com\\\">large companies</a> such as Google, facebook, LinkedIn and Twitter is one of the reasons for rising the Irish renting. The tech professionals prefer living nearer to their office and they offer higher price for eliminating traveling.</p>\\n<p>The data from the Docklands Residential Report for the year 2018 says that the Irish renting has been decreasing and non-Irish tenants are increasing. Within three years, the population of Irish tenants has been diminished from 35 per cent to 15 per cent. This is another reason why the Irish renting is soaring in this area. Most of the tech workers are German, French, Spanish and Scandinavians. These people who have been working in the tech companies for more than five years have bought houses in this area. They prefer to buy two bed room houses in this area. So, the price of the two bed apartments has also increased from €355,000 to €400,000 in a year.</p>\\n<p>In Dublin 2, the price has increased by 12 per cent in 2017 where in Dublin 4, the price of properties has increased by 7 per cent. Dublin 4 is also mostly referred by the tech workers. More price hike is expected towards the end of 2018 due to the buying of houses in these areas. Again, Irish landlords are getting more interested to buy property in these areas due to higher return on investment. They will be getting higher rent in Dublin 2 and Dublin 4 regions. For getting a higher Irish renting, the landlords are purchasing houses in these regions.</p>\\n<p>One of the increasing Irish renting is the establishment of enterprises and coming of large companies. One cannot avoid establishing the larger establishments so the Irish renting. As far as the tech world will be active in the docklands, the Irish renting will be higher. Visit <a href=\\\"http://www.spotmycrib.com\\\">www.spotmycrib.com</a> and know more about Irish renting.</p>\\n<p>&nbsp;</p>\\n\",\n      \"protected\": false\n    },\n    \"excerpt\": {\n      \"rendered\": \"<p>Dockland is one of the vibrant places for enterprises in the city of Dublin. The place is known to be the home to most of tech workers who pay around €2,226 per month for a two bed room property. As compared to Irish renting, the rent in Silicon Docks is higher for its establishments. Where… <span class=\\\"read-more\\\"><a href=\\\"http://blog.spotmycrib.com/irish-renting-will-higher-result-tech-establishments-docklands/\\\">Read More &raquo;</a></span></p>\\n\",\n      \"protected\": false\n    },\n    \"author\": 2,\n    \"featured_media\": 276,\n    \"comment_status\": \"open\",\n    \"ping_status\": \"open\",\n    \"sticky\": false,\n    \"template\": \"\",\n    \"format\": \"standard\",\n    \"meta\": [],\n    \"categories\": [\n      1\n    ],\n    \"tags\": [],\n    \"jetpack_featured_media_url\": \"https://i0.wp.com/blog.spotmycrib.com/wp-content/uploads/2018/02/irish-renting.jpeg?fit=622%2C350\",\n    \"jetpack-related-posts\": [\n      {\n        \"id\": 243,\n        \"url\": \"http://blog.spotmycrib.com/price-property-rent-dublin-increase-25-percent-2018/\",\n        \"url_meta\": {\n          \"origin\": 275,\n          \"position\": 0\n        },\n        \"title\": \"The price of property to rent in Dublin is going to increase by 25 percent by the end of 2018\",\n        \"date\": \"January 26, 2018\",\n        \"format\": false,\n        \"excerpt\": \"According to The Irish Times, the rent is going to increase further in the year 2018.  While the government is planning to bring down the price of property to rent in Dublin, the assessment shows a different figure. The economic factors which are not under the control of government are…\",\n        \"rel\": \"nofollow\",\n        \"context\": \"In \\\"General\\\"\",\n        \"img\": {\n          \"src\": \"https://i2.wp.com/blog.spotmycrib.com/wp-content/uploads/2018/01/prioperty-to-rent-in-dublin.jpeg?fit=466%2C350&resize=350%2C200\",\n          \"width\": 350,\n          \"height\": 200\n        },\n        \"classes\": []\n      },\n      {\n        \"id\": 285,\n        \"url\": \"http://blog.spotmycrib.com/rental-cap-able-control-housing-market-crisis/\",\n        \"url_meta\": {\n          \"origin\": 275,\n          \"position\": 1\n        },\n        \"title\": \"Is Rental Cap Able to Control the Housing Market Crisis?\",\n        \"date\": \"February 19, 2018\",\n        \"format\": false,\n        \"excerpt\": \"Rental cap introduced by the Irish government is becoming an issue for the rental sector. The government issued the rental cap for capturing the price hike. The increasing rent of the properties in Dublin and cork region forced the government to set rental caps. The landlords were barred from increasing…\",\n        \"rel\": \"nofollow\",\n        \"context\": \"In \\\"General\\\"\",\n        \"img\": {\n          \"src\": \"https://i2.wp.com/blog.spotmycrib.com/wp-content/uploads/2018/02/rental-capp-in-rent-pressure-zone.jpeg?fit=523%2C350&resize=350%2C200\",\n          \"width\": 350,\n          \"height\": 200\n        },\n        \"classes\": []\n      },\n      {\n        \"id\": 174,\n        \"url\": \"http://blog.spotmycrib.com/building-more-houses-rent-dublin-affecting-rent/\",\n        \"url_meta\": {\n          \"origin\": 275,\n          \"position\": 2\n        },\n        \"title\": \"Is Building More Houses for rent in Dublin is affecting rent?\",\n        \"date\": \"January 2, 2018\",\n        \"format\": false,\n        \"excerpt\": \"Most of us may think that building more houses for rent in Dublin and nearby areas can mitigate the issues related to the housing crisis. It is impossible to predict that to what extent it can reduce the rental crisis. There has been a lot of discussion on this issue…\",\n        \"rel\": \"nofollow\",\n        \"context\": \"In \\\"General\\\"\",\n        \"img\": {\n          \"src\": \"https://i0.wp.com/blog.spotmycrib.com/wp-content/uploads/2018/01/rent-in-Dublin.jpeg?fit=525%2C350&resize=350%2C200\",\n          \"width\": 350,\n          \"height\": 200\n        },\n        \"classes\": []\n      }\n    ],\n    \"_links\": {\n      \"self\": [\n        {\n          \"href\": \"http://blog.spotmycrib.com/wp-json/wp/v2/posts/275\"\n        }\n      ],\n      \"collection\": [\n        {\n          \"href\": \"http://blog.spotmycrib.com/wp-json/wp/v2/posts\"\n        }\n      ],\n      \"about\": [\n        {\n          \"href\": \"http://blog.spotmycrib.com/wp-json/wp/v2/types/post\"\n        }\n      ],\n      \"author\": [\n        {\n          \"embeddable\": true,\n          \"href\": \"http://blog.spotmycrib.com/wp-json/wp/v2/users/2\"\n        }\n      ],\n      \"replies\": [\n        {\n          \"embeddable\": true,\n          \"href\": \"http://blog.spotmycrib.com/wp-json/wp/v2/comments?post=275\"\n        }\n      ],\n      \"version-history\": [\n        {\n          \"count\": 2,\n          \"href\": \"http://blog.spotmycrib.com/wp-json/wp/v2/posts/275/revisions\"\n        }\n      ],\n      \"predecessor-version\": [\n        {\n          \"id\": 308,\n          \"href\": \"http://blog.spotmycrib.com/wp-json/wp/v2/posts/275/revisions/308\"\n        }\n      ],\n      \"wp:featuredmedia\": [\n        {\n          \"embeddable\": true,\n          \"href\": \"http://blog.spotmycrib.com/wp-json/wp/v2/media/276\"\n        }\n      ],\n      \"wp:attachment\": [\n        {\n          \"href\": \"http://blog.spotmycrib.com/wp-json/wp/v2/media?parent=275\"\n        }\n      ],\n      \"wp:term\": [\n        {\n          \"taxonomy\": \"category\",\n          \"embeddable\": true,\n          \"href\": \"http://blog.spotmycrib.com/wp-json/wp/v2/categories?post=275\"\n        },\n        {\n          \"taxonomy\": \"post_tag\",\n          \"embeddable\": true,\n          \"href\": \"http://blog.spotmycrib.com/wp-json/wp/v2/tags?post=275\"\n        }\n      ],\n      \"curies\": [\n        {\n          \"name\": \"wp\",\n          \"href\": \"https://api.w.org/{rel}\",\n          \"templated\": true\n        }\n      ]\n    }\n  },\n\n\n\n\n\n\nsendAuctionWonMails = function(){\n  //To be executed at 12:00 am, mid night, once the day is closed.\n\n  today = new Date();\n  yesterday = new Date(today);\n  yesterday.setDate(today.getDate() - 1);\n  var start = yesterday\n  // start.setHours(0,0,0,0);\n  start = start.setHours(0,0,0,0);\n  start = new Date(start)\n  var end = yesterday\n  end.setHours(23,59,59,999);\n\n  // debugger;\n  // var AuctionDocuments = ReactionCore.Collections.Auctions.find({endDate:{$gte: start, $lte: end}},{\n  //   transform: function(doc){\n  //     if(doc.highestBid)\n  //       doc.highestBidUser = Meteor.users.findOne({_id:doc.highestBid});\n  //     if(doc.secondHighestBidUser)\n  //       doc.secondHighestBidUser = Meteor.users.findOne({_id:doc.secondHighestBid});\n  //\n  //     return doc;\n  //   }\n  // }).fetch();\n\n  var globalConfig = ReactionCore.Collections.Config.findOne();\n\n  //fetch list to whom highest bid email is to be send\n  var AuctionDocuments = ReactionCore.Collections.Auctions.find({\n      \"endDate\": {$lte: end},\n      $or      : [\n        {\"highestBid\": {$ne: \"\"}, \"isHighestBidWonEmailSent\": false},\n        {\"secondHighestBid\": {$ne: \"\"}, \"isSecondHighestBidWonEmailSent\": false}]\n    },\n    {\n    transform: function(doc){\n      if (doc.highestBid && !doc.isHighestBidWonEmailSent)\n        doc.highestBidUser = Meteor.users.findOne({_id:doc.highestBid});\n      if (doc.secondHighestBid && !doc.isSecondHighestBidWonEmailSent)\n        doc.secondHighestBidUser = Meteor.users.findOne({_id:doc.secondHighestBid});\n\n      return doc;\n    }\n  }).fetch();\n\n  for (var i = 0; i < AuctionDocuments.length; i++) {\n    var auction                   = AuctionDocuments[i]\n    var endDate = new Date(auction.endDate);\n    var firstHigestBidderEndDate = new Date(endDate.setDate(endDate.getDate() + 2));\n    var secondHigestBidderEndDate = new Date(endDate.setDate(endDate.getDate() + 4));\n\n    if (auction.highestBidUser && !auction.isHighestBidWonEmailSent) {\n      var mailDataHighestBidUser = {\n        template: 'userWonBid',\n        subject: \"Congratulation! You have placed the winning bid.\",\n        mailTo: auction.highestBidUser.emails[0].address,\n        //mailTo: 'srikanth681@gmail.com',\n        homepage: Meteor.absoluteUrl(),\n        auction: auction,\n        user:auction.highestBidUser,\n        endDate: endDate.toDateString(),\n        firstHigestBidderEndDate: firstHigestBidderEndDate.toDateString(),\n        secondHigestBidderEndDate: secondHigestBidderEndDate.toDateString(),\n        conf: globalConfig\n      }\n      Meteor.call('sendNotificationEmail',mailDataHighestBidUser)\n      var smsText = 'Hi ' + auction.highestBidUser.profile.username + '. Congratulations! You bid is the highest. Login to ibidmyhome.com and confirm your unit!';\n      Meteor.call('sendSMS',[auction.highestBidUser.profile.mobile[0], smsText]);\n\n      //update email sent flag\n      ReactionCore.Collections.Auctions.update({_id: auction._id},\n        {$set: {isHighestBidWonEmailSent: true}});\n    }\n    if (auction.secondHighestBidUser && !auction.isSecondHighestBidWonEmailSent) {\n      var mailDataSecondHighestBidUser = {\n        template: 'userAnnouncedAsSecondHigest',\n        subject: \"Congratulations! You have placed the 2nd highest bid.\",\n        mailTo: auction.secondHighestBidUser.emails[0].address,\n        //mailTo: 'srikanth681@gmail.com',\n        homepage: Meteor.absoluteUrl(),\n        auction: auction,\n        user:auction.secondHighestBidUser,\n        endDate: endDate.toDateString(),\n        firstHigestBidderEndDate: firstHigestBidderEndDate.toDateString(),\n        secondHigestBidderEndDate: secondHigestBidderEndDate.toDateString(),\n        conf: globalConfig\n      }\n      Meteor.call('sendNotificationEmail',mailDataSecondHighestBidUser)\n      var smsText = 'Hi '+auction.secondHighestBidUser.profile.username+'. You have placed the 2nd highest bid. You have a chance to buy it. Login to follow the post-auction procedure closely.';\n      Meteor.call('sendSMS',[auction.secondHighestBidUser.profile.mobile[0], smsText]);\n\n      //update email sent flag\n      ReactionCore.Collections.Auctions.update({_id: auction._id},\n        {$set: {isSecondHighestBidWonEmailSent: true}});\n    }\n  }\n\n  return true;\n}\nnotYetARegisteredBidder = function(){\n  var today = new Date()\n  var start = new Date(today.getYear() , today.getMonth() , today.getDate() , today.getHours() , today.getMinutes(), 0, 0);\n  var end = new Date(today.getYear() , today.getMonth() , today.getDate() , today.getHours() , today.getMinutes(), 59, 999);\n\n  // var data = Meteor.users.find({\n  //   \"profile.isRegisteredBidder\":false,\n  //   createdAt:{$gte: start, $lte: end}\n  // }).fetch();\n  var data = Meteor.users.find({\n    \"profile.hasSignedUpButNotPaidRegistrationAmount\": true,\n    \"profile.isRegistrationPaymentReminderSent\"      : false\n  }).fetch();\n\n  var globalConfig = ReactionCore.Collections.Config.findOne();\n\n  for(var i=0;i<data.length;i++) {\n    var user = data[i]\n\n    var mailData = {\n      template: 'notYetARegisteredBidder',\n      subject : \"Created account but not paid Rs 499\",\n      //mailTo: 'srikanth681@gmail.com',\n      mailTo  : user.emails[0].address,\n      homepage: Meteor.absoluteUrl(),\n      user    : user,\n      conf    : globalConfig\n    }\n    Meteor.call('sendNotificationEmail', mailData)\n    ///////////////////////////MAIL CODE END  - SMS CODE START ////\n\n    var smsText = 'Hi ' + user.profile.username + '. Now that you have signed in, select an apartment and proceed to bid by paying an auction amount of Rs.499';\n    Meteor.call('sendSMS', [user.profile.mobile[0], smsText]);\n\n    ///////////////////////////SMS END  - SMS CODE START ////\n\n    //update email remidner flags\n    Meteor.users.update({\"_id\": user._id}, {\n      $set: {\n        \"profile.isRegistrationPaymentReminderSent\": true\n      }\n    });\n  }\n}\nnotYetBidOnProperty = function(){\n  // debugger;\n  var auctionDocuments = ReactionCore.Collections.Auctions.find({\n      propertyConfirmationNotificationNeededForBidders: {$exists: true, $ne: []},\n    },\n    {\n      transform: function (doc) {\n        doc.userDocuments = Meteor.users.find({\n            _id: {$in: doc.propertyConfirmationNotificationNeededForBidders}\n          }\n        ).fetch();\n\n        return doc;\n      }\n    }).fetch();\n\n  var globalConfig = ReactionCore.Collections.Config.findOne();\n\n  //loop on all auctionDocuments\n  for (var i = 0; i < auctionDocuments.length; i++) {\n    //loop on all users in auctionDocuments.userDocuments\n    for (var j = 0; j < auctionDocuments[i].userDocuments.length; j++) {\n      var user = auctionDocuments[i].userDocuments[j];\n\n      var mailData = {\n        template: 'notYetBidOnProperty',\n        subject : \"We have observed that you are yet to place the bid on ibidmyhome.com.\",\n        //mailTo: 'srikanth681@gmail.com',\n        mailTo  : user.emails[0].address,\n        homepage: Meteor.absoluteUrl(),\n        user    : user,\n        conf    : globalConfig\n      }\n      Meteor.call('sendNotificationEmail', mailData)\n      ///////////////////////////MAIL CODE END  - SMS CODE START ////\n\n      var smsText = 'Hi ' + user.profile.username + '. You are now a registered bidder, but have not placed your bid. Avail the apartment by outbidding current highest bid.';\n      Meteor.call('sendSMS', [user.profile.mobile[0], smsText]);\n\n      ///////////////////////////SMS END  - SMS CODE START ////\n\n      //update email reminder flags\n      ReactionCore.Collections.Auctions.update({_id: auctionDocuments[i]._id},\n        {\n          $pull: {\n            propertyConfirmationNotificationNeededForBidders: user._id\n          }\n        });\n    }\n  }\n\n};\nprocessRefunds = function(){\n  //To be executed at 12:00 am, mid night, once the auction winner is diclared, auction is closed 5 days ago.\n  today = new Date();\n  yesterday = new Date($today);\n  yesterday.setDate(today.getDate() - 5);\n  var start = yesterday\n  start = start.setHours(0,0,0,0);\n  start = new Date(start)\n  var end = yesterday\n  end.setHours(23,59,59,999);\n\n  //isAuctionConfirmed: true\n  var data = ReactionCore.Collections.Auctions.find({endDate:{$gte: start, $lte: end}},{}).fetch();\n\n  for(var i=0;i<data.length;i++){\n    var auction = data[i]\n    var user;\n    for (var i=0;i<auction.registeredBidders.length;i++){\n      userId = auction.registeredBidders[i]\n\n      if(auction.highestBid == userId && !auction.highestBidWithdrawed){continue;}\n      if(auction.highestBidWithdrawed && auction.secondHighestBid){continue;}\n      //if(auction.auctionConfirmedUser  == userId ){continue;}\n\n      var payment = ReactionCore.Collections.Payments.findOne({_id:userId, auctionId:auction._id });\n      Meteor.call('requestRefund',[payment._id,'Bidder registration amount refunded as unit is confirmed to another user.'])\n    }\n\n\n    //var mailDataHighestBidUser = {\n    //  template: 'userWonBid',\n    //  subject: \"Congratulation! You have placed the winning bid.\",\n    //  mailTo: auction.highestBidUser.emails[0].address,\n    //  //mailTo: 'srikanth681@gmail.com',\n    //  homepage: Meteor.absoluteUrl(),\n    //  data: auction,\n    //  conf: globalConfig\n    //}\n    //var mailDataSecondHighestBidUser = {\n    //  template: 'userAnnouncedAsSecondHigest',\n    //  subject: \"Congratulations! You have placed the 2nd highest bid.\",\n    //  mailTo: auction.highestBidUser.emails[0].address,\n    //  //mailTo: 'srikanth681@gmail.com',\n    //  homepage: Meteor.absoluteUrl(),\n    //  data: auction,\n    //  conf: globalConfig\n    //}\n    //Meteor.call('sendNotificationEmail',mailDataHighestBidUser)\n    //Meteor.call('sendNotificationEmail',mailDataSecondHighestBidUser)\n\n  }\n\n  return true;\n}\n\n transform: function(doc){\n doc.registeredBidUsers = []\n if(doc.registeredBidders){\n for (var i=0;i<doc.registeredBidders.length;i++){\n if(doc.highestBid == doc.registeredBidders[i] && !doc.highestBidWithdrawed){continue;}\n if(doc.highestBidWithdrawed && doc.secondHighestBid){continue;}\n //if(doc.auctionConfirmedUser  == doc.registeredBidders[i] ){continue;}\n var user = Meteor.users.findOne({_id:doc.registeredBidders[i] });\n doc.registeredBidUsers.push(user);\n }\n }\n return doc;\n }\n\n\n\n var user;\n for (var i=0;i<auction.registeredBidUsers.length;i++){\n user = auction.registeredBidUsers[i]\n var payment = ReactionCore.Collections.Payments.findOne({_id:user._id, auctionId:auction._id });\n Meteor.call('requestRefund',[payment._id,'Bidder registration amount refunded as unit is confirmed to another user.'])\n }\n\n */\nfunction getUserProfileScore (user) {\n    let score = 0;\n\n    if(user.profile.mobile){score += 15;}\n    if(!user.services)user.services={}\n    if(user.services.facebook){score += 15;}\n    // if(user.services.google){score += 10;}\n    if(user.services.twitter){score += 10;}\n    if(user.services.linkedin){score += 15;}\n    if(user.profile.references.hasPassport){score += 10;}\n    if(user.profile.references.employerName){score += 3;}\n    if(user.profile.references.employerTakeHome){score += 2;}\n    if(user.profile.references.hasWorkRef){score += 10;}\n    if(user.profile.references.hasLandlordRef){score += 10;}\n    if(user.profile.references.hasPPS){score += 3;}\n    // if(user.profile.references.hasFinancialRef){score += 0;}\n    if(user.profile.references.hasGovtID){score += 4;}\n    if(user.profile.references.hasResume){score += 3;}\n\n    if(score>100)score = 100;\n    return score;\n}"]},"sourceType":"module","hash":"ac916156eb09d5610b575e6f5ce5ba0b9a0c29ea"}
