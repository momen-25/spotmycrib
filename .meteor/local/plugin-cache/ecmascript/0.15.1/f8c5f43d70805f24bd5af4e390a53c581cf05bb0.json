{"metadata":{},"options":{"assumptions":{},"compact":false,"sourceMaps":true,"ast":true,"babelrc":false,"configFile":false,"parserOpts":{"sourceType":"module","sourceFileName":"/home/momen/projects/spotmycrib-master/server/routes/lettingEnquiry.js","plugins":["*","flow","jsx","asyncGenerators","bigInt","classPrivateMethods","classPrivateProperties","classProperties","doExpressions","dynamicImport","exportDefaultFrom","exportExtensions","exportNamespaceFrom","functionBind","functionSent","importMeta","nullishCoalescingOperator","numericSeparator","objectRestSpread","optionalCatchBinding","optionalChaining",["pipelineOperator",{"proposal":"minimal"}],"throwExpressions","objectRestSpread","objectRestSpread","asyncGenerators","classProperties","classPrivateProperties","jsx","nullishCoalescingOperator","nullishCoalescingOperator","optionalChaining","optionalChaining","optionalCatchBinding","optionalCatchBinding","classProperties","classPrivateProperties","classPrivateMethods","classProperties","classPrivateProperties","asyncGenerators","asyncGenerators","objectRestSpread","objectRestSpread"],"allowImportExportEverywhere":true,"allowReturnOutsideFunction":true,"allowUndeclaredExports":true,"strictMode":false},"caller":{"name":"meteor","arch":"os.linux.x86_64"},"sourceFileName":"server/routes/lettingEnquiry.js","filename":"/home/momen/projects/spotmycrib-master/server/routes/lettingEnquiry.js","targets":{},"cloneInputAst":true,"browserslistConfigFile":false,"passPerPreset":false,"envName":"development","cwd":"/home/momen/projects/spotmycrib-master","root":"/home/momen/projects/spotmycrib-master","rootMode":"root","plugins":[{"key":"base$0","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"base$0$0","visitor":{"Program":{"enter":[null],"exit":[null]},"_exploded":true,"_verified":true},"options":{"avoidModernSyntax":false,"enforceStrictMode":false,"dynamicImport":true,"generateLetDeclarations":true}},{"key":"transform-runtime","visitor":{"MemberExpression":{"enter":[null]},"ObjectPattern":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":{},"_verified":{},"Identifier":{"enter":[null]},"JSXIdentifier":{"enter":[null]}},"options":{"version":"7.13.10","helpers":true,"useESModules":false,"corejs":false}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-meteor-async-await","visitor":{"AwaitExpression":{"enter":[null]},"_exploded":true,"_verified":true,"FunctionDeclaration":{"exit":[null]},"FunctionExpression":{"exit":[null]},"ObjectMethod":{"exit":[null]},"ArrowFunctionExpression":{"exit":[null]},"ClassMethod":{"exit":[null]},"ClassPrivateMethod":{"exit":[null]}},"options":{"useNativeAsyncAwait":false}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{"loose":true}},{"key":"transform-react-jsx","visitor":{"_exploded":{},"_verified":{},"JSXNamespacedName":{"enter":[null]},"JSXSpreadChild":{"enter":[null]},"Program":{"enter":[null]},"JSXElement":{"exit":[null]},"JSXFragment":{"exit":[null]},"JSXAttribute":{"enter":[null]}},"options":{"pragma":"React.createElement","pragmaFrag":"React.Fragment","runtime":"classic","throwIfNamespace":true,"useBuiltIns":false}},{"key":"transform-react-display-name","visitor":{"ExportDefaultDeclaration":{"enter":[null]},"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-react-pure-annotations","visitor":{"CallExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"syntax-nullish-coalescing-operator","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-nullish-coalescing-operator","visitor":{"_exploded":{},"_verified":{},"LogicalExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-chaining","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-chaining","visitor":{"_exploded":{},"_verified":{},"OptionalCallExpression":{"enter":[null]},"OptionalMemberExpression":{"enter":[null]}},"options":{}},{"key":"syntax-optional-catch-binding","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-optional-catch-binding","visitor":{"_exploded":{},"_verified":{},"CatchClause":{"enter":[null]}},"options":{}},{"key":"syntax-class-properties","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-class-properties","visitor":{"PrivateName":{"enter":[null]},"ExportDefaultDeclaration":{"enter":[null]},"_exploded":true,"_verified":true,"ClassExpression":{"enter":[null]},"ClassDeclaration":{"enter":[null]}},"options":{}},{"key":"syntax-async-generators","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-async-generator-functions","visitor":{"_exploded":{},"_verified":{},"Program":{"enter":[null]}},"options":{}},{"key":"syntax-object-rest-spread","visitor":{"_exploded":true,"_verified":true},"options":{}},{"key":"proposal-object-rest-spread","visitor":{"_exploded":{},"_verified":{},"VariableDeclarator":{"enter":[null]},"ExportNamedDeclaration":{"enter":[null]},"CatchClause":{"enter":[null]},"AssignmentExpression":{"enter":[null]},"ArrayPattern":{"enter":[null]},"ObjectExpression":{"enter":[null]},"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]},"ForInStatement":{"enter":[null]},"ForOfStatement":{"enter":[null]}},"options":{}},{"key":"transform-literals","visitor":{"NumericLiteral":{"enter":[null]},"StringLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-template-literals","visitor":{"TaggedTemplateExpression":{"enter":[null]},"TemplateLiteral":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}},{"key":"transform-parameters","visitor":{"_exploded":true,"_verified":true,"FunctionDeclaration":{"enter":[null]},"FunctionExpression":{"enter":[null]},"ObjectMethod":{"enter":[null]},"ArrowFunctionExpression":{"enter":[null]},"ClassMethod":{"enter":[null]},"ClassPrivateMethod":{"enter":[null]}},"options":{}},{"key":"transform-exponentiation-operator","visitor":{"AssignmentExpression":{"enter":[null]},"BinaryExpression":{"enter":[null]},"_exploded":true,"_verified":true},"options":{}}],"presets":[],"generatorOpts":{"filename":"/home/momen/projects/spotmycrib-master/server/routes/lettingEnquiry.js","comments":true,"compact":false,"sourceMaps":true,"sourceFileName":"server/routes/lettingEnquiry.js"}},"code":"let Meteor;\nmodule.link(\"meteor/meteor\", {\n  Meteor(v) {\n    Meteor = v;\n  }\n\n}, 0);\nmodule.link(\"../../imports/api/publications.js\");\nlet bodyParser;\nmodule.link(\"body-parser\", {\n  default(v) {\n    bodyParser = v;\n  }\n\n}, 1);\n\nfunction validateEmail(email) {\n  var re = /^(([^<>()\\[\\]\\\\.,;:\\s@\"]+(\\.[^<>()\\[\\]\\\\.,;:\\s@\"]+)*)|(\".+\"))@((\\[[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\])|(([a-zA-Z\\-0-9]+\\.)+[a-zA-Z]{2,}))$/;\n  return re.test(String(email).toLowerCase());\n}\n\nvar stripedhtml = \"%3Cdiv+dir%3D%22ltr%22%3E%3Cimg+width%3D%220%22+height%3D%220%22+class%3D%22mailtrack-img%22+alt%3D%22%22+style%3D%22display%3Aflex%22+src%3D%22https%3A%2F%2Fmailtrack.io%2Ftrace%2Fmail%2F7706d8d19240906d922f05d56f1dc1b59d192efd.png%3Fu%3D2390507%22%3E%3Cdiv%3E%3C%2Fdiv%3E%3Cdiv%3E%3C%2Fdiv%3E%3Cdiv+class%3D%22gmail_quote%22%3E%3Cbr%3E%3Cu%3E%3C%2Fu%3E+%3Cdiv%3E+%3Cdiv+style%3D%22color%3Atransparent%3Bopacity%3A0%3Bfont-size%3A0px%3Bborder%3A0%3Bmax-height%3A1px%3Bwidth%3A1px%3Bmargin%3A0px%3Bpadding%3A0px%3Bborder-width%3A0px%21important%3Bdisplay%3Anone%21important%3Bline-height%3A0px%21important%22%3E%3Cimg+border%3D%220%22+width%3D%221%22+height%3D%221%22+src%3D%22http%3A%2F%2Fpost.spmailtechnol.com%2Fq%2FTHE-IBC7KjfGMZ2g91VIzA%7E%7E%2FAAFbhgA%7E%2FRgRdkLCdPVcDc3BjQgoAAB19r1slyyCmUhVzcmlrYW50aDY4MUBnbWFpbC5jb21YBAAAAAA%7E%22%3E%3C%2Fdiv%3E+%3Ctable+style%3D%22width%3A100%25%21important%3Bbackground-color%3A%23efefef%22%3E+%3Ctbody%3E%3Ctr%3E+%3Ctd%3E+%3Ctable+align%3D%22center%22+style%3D%22font-family%3Aarial%3Bfont-size%3A12px%22%3E+%3Ctbody%3E%3Ctr%3E+%3Ctd+style%3D%22width%3A2%25%22%3E%26nbsp%3B%3C%2Ftd%3E+%3Ctd+style%3D%22width%3A96%25%22%3E+%3Cdiv+style%3D%22max-width%3A800px%3Bmin-width%3A180px%22%3E+%3Ctable+id%3D%22m_-9020740417607596646background-table%22+cellpadding%3D%220%22+cellspacing%3D%220%22+border%3D%220%22+style%3D%22margin%3A0%3Bpadding%3A0%3Bcolor%3A%23000000%3Bborder-top%3A10px+solid+%23efefef%3Bborder-bottom%3A10px+solid+%23efefef%22%3E+%3Ctbody%3E%3Ctr%3E+%3Ctd%3E+%3Ctable+align%3D%22center%22+cellpadding%3D%220%22+cellspacing%3D%220%22+border%3D%220%22+style%3D%22width%3A100%25%21important%3Bbackground-color%3Awhite%22%3E+%3Ctbody%3E%3Ctr%3E+%3Ctd%3E+%3Ctable+align%3D%22center%22+cellpadding%3D%220%22+cellspacing%3D%220%22+border%3D%220%22+style%3D%22width%3A100%25%21important%3Bbackground-color%3Awhite%22%3E+%3Ctbody%3E%3Ctr%3E+%3Ctd%3E+%3Ctable+cellpadding%3D%220%22+cellspacing%3D%220%22+border%3D%220%22+style%3D%22width%3A100%25%22%3E+%3Ctbody%3E%3Ctr%3E+%3Ctd+height%3D%2214%22+style%3D%22height%3A14px%22%3E%3C%2Ftd%3E+%3C%2Ftr%3E+%3Ctr%3E+%3Ctd%3E+%3Cimg+src%3D%22https%3A%2F%2Fc1.dmstatic.com%2F402%2Fi%2Femail_alerts%2Fdomain-logos%2Fdaft.png%22+border%3D%220%22+alt%3D%22+Daft.ie+%22+style%3D%22margin-left%3A20px%3Bwidth%3A119px%3Bheight%3A37px%3Bdisplay%3Ablock%22%3E+%3C%2Ftd%3E+%3Ctd+style%3D%22width%3A9px%3Bmargin%3A3px%22%3E%26nbsp%3B%3C%2Ftd%3E+%3Ctd+style%3D%22font-family%3Aarial%3Bfont-size%3A14px%3Bpadding-right%3A30px%3Bcolor%3A%23333%3Btext-align%3Aright%22%3E+%3Cstrong+style%3D%22color%3A%23000%22%3E+Ad+enquiry+%3C%2Fstrong%3E+%3C%2Ftd%3E+%3C%2Ftr%3E+%3Ctr%3E+%3Ctd+height%3D%2214px%22+style%3D%22height%3A14px%22%3E%3C%2Ftd%3E+%3C%2Ftr%3E+%3C%2Ftbody%3E%3C%2Ftable%3E+%3C%2Ftd%3E+%3C%2Ftr%3E+%3C%2Ftbody%3E%3C%2Ftable%3E+%3C%2Ftd%3E+%3C%2Ftr%3E+%3C%2Ftbody%3E%3C%2Ftable%3E+%3Ctable+cellpadding%3D%220%22+cellspacing%3D%220%22+border%3D%220%22+style%3D%22width%3A100%25%3Bheight%3A10px%22%3E+%3Ctbody%3E%3Ctr%3E+%3Ctd+height%3D%2210%22%3E%3C%2Ftd%3E+%3C%2Ftr%3E+%3C%2Ftbody%3E%3C%2Ftable%3E+%3Ctable+cellpadding%3D%220%22+cellspacing%3D%220%22+border%3D%220%22+style%3D%22width%3A100%25%3Bbackground-color%3Awhite%3Bmargin-left%3Aauto%3Bmargin-right%3Aauto%22%3E+%3Ctbody%3E%3Ctr%3E+%3Ctd%3E+%3Ctable+cellpadding%3D%220%22+cellspacing%3D%220%22+border%3D%220%22+style%3D%22margin-left%3A20px%3Bmargin-right%3A20px%3Bcolor%3A%23525252%3Bfont-family%3Aarial%3Bmin-width%3A120px%3Bmax-width%3A588px%3Bfont-size%3A14px%22%3E+%3Ctbody%3E%3Ctr%3E%3Ctd+height%3D%2220%22+style%3D%22height%3A20px%22%3E%3C%2Ftd%3E%3C%2Ftr%3E+%3Ctr%3E+%3Ctd%3E+%3Ctable+border%3D%220%22+cellpadding%3D%220%22+cellspacing%3D%220%22%3E+%3Ctbody%3E%3Ctr%3E+%3Ctd%3E+%3Ctable+cellpadding%3D%220%22+cellspacing%3D%220%22+border%3D%220%22+style%3D%22width%3A100%25%3Bmargin-left%3Aauto%3Bmargin-right%3Aauto%3Bmin-width%3A120px%3Bmax-width%3A588px%22%3E+%3Ctbody%3E%3Ctr%3E+%3Ctd+style%3D%22font-family%3Aarial%3Bfont-size%3A16px%3Bfont-weight%3Abold%3Bcolor%3A%23000%22%3E+From%3A+%3C%2Ftd%3E+%3C%2Ftr%3E+%3Ctr%3E+%3Ctd+style%3D%22font-family%3Aarial%3Bcolor%3A%23333%3Bfont-size%3A16px%3Bpadding-bottom%3A10px%22%3E+Anthony+Bloomer+%3C%2Ftd%3E+%3C%2Ftr%3E+%3Ctr%3E+%3Ctd+style%3D%22font-family%3Aarial%3Bfont-size%3A16px%3Bfont-weight%3Abold%3Bcolor%3A%23000%22%3E+Email%3A+%3C%2Ftd%3E+%3C%2Ftr%3E+%3Ctr%3E+%3Ctd+style%3D%22font-family%3Aarial%3Bcolor%3A%23333%3Bfont-size%3A16px%3Bpadding-bottom%3A10px%22%3E+%3Ca+href%3D%22mailto%3Aabloomer%40newrelic.com%22+style%3D%22color%3A%232953aa%3Btext-decoration%3Anone%22+target%3D%22_blank%22%3E+abloomer%40newrelic.com+%3C%2Fa%3E+%3C%2Ftd%3E+%3C%2Ftr%3E+%3Ctr%3E+%3Ctd+style%3D%22font-family%3Aarial%3Bfont-size%3A16px%3Bfont-weight%3Abold%3Bcolor%3A%23000%22%3E+Phone+number%3A+%3C%2Ftd%3E+%3C%2Ftr%3E+%3Ctr%3E+%3Ctd+style%3D%22font-family%3Aarial%3Bcolor%3A%23333%3Bfont-size%3A16px%3Bpadding-bottom%3A10px%22%3E+%3Ca+style%3D%22color%3A%23333%3Btext-decoration%3Anone%22+href%3D%22tel%3A0858278968%22+target%3D%22_blank%22%3E+0858278968+%3C%2Fa%3E+%3C%2Ftd%3E+%3C%2Ftr%3E+%3Ctr%3E+%3Ctd+style%3D%22font-family%3Aarial%3Bfont-size%3A16px%3Bfont-weight%3Abold%3Bcolor%3A%23000%22%3E+Property%3A+%3C%2Ftd%3E+%3C%2Ftr%3E+%3Ctr%3E+%3Ctd+style%3D%22font-family%3Aarial%3Bcolor%3A%23333%3Bfont-size%3A16px%3Bpadding-bottom%3A10px%22%3E+%3Ca+style%3D%22text-decoration%3Anone%3Bcolor%3A%232953aa%22+href%3D%22https%3A%2F%2Fwww.daft.ie%2F31041941%22+target%3D%22_blank%22%3E+Rockfield%2C+Dundrum%2C+Dublin+14+%3C%2Fa%3E+%3C%2Ftd%3E+%3C%2Ftr%3E+%3Ctr%3E+%3Ctd+style%3D%22font-family%3Aarial%3Bfont-size%3A16px%3Bfont-weight%3Abold%3Bcolor%3A%23000%22%3E+Message%3A+%3C%2Ftd%3E+%3C%2Ftr%3E+%3Ctr%3E+%3Ctd+style%3D%22font-family%3Aarial%3Bcolor%3A%23333%3Bfont-size%3A16px%22%3E+Hi%2C%3Cbr%3E+%3Cbr%3E+My+name+is+Anthony+Bloomer%2C+an+Engineering+professional+in+the+IT+industry.%3Cbr%3E+%3Cbr%3E+Currently%2C+I+am+working+for+a+large+multinational+company+called+New+Relic+as+a+Technical+Support+Engineer.%3Cbr%3E+%3Cbr%3E+This+property+you+are+advertising+is+ideal+since+it+is+very+close+to+my+workplace+in+Dublin+City+Centre.%3Cbr%3E+%3Cbr%3E+I+would+be+very+grateful+for+an+opportunity+to+view+the+room+in+person+and+chat+with+you+about+it.%3Cbr%3E+%3Cbr%3E+I+can+provide+references+and+letter+of+employment+on+request.%3Cbr%3E+%3Cbr%3E+I+do+look+forward+to+hearing+back+from+you.%3Cbr%3E+%3Cbr%3E+All+the+best%2C%3Cbr%3E+Anthony+Bloomer+%3C%2Ftd%3E+%3C%2Ftr%3E+%3C%2Ftbody%3E%3C%2Ftable%3E+%3C%2Ftd%3E+%3C%2Ftr%3E+%3C%2Ftbody%3E%3C%2Ftable%3E+%3Cbr%3E+%3C%2Ftd%3E+%3C%2Ftr%3E+%3Ctr%3E+%3Ctd+height%3D%2215%22+style%3D%22height%3A15px%3Bborder-bottom%3A2px+solid+%23efefef%22%3E%3C%2Ftd%3E+%3C%2Ftr%3E+%3Ctr%3E%3Ctd+height%3D%2215%22+style%3D%22height%3A15px%22%3E%3C%2Ftd%3E%3C%2Ftr%3E+%3Ctr%3E+%3Ctd+style%3D%22font-family%3Aarial%3Bcolor%3A%23333%3Bfont-size%3A16px%22%3E+Please+be+aware+of+suspicious+behaviour.+Never+wire+funds+through+a+third+party+money+transfer+service.+For+more+advice+please+see+%3Ca+style%3D%22text-decoration%3Anone%3Bcolor%3A%232953aa%22+href%3D%22https%3A%2F%2Fwww.daft.ie%2Fsafety-online%22+target%3D%22_blank%22%3E+Daft%26%2339%3Bs+Safety+Online+Guide+%3C%2Fa%3E+%3C%2Ftd%3E+%3C%2Ftr%3E+%3Ctr%3E+%3Ctd+height%3D%2215%22+style%3D%22height%3A15px%3Bborder-bottom%3A2px+solid+%23efefef%22%3E%3C%2Ftd%3E+%3C%2Ftr%3E+%3Ctr%3E%3Ctd+height%3D%2215%22+style%3D%22height%3A15px%22%3E%3C%2Ftd%3E%3C%2Ftr%3E+%3Ctr%3E%3Ctd+height%3D%2210%22+style%3D%22height%3A10px%22%3E%3C%2Ftd%3E%3C%2Ftr%3E+%3Ctr%3E+%3Ctd+style%3D%22font-family%3Aarial%3Bcolor%3A%23333%3Bmargin%3A0px%3Bfont-size%3A16px%22%3E+Kind+Regards%2C+%3C%2Ftd%3E+%3C%2Ftr%3E%3Ctr%3E+%3Ctd+style%3D%22font-family%3Aarial%3Bcolor%3A%23333%3Bfont-size%3A16px%22%3E+The+Daft.ie+Team+%3C%2Ftd%3E+%3C%2Ftr%3E+%3Ctr%3E+%3Ctd+height%3D%2220%22+style%3D%22height%3A20px%22%3E%3C%2Ftd%3E+%3C%2Ftr%3E+%3Ctr%3E+%3Ctd+style%3D%22color%3A%23777%3Bmargin%3A0px%3Bfont-family%3Aarial%3Bfont-size%3A11px%22%3E+Email%3A+%3Ca+href%3D%22mailto%3Asupportdesk%40daft.ie%22+style%3D%22font-weight%3Abold%3Btext-decoration%3Anone%3Bcolor%3A%232953aa%22+target%3D%22_blank%22%3E+supportdesk%40daft.ie+%3C%2Fa%3E+%7C+Daft+Media+Ltd.%2C+3rd+Floor+Latin+Hall%2C+Golden+Lane%2C+Dublin+8+%3C%2Ftd%3E+%3C%2Ftr%3E+%3Ctr%3E+%3Ctd+height%3D%2210%22+style%3D%22height%3A10px%22%3E%3C%2Ftd%3E+%3C%2Ftr%3E+%3C%2Ftbody%3E%3C%2Ftable%3E+%3C%2Ftd%3E+%3C%2Ftr%3E+%3Ctr%3E+%3Ctd%3E+%3C%2Ftd%3E+%3C%2Ftr%3E+%3C%2Ftbody%3E%3C%2Ftable%3E+%3C%2Ftd%3E+%3C%2Ftr%3E+%3C%2Ftbody%3E%3C%2Ftable%3E+%3C%2Fdiv%3E+%3C%2Ftd%3E+%3Ctd+style%3D%22width%3A2%25%22%3E%26nbsp%3B%3C%2Ftd%3E+%3C%2Ftr%3E+%3C%2Ftbody%3E%3C%2Ftable%3E+%3C%2Ftd%3E+%3C%2Ftr%3E+%3C%2Ftbody%3E%3C%2Ftable%3E+%3Cimg+border%3D%220%22+width%3D%221%22+height%3D%221%22+alt%3D%22%22+src%3D%22http%3A%2F%2Fpost.spmailtechnol.com%2Fq%2Fokk99SCiCrBeq5auetPObw%7E%7E%2FAAFbhgA%7E%2FRgRdkLCdPlcDc3BjQgoAAB19r1slyyCmUhVzcmlrYW50aDY4MUBnbWFpbC5jb21YBAAAAAA%7E%22%3E+%3C%2Fdiv%3E+%3C%2Fdiv%3E%3Cdiv%3E%3Cbr%3E%3C%2Fdiv%3E%3Cbr%3E%3C%2Fdiv%3E\"; // Add two middleware calls. The first attempting to parse the request body as\n// JSON data and the second as URL encoded data.\n\nPicker.middleware(bodyParser.json());\nPicker.middleware(bodyParser.urlencoded({\n  extended: true\n})); // Picker.middleware( bodyParser.raw( ) );\n// Picker.middleware( bodyParser.text( ) );\n\nPicker.route('/lettingEnquiry2', function (params, req, res, next) {\n  if (req.method != 'POST') {\n    res.writeHead(400, 'Bad Request');\n    res.end();\n    return false; // This is an invalid request\n  }\n\n  console.log('in lettingEnquiry2');\n  let body = '';\n  req.on('data', Meteor.bindEnvironment(data => {\n    body += data;\n  })).on('end', Meteor.bindEnvironment(() => {\n    // console.log(body)\n    // keys = Object.keys(body)\n    // json = keys[0];\n    console.log(\"typeof body\");\n    console.log(typeof body);\n    console.log(body); // console.log(typeof keys);\n    // console.log(typeof json);\n    // console.log(json);\n\n    try {\n      json = JSON.parse(body);\n    } catch (e) {\n      console.log('Parse failed');\n      console.log(e);\n      res.writeHead(400, 'Bad Request');\n      res.end();\n      return;\n    }\n\n    if (!json) {\n      res.writeHead(400);\n      res.end('Invalid input');\n      return;\n    }\n\n    processEmail = processEmail.bind(this);\n    let ret = processEmail(json);\n\n    if (!ret.status) {\n      res.writeHead(400);\n      res.end('Invalid input. Error: ' + ret.message);\n      return;\n    }\n\n    res.writeHead(200);\n    res.end('success');\n  }));\n});\nPicker.route('/lettingEnquiry', function (params, req, res, next) {\n  if (req.method != 'POST') {\n    res.writeHead(400, 'Bad Request');\n    res.end();\n    return false; // This is an invalid request\n  }\n\n  console.log('in lettingEnquiry');\n  let json = {};\n\n  if (req.body) {\n    // console.log(\"req.body\")\n    // console.log(req.body)\n    json = req.body;\n    json = JSON.stringify(json); // console.log(typeof json);\n    // console.log(json);\n\n    try {\n      json = JSON.parse(json);\n    } catch (e) {\n      console.log('Parse failed');\n      console.log(e);\n      res.writeHead(400, 'Bad Request');\n      res.end();\n      return;\n    }\n  } else {}\n\n  if (!json) {\n    res.writeHead(400);\n    res.end('Invalid input');\n    return;\n  }\n\n  processEmail = processEmail.bind(this);\n  let ret = processEmail(json);\n\n  if (!ret.status) {\n    res.writeHead(400);\n    console.log('Invalid input. Error: ' + ret.message);\n    res.end('Invalid input. Error: ' + ret.message);\n    return;\n  }\n\n  res.writeHead(200);\n  res.end('success');\n});\n\nfunction processEmail(json) {\n  //How to handle spam, email \n  // console.log(json);\n  // console.log(json.recipient);\n  // console.log(json['recipient']);\n  let enq = {};\n\n  try {\n    enq.fullname = json.subject.split('from ')[1].split(' on')[0]; //Enquiry from Anthony Bloomer on Daft.ie | Flat share in Rockfield, Dundrum, Co. Dublin\n  } catch (e) {\n    console.log('failed to retrive full name');\n  } // enq.date = new Date(json.Date);\n\n\n  try {\n    enq.message = json['body-plain'].split('Message:')[1].split('Please be aware of suspicious')[0].trim(); // enq.message = json['body-plain'].split('Message:')[1].split('</tr>')[0].trim();\n  } catch (e) {\n    console.log('failed to retrive message');\n    console.log(e);\n  } // enq.recipient = json.recipient;\n\n\n  let propKey = '';\n\n  try {\n    propKey = json.recipient.split('let-')[1].split('@')[0];\n    if (propKey.length != 5) throw \"Invalid property Key\";\n    propKey = propKey.toUpperCase();\n  } catch (e) {\n    return {\n      status: false,\n      message: 'failed to retrieve property Key'\n    };\n  }\n\n  enq.propKey = propKey; // console.log(json['body-plain'].replace(/\\n/g, \" \") );\n  // console.log('more deeper');\n  // console.log(json['body-plain'].replace(/\\n/g, \" \").replace(/ {1,}/g,\" \") );\n  // console.log('with split');\n  // console.log(json['body-plain'].replace(/\\n/g, \" \").replace(/ {1,}/g,\" \").split('Email: ')[1] );\n\n  try {\n    enq.email = json['body-plain'].match(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\\.[a-zA-Z0-9._-]+)/gi)[0]; // enq.email = json['body-plain'].replace(/\\n/g, \" \").replace(/ {1,}/g,\" \").split('Email: ')[1].split(' ')[0];\n\n    if (enq.email.indexOf('supportdesk@daft.ie') != -1) {\n      //it took dafts email. use 2nd logic now.\n      console.log('Using 2nd logic to fetch email');\n      enq.email = json['body-plain'].split('Email:')[1].split(' ')[1].trim();\n\n      if (!validateEmail(enq.email)) {\n        console.log('Using 3rd logic to fetch email');\n        enq.email = json['body-plain'].split('Email:')[1].split(' ')[0].trim();\n      }\n\n      if (!validateEmail(enq.email)) {\n        console.log('Using 4rd logic to fetch email');\n        enq.email = enq.email.match(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\\.[a-zA-Z0-9._-]+)/gi)[0];\n      }\n\n      console.log('Email is: ' + enq.email);\n    }\n  } catch (e) {}\n\n  if (!validateEmail(enq.email)) {\n    return {\n      status: false,\n      message: 'failed to retrieve email'\n    };\n  }\n\n  console.log(enq.email);\n\n  try {\n    enq.mobile = json['body-plain'].split('Phone number:')[1].split('Property')[0].trim(); // enq.mobile = json['body-plain'].split('Phone number: ')[1].split(' ')[0];\n  } catch (e) {} // console.log(enq);\n\n\n  let auction = Collections.Auctions.findOne({\n    lettingAuctionCode: enq.propKey\n  });\n\n  if (!auction) {\n    //Auction not found, don't process this \n    return {\n      status: false,\n      message: 'Auction not found'\n    };\n  }\n\n  let property = false;\n  if (auction.propertyId) property = Collections.Properties.findOne({\n    _id: auction.propertyId\n  });\n\n  if (!property) {\n    //Auction not found, don't process this \n    return {\n      status: false,\n      message: 'Property not found'\n    };\n  }\n\n  let user = Meteor.users.findOne({\n    'profile.email': enq.email\n  });\n\n  if (!user) {\n    //User not found, so insert a new emailEnquiry, send emailEnquiryReceived\n    let existingEnquiry = Collections.EmailEnquiries.findOne({\n      email: enq.email,\n      propertyId: property._id,\n      auctionId: auction._id\n    });\n\n    if (!existingEnquiry) {\n      //Not existing, insert new one\n      let emailEnquiryId = Collections.EmailEnquiries.insert({\n        fullname: enq.fullname,\n        email: enq.email,\n        mobile: enq.mobile,\n        // propKey: enq.propKey,\n        propertyId: property._id,\n        auctionId: auction._id,\n        createdAt: new Date(),\n        message: enq.message,\n        isArchived: false\n      });\n      console.log(\"emailEnquiry placed: \" + emailEnquiryId);\n      var data = {\n        userEmail: enq.email,\n        fullname: enq.fullname,\n        requestType: 'emailEnquiryReceived',\n        //This is an Ack email for all the emailEnqueries placed by user in a group of 15mns. \n        emailEnquiryId: emailEnquiryId,\n        propertyId: property._id\n      };\n      Meteor.call('requestEmail', data);\n\n      if (isNaN(auction.enquiryCount)) {\n        //if its not a number ; for first time scenarios.\n        Collections.Auctions.update(auction._id, {\n          $set: {\n            \"enquiryCount\": 1\n          }\n        });\n      } else {\n        Collections.Auctions.update(auction._id, {\n          $inc: {\n            \"enquiryCount\": 1\n          }\n        });\n      } //////////////LANDLORD EMAIL\n\n\n      let address = titleCase(property.address.address);\n      if (property.address.area) address += ', ' + titleCase(property.address.area);\n      if (property.address.county) address += ', ' + titleCase(property.address.county);\n      let subject = 'Enquiry received for ' + address;\n      let agent = Meteor.users.findOne({\n        _id: property.createdByAgent\n      });\n      let userFirstName = agent.profile.name;\n\n      if (userFirstName) {\n        userFirstName = titleCase(userFirstName.split(' ')[0]);\n      }\n\n      let ec = auction.enquiryCount;\n      if (!ec) ec = 1;else ec += 1;\n      let ac = auction.bids;\n      let subHeading = 'This letting has received ' + ec + ' email ' + (ec > 1 ? 'enquiries' : 'enquiry') + ' and ' + (ac == 0 ? 'no' : ac) + ' ' + (ac != 1 ? 'applications' : 'application') + ' so far.';\n      let sluggedName = slugifyEmailAddress(agent.profile.name);\n      if (!sluggedName) sluggedName = 'rent';\n      let propertyEmail = sluggedName + '-let-' + auction.lettingAuctionCode.toLowerCase() + \"@spotmycrib.ie\";\n      let user = {\n        \"profile\": {\n          name: enq.fullname,\n          email: enq.email,\n          userFirstName: userFirstName\n        }\n      };\n      var mailData = {\n        template: 'emailEnquiryReceivedLandlord',\n        subject: subject,\n        mailTo: agent.profile.email,\n        //mailTo: 'srikanth681@gmail.com',\n        replyTo: enq.email,\n        property: property,\n        bedsCount: property.bedrooms.length,\n        rentFormated: numDifferentiation(auction.price),\n        auction: auction,\n        enquiry: enq,\n        propertyKeys: auction.lettingAuctionCode,\n        agent: agent,\n        user: user,\n        propertyImage: false,\n        //dont need it here\n        propertyUrl: FlowRouter.url('rent', {\n          slug: property.slug,\n          key: auction.lettingAuctionCode\n        }),\n        propertyApplicationsUrl: FlowRouter.url('account/propertyApplications', {\n          id: property._id\n        }),\n        propertyEmail: propertyEmail,\n        subHeading: subHeading\n      };\n\n      try {\n        Meteor.call('sendNotificationEmail', mailData); //Keep it asynchronous for speed\n        // Meteor.call('sendNotificationEmail', mailData,true);//if you don't want it to fail and need it to be sync, use email queues instead.\n      } catch (e) {\n        console.log('Mail sending failed. ');\n        console.log(e);\n        return {\n          status: false,\n          message: 'Mail sending failed'\n        };\n      }\n    } else {\n      //There is an existing enquiry\n      return {\n        status: false,\n        message: 'Request already exists'\n      };\n    }\n  } else if (user) {\n    // User found, insert bid, send uploadRefsReminder\n    this.placeBidCallback = function (error, result) {\n      if (error) {\n        console.log(\"emailEnquiry bid failed\");\n        console.log(error);\n        return false;\n      }\n\n      if (result.status == 'Success') {\n        console.log(\"emailEnquiry bid success\");\n      }\n    };\n\n    this.placeBidCallback = this.placeBidCallback.bind(this);\n    Meteor.call('placeBid', [auction._id, auction.price, enq.message, user._id], this.placeBidCallback);\n\n    if (getUserProfileScore(user) < 70) {\n      var mailData = {\n        userEmail: enq.email,\n        fullname: enq.fullname,\n        requestType: 'uploadRefsReminder',\n        //This is a reminder email for the user to complete their profile. \n        propertyId: property._id,\n        auctionId: auction._id\n      }; // Meteor.call('requestEmail',mailData);//Temporarly disabling the reminder emails.\n    }\n  }\n\n  return {\n    status: true,\n    message: 'end of method'\n  };\n}\n\nfunction getUserProfileScore(user) {\n  let score = 0;\n\n  if (user.profile.mobile) {\n    score += 15;\n  }\n\n  if (!user.services) user.services = {};\n\n  if (user.services.facebook) {\n    score += 15;\n  } // if(user.services.google){score += 10;}\n\n\n  if (user.services.twitter) {\n    score += 10;\n  }\n\n  if (user.services.linkedin) {\n    score += 15;\n  }\n\n  if (user.profile.references.hasPassport) {\n    score += 10;\n  }\n\n  if (user.profile.references.employerName) {\n    score += 3;\n  }\n\n  if (user.profile.references.employerTakeHome) {\n    score += 2;\n  }\n\n  if (user.profile.references.hasWorkRef) {\n    score += 10;\n  }\n\n  if (user.profile.references.hasLandlordRef) {\n    score += 10;\n  }\n\n  if (user.profile.references.hasPPS) {\n    score += 3;\n  } // if(user.profile.references.hasFinancialRef){score += 0;}\n\n\n  if (user.profile.references.hasGovtID) {\n    score += 4;\n  }\n\n  if (user.profile.references.hasResume) {\n    score += 3;\n  }\n\n  if (score > 100) score = 100;\n  return score;\n}\n\nfunction numDifferentiation(val) {\n  if (val >= 1000000000) val = (val / 1000000000).toFixed(2) + ' Billion';else if (val >= 1000000) val = (val / 1000000).toFixed(2) + ' Million';\n  return val.toString().replace(/\\B(?=(\\d{3})+(?!\\d))/g, \",\");\n}\n\nfunction slugifyEmailAddress(text) {\n  if (!text) return '';\n  const a = 'àáäâèéëêìíïîòóöôùúüûñçßÿœæŕśńṕẃǵǹḿǘẍźḧ/_,:;';\n  const b = 'aaaaeeeeiiiioooouuuuncsyoarsnpwgnmuxzh------';\n  const p = new RegExp(a.split('').join('|'), 'g');\n  return text.toString().toLowerCase().replace(/\\s+/g, '.') // Replace spaces with \".\"\n  .replace(p, c => b.charAt(a.indexOf(c))) // Replace special chars\n  .replace(/&/g, '-and-') // Replace & with ''\n  // .replace(/[^\\w\\-]+/g, '')       // Remove all non-word chars\n  .replace(/\\-\\-+/g, '-') // Replace multiple - with single ''\n  .replace(/^-+/, '') // Trim - from start of text\n  .replace(/-+$/, ''); // Trim - from end of text\n}\n\nfunction titleCase(str) {\n  if (!str) return;\n  return str.charAt(0).toUpperCase() + str.toLowerCase().substring(1);\n}\n/*\nUrl {\n            I20181205-20:24:53.640(0)?   protocol: null,\n            I20181205-20:24:53.640(0)?   slashes: null,\n            I20181205-20:24:53.642(0)?   auth: null,\n            I20181205-20:24:53.644(0)?   host: null,\n            I20181205-20:24:53.645(0)?   port: null,\n            I20181205-20:24:53.646(0)?   hostname: null,\n            I20181205-20:24:53.646(0)?   hash: null,\n            I20181205-20:24:53.647(0)?   search: null,\n            I20181205-20:24:53.648(0)?   query: null,\n            I20181205-20:24:53.649(0)?   pathname: '/account/profile',\n            I20181205-20:24:53.649(0)?   path: '/account/profile',\n            I20181205-20:24:53.651(0)?   href: '/account/profile',\n            I20181205-20:24:53.651(0)?   _raw: '/account/profile' }\n\n\n */","map":{"version":3,"sources":["server/routes/lettingEnquiry.js"],"names":["Meteor","module","link","v","bodyParser","default","validateEmail","email","re","test","String","toLowerCase","stripedhtml","Picker","middleware","json","urlencoded","extended","route","params","req","res","next","method","writeHead","end","console","log","body","on","bindEnvironment","data","JSON","parse","e","processEmail","bind","ret","status","message","stringify","enq","fullname","subject","split","trim","propKey","recipient","length","toUpperCase","match","indexOf","mobile","auction","Collections","Auctions","findOne","lettingAuctionCode","property","propertyId","Properties","_id","user","users","existingEnquiry","EmailEnquiries","auctionId","emailEnquiryId","insert","createdAt","Date","isArchived","userEmail","requestType","call","isNaN","enquiryCount","update","$set","$inc","address","titleCase","area","county","agent","createdByAgent","userFirstName","profile","name","ec","ac","bids","subHeading","sluggedName","slugifyEmailAddress","propertyEmail","mailData","template","mailTo","replyTo","bedsCount","bedrooms","rentFormated","numDifferentiation","price","enquiry","propertyKeys","propertyImage","propertyUrl","FlowRouter","url","slug","key","propertyApplicationsUrl","id","placeBidCallback","error","result","getUserProfileScore","score","services","facebook","twitter","linkedin","references","hasPassport","employerName","employerTakeHome","hasWorkRef","hasLandlordRef","hasPPS","hasGovtID","hasResume","val","toFixed","toString","replace","text","a","b","p","RegExp","join","c","charAt","str","substring"],"mappings":"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","sourcesContent":["/**\n * Created by srikanth681 on 09/12/2018. Dev 09, 2018\n */\nimport {Meteor} from \"meteor/meteor\";\nimport \"../../imports/api/publications.js\";\nimport bodyParser from 'body-parser';\n\nfunction validateEmail(email) {\n    var re = /^(([^<>()\\[\\]\\\\.,;:\\s@\"]+(\\.[^<>()\\[\\]\\\\.,;:\\s@\"]+)*)|(\".+\"))@((\\[[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\.[0-9]{1,3}\\])|(([a-zA-Z\\-0-9]+\\.)+[a-zA-Z]{2,}))$/;\n    return re.test(String(email).toLowerCase());\n}\nvar stripedhtml = \"%3Cdiv+dir%3D%22ltr%22%3E%3Cimg+width%3D%220%22+height%3D%220%22+class%3D%22mailtrack-img%22+alt%3D%22%22+style%3D%22display%3Aflex%22+src%3D%22https%3A%2F%2Fmailtrack.io%2Ftrace%2Fmail%2F7706d8d19240906d922f05d56f1dc1b59d192efd.png%3Fu%3D2390507%22%3E%3Cdiv%3E%3C%2Fdiv%3E%3Cdiv%3E%3C%2Fdiv%3E%3Cdiv+class%3D%22gmail_quote%22%3E%3Cbr%3E%3Cu%3E%3C%2Fu%3E+%3Cdiv%3E+%3Cdiv+style%3D%22color%3Atransparent%3Bopacity%3A0%3Bfont-size%3A0px%3Bborder%3A0%3Bmax-height%3A1px%3Bwidth%3A1px%3Bmargin%3A0px%3Bpadding%3A0px%3Bborder-width%3A0px%21important%3Bdisplay%3Anone%21important%3Bline-height%3A0px%21important%22%3E%3Cimg+border%3D%220%22+width%3D%221%22+height%3D%221%22+src%3D%22http%3A%2F%2Fpost.spmailtechnol.com%2Fq%2FTHE-IBC7KjfGMZ2g91VIzA%7E%7E%2FAAFbhgA%7E%2FRgRdkLCdPVcDc3BjQgoAAB19r1slyyCmUhVzcmlrYW50aDY4MUBnbWFpbC5jb21YBAAAAAA%7E%22%3E%3C%2Fdiv%3E+%3Ctable+style%3D%22width%3A100%25%21important%3Bbackground-color%3A%23efefef%22%3E+%3Ctbody%3E%3Ctr%3E+%3Ctd%3E+%3Ctable+align%3D%22center%22+style%3D%22font-family%3Aarial%3Bfont-size%3A12px%22%3E+%3Ctbody%3E%3Ctr%3E+%3Ctd+style%3D%22width%3A2%25%22%3E%26nbsp%3B%3C%2Ftd%3E+%3Ctd+style%3D%22width%3A96%25%22%3E+%3Cdiv+style%3D%22max-width%3A800px%3Bmin-width%3A180px%22%3E+%3Ctable+id%3D%22m_-9020740417607596646background-table%22+cellpadding%3D%220%22+cellspacing%3D%220%22+border%3D%220%22+style%3D%22margin%3A0%3Bpadding%3A0%3Bcolor%3A%23000000%3Bborder-top%3A10px+solid+%23efefef%3Bborder-bottom%3A10px+solid+%23efefef%22%3E+%3Ctbody%3E%3Ctr%3E+%3Ctd%3E+%3Ctable+align%3D%22center%22+cellpadding%3D%220%22+cellspacing%3D%220%22+border%3D%220%22+style%3D%22width%3A100%25%21important%3Bbackground-color%3Awhite%22%3E+%3Ctbody%3E%3Ctr%3E+%3Ctd%3E+%3Ctable+align%3D%22center%22+cellpadding%3D%220%22+cellspacing%3D%220%22+border%3D%220%22+style%3D%22width%3A100%25%21important%3Bbackground-color%3Awhite%22%3E+%3Ctbody%3E%3Ctr%3E+%3Ctd%3E+%3Ctable+cellpadding%3D%220%22+cellspacing%3D%220%22+border%3D%220%22+style%3D%22width%3A100%25%22%3E+%3Ctbody%3E%3Ctr%3E+%3Ctd+height%3D%2214%22+style%3D%22height%3A14px%22%3E%3C%2Ftd%3E+%3C%2Ftr%3E+%3Ctr%3E+%3Ctd%3E+%3Cimg+src%3D%22https%3A%2F%2Fc1.dmstatic.com%2F402%2Fi%2Femail_alerts%2Fdomain-logos%2Fdaft.png%22+border%3D%220%22+alt%3D%22+Daft.ie+%22+style%3D%22margin-left%3A20px%3Bwidth%3A119px%3Bheight%3A37px%3Bdisplay%3Ablock%22%3E+%3C%2Ftd%3E+%3Ctd+style%3D%22width%3A9px%3Bmargin%3A3px%22%3E%26nbsp%3B%3C%2Ftd%3E+%3Ctd+style%3D%22font-family%3Aarial%3Bfont-size%3A14px%3Bpadding-right%3A30px%3Bcolor%3A%23333%3Btext-align%3Aright%22%3E+%3Cstrong+style%3D%22color%3A%23000%22%3E+Ad+enquiry+%3C%2Fstrong%3E+%3C%2Ftd%3E+%3C%2Ftr%3E+%3Ctr%3E+%3Ctd+height%3D%2214px%22+style%3D%22height%3A14px%22%3E%3C%2Ftd%3E+%3C%2Ftr%3E+%3C%2Ftbody%3E%3C%2Ftable%3E+%3C%2Ftd%3E+%3C%2Ftr%3E+%3C%2Ftbody%3E%3C%2Ftable%3E+%3C%2Ftd%3E+%3C%2Ftr%3E+%3C%2Ftbody%3E%3C%2Ftable%3E+%3Ctable+cellpadding%3D%220%22+cellspacing%3D%220%22+border%3D%220%22+style%3D%22width%3A100%25%3Bheight%3A10px%22%3E+%3Ctbody%3E%3Ctr%3E+%3Ctd+height%3D%2210%22%3E%3C%2Ftd%3E+%3C%2Ftr%3E+%3C%2Ftbody%3E%3C%2Ftable%3E+%3Ctable+cellpadding%3D%220%22+cellspacing%3D%220%22+border%3D%220%22+style%3D%22width%3A100%25%3Bbackground-color%3Awhite%3Bmargin-left%3Aauto%3Bmargin-right%3Aauto%22%3E+%3Ctbody%3E%3Ctr%3E+%3Ctd%3E+%3Ctable+cellpadding%3D%220%22+cellspacing%3D%220%22+border%3D%220%22+style%3D%22margin-left%3A20px%3Bmargin-right%3A20px%3Bcolor%3A%23525252%3Bfont-family%3Aarial%3Bmin-width%3A120px%3Bmax-width%3A588px%3Bfont-size%3A14px%22%3E+%3Ctbody%3E%3Ctr%3E%3Ctd+height%3D%2220%22+style%3D%22height%3A20px%22%3E%3C%2Ftd%3E%3C%2Ftr%3E+%3Ctr%3E+%3Ctd%3E+%3Ctable+border%3D%220%22+cellpadding%3D%220%22+cellspacing%3D%220%22%3E+%3Ctbody%3E%3Ctr%3E+%3Ctd%3E+%3Ctable+cellpadding%3D%220%22+cellspacing%3D%220%22+border%3D%220%22+style%3D%22width%3A100%25%3Bmargin-left%3Aauto%3Bmargin-right%3Aauto%3Bmin-width%3A120px%3Bmax-width%3A588px%22%3E+%3Ctbody%3E%3Ctr%3E+%3Ctd+style%3D%22font-family%3Aarial%3Bfont-size%3A16px%3Bfont-weight%3Abold%3Bcolor%3A%23000%22%3E+From%3A+%3C%2Ftd%3E+%3C%2Ftr%3E+%3Ctr%3E+%3Ctd+style%3D%22font-family%3Aarial%3Bcolor%3A%23333%3Bfont-size%3A16px%3Bpadding-bottom%3A10px%22%3E+Anthony+Bloomer+%3C%2Ftd%3E+%3C%2Ftr%3E+%3Ctr%3E+%3Ctd+style%3D%22font-family%3Aarial%3Bfont-size%3A16px%3Bfont-weight%3Abold%3Bcolor%3A%23000%22%3E+Email%3A+%3C%2Ftd%3E+%3C%2Ftr%3E+%3Ctr%3E+%3Ctd+style%3D%22font-family%3Aarial%3Bcolor%3A%23333%3Bfont-size%3A16px%3Bpadding-bottom%3A10px%22%3E+%3Ca+href%3D%22mailto%3Aabloomer%40newrelic.com%22+style%3D%22color%3A%232953aa%3Btext-decoration%3Anone%22+target%3D%22_blank%22%3E+abloomer%40newrelic.com+%3C%2Fa%3E+%3C%2Ftd%3E+%3C%2Ftr%3E+%3Ctr%3E+%3Ctd+style%3D%22font-family%3Aarial%3Bfont-size%3A16px%3Bfont-weight%3Abold%3Bcolor%3A%23000%22%3E+Phone+number%3A+%3C%2Ftd%3E+%3C%2Ftr%3E+%3Ctr%3E+%3Ctd+style%3D%22font-family%3Aarial%3Bcolor%3A%23333%3Bfont-size%3A16px%3Bpadding-bottom%3A10px%22%3E+%3Ca+style%3D%22color%3A%23333%3Btext-decoration%3Anone%22+href%3D%22tel%3A0858278968%22+target%3D%22_blank%22%3E+0858278968+%3C%2Fa%3E+%3C%2Ftd%3E+%3C%2Ftr%3E+%3Ctr%3E+%3Ctd+style%3D%22font-family%3Aarial%3Bfont-size%3A16px%3Bfont-weight%3Abold%3Bcolor%3A%23000%22%3E+Property%3A+%3C%2Ftd%3E+%3C%2Ftr%3E+%3Ctr%3E+%3Ctd+style%3D%22font-family%3Aarial%3Bcolor%3A%23333%3Bfont-size%3A16px%3Bpadding-bottom%3A10px%22%3E+%3Ca+style%3D%22text-decoration%3Anone%3Bcolor%3A%232953aa%22+href%3D%22https%3A%2F%2Fwww.daft.ie%2F31041941%22+target%3D%22_blank%22%3E+Rockfield%2C+Dundrum%2C+Dublin+14+%3C%2Fa%3E+%3C%2Ftd%3E+%3C%2Ftr%3E+%3Ctr%3E+%3Ctd+style%3D%22font-family%3Aarial%3Bfont-size%3A16px%3Bfont-weight%3Abold%3Bcolor%3A%23000%22%3E+Message%3A+%3C%2Ftd%3E+%3C%2Ftr%3E+%3Ctr%3E+%3Ctd+style%3D%22font-family%3Aarial%3Bcolor%3A%23333%3Bfont-size%3A16px%22%3E+Hi%2C%3Cbr%3E+%3Cbr%3E+My+name+is+Anthony+Bloomer%2C+an+Engineering+professional+in+the+IT+industry.%3Cbr%3E+%3Cbr%3E+Currently%2C+I+am+working+for+a+large+multinational+company+called+New+Relic+as+a+Technical+Support+Engineer.%3Cbr%3E+%3Cbr%3E+This+property+you+are+advertising+is+ideal+since+it+is+very+close+to+my+workplace+in+Dublin+City+Centre.%3Cbr%3E+%3Cbr%3E+I+would+be+very+grateful+for+an+opportunity+to+view+the+room+in+person+and+chat+with+you+about+it.%3Cbr%3E+%3Cbr%3E+I+can+provide+references+and+letter+of+employment+on+request.%3Cbr%3E+%3Cbr%3E+I+do+look+forward+to+hearing+back+from+you.%3Cbr%3E+%3Cbr%3E+All+the+best%2C%3Cbr%3E+Anthony+Bloomer+%3C%2Ftd%3E+%3C%2Ftr%3E+%3C%2Ftbody%3E%3C%2Ftable%3E+%3C%2Ftd%3E+%3C%2Ftr%3E+%3C%2Ftbody%3E%3C%2Ftable%3E+%3Cbr%3E+%3C%2Ftd%3E+%3C%2Ftr%3E+%3Ctr%3E+%3Ctd+height%3D%2215%22+style%3D%22height%3A15px%3Bborder-bottom%3A2px+solid+%23efefef%22%3E%3C%2Ftd%3E+%3C%2Ftr%3E+%3Ctr%3E%3Ctd+height%3D%2215%22+style%3D%22height%3A15px%22%3E%3C%2Ftd%3E%3C%2Ftr%3E+%3Ctr%3E+%3Ctd+style%3D%22font-family%3Aarial%3Bcolor%3A%23333%3Bfont-size%3A16px%22%3E+Please+be+aware+of+suspicious+behaviour.+Never+wire+funds+through+a+third+party+money+transfer+service.+For+more+advice+please+see+%3Ca+style%3D%22text-decoration%3Anone%3Bcolor%3A%232953aa%22+href%3D%22https%3A%2F%2Fwww.daft.ie%2Fsafety-online%22+target%3D%22_blank%22%3E+Daft%26%2339%3Bs+Safety+Online+Guide+%3C%2Fa%3E+%3C%2Ftd%3E+%3C%2Ftr%3E+%3Ctr%3E+%3Ctd+height%3D%2215%22+style%3D%22height%3A15px%3Bborder-bottom%3A2px+solid+%23efefef%22%3E%3C%2Ftd%3E+%3C%2Ftr%3E+%3Ctr%3E%3Ctd+height%3D%2215%22+style%3D%22height%3A15px%22%3E%3C%2Ftd%3E%3C%2Ftr%3E+%3Ctr%3E%3Ctd+height%3D%2210%22+style%3D%22height%3A10px%22%3E%3C%2Ftd%3E%3C%2Ftr%3E+%3Ctr%3E+%3Ctd+style%3D%22font-family%3Aarial%3Bcolor%3A%23333%3Bmargin%3A0px%3Bfont-size%3A16px%22%3E+Kind+Regards%2C+%3C%2Ftd%3E+%3C%2Ftr%3E%3Ctr%3E+%3Ctd+style%3D%22font-family%3Aarial%3Bcolor%3A%23333%3Bfont-size%3A16px%22%3E+The+Daft.ie+Team+%3C%2Ftd%3E+%3C%2Ftr%3E+%3Ctr%3E+%3Ctd+height%3D%2220%22+style%3D%22height%3A20px%22%3E%3C%2Ftd%3E+%3C%2Ftr%3E+%3Ctr%3E+%3Ctd+style%3D%22color%3A%23777%3Bmargin%3A0px%3Bfont-family%3Aarial%3Bfont-size%3A11px%22%3E+Email%3A+%3Ca+href%3D%22mailto%3Asupportdesk%40daft.ie%22+style%3D%22font-weight%3Abold%3Btext-decoration%3Anone%3Bcolor%3A%232953aa%22+target%3D%22_blank%22%3E+supportdesk%40daft.ie+%3C%2Fa%3E+%7C+Daft+Media+Ltd.%2C+3rd+Floor+Latin+Hall%2C+Golden+Lane%2C+Dublin+8+%3C%2Ftd%3E+%3C%2Ftr%3E+%3Ctr%3E+%3Ctd+height%3D%2210%22+style%3D%22height%3A10px%22%3E%3C%2Ftd%3E+%3C%2Ftr%3E+%3C%2Ftbody%3E%3C%2Ftable%3E+%3C%2Ftd%3E+%3C%2Ftr%3E+%3Ctr%3E+%3Ctd%3E+%3C%2Ftd%3E+%3C%2Ftr%3E+%3C%2Ftbody%3E%3C%2Ftable%3E+%3C%2Ftd%3E+%3C%2Ftr%3E+%3C%2Ftbody%3E%3C%2Ftable%3E+%3C%2Fdiv%3E+%3C%2Ftd%3E+%3Ctd+style%3D%22width%3A2%25%22%3E%26nbsp%3B%3C%2Ftd%3E+%3C%2Ftr%3E+%3C%2Ftbody%3E%3C%2Ftable%3E+%3C%2Ftd%3E+%3C%2Ftr%3E+%3C%2Ftbody%3E%3C%2Ftable%3E+%3Cimg+border%3D%220%22+width%3D%221%22+height%3D%221%22+alt%3D%22%22+src%3D%22http%3A%2F%2Fpost.spmailtechnol.com%2Fq%2Fokk99SCiCrBeq5auetPObw%7E%7E%2FAAFbhgA%7E%2FRgRdkLCdPlcDc3BjQgoAAB19r1slyyCmUhVzcmlrYW50aDY4MUBnbWFpbC5jb21YBAAAAAA%7E%22%3E+%3C%2Fdiv%3E+%3C%2Fdiv%3E%3Cdiv%3E%3Cbr%3E%3C%2Fdiv%3E%3Cbr%3E%3C%2Fdiv%3E\";\n// Add two middleware calls. The first attempting to parse the request body as\n// JSON data and the second as URL encoded data.\n\nPicker.middleware( bodyParser.json() );\nPicker.middleware( bodyParser.urlencoded( { extended: true } ) );\n// Picker.middleware( bodyParser.raw( ) );\n// Picker.middleware( bodyParser.text( ) );\n\n  Picker.route('/lettingEnquiry2', function(params, req, res, next) {\n      if(req.method!='POST') {\n          res.writeHead(400, 'Bad Request');\n          res.end();\n          return false; // This is an invalid request\n      }\n      console.log('in lettingEnquiry2');\n\n      let body = ''\n      req.on('data', Meteor.bindEnvironment((data) => {\n          body += data;\n      })).on('end', Meteor.bindEnvironment(() => {\n          // console.log(body)\n\n          // keys = Object.keys(body)\n          // json = keys[0];\n          console.log(\"typeof body\");\n          console.log(typeof body);\n          console.log(body);\n          // console.log(typeof keys);\n          // console.log(typeof json);\n          // console.log(json);\n          try{\n              json = JSON.parse(body);\n          }catch(e){\n              console.log('Parse failed');\n              console.log(e)\n              res.writeHead(400, 'Bad Request');\n              res.end();\n              return;\n          }\n\n          if(!json){\n              res.writeHead(400);\n              res.end('Invalid input');\n              return;\n          }\n\n          processEmail = processEmail.bind(this);\n          let ret = processEmail(json);\n          if(!ret.status ){\n              res.writeHead(400);\n              res.end('Invalid input. Error: '+ret.message);\n              return;\n          }\n\n          res.writeHead(200);\n          res.end('success');\n\n    })\n      )\n  })\n  Picker.route('/lettingEnquiry', function(params, req, res, next) {\n    if(req.method!='POST') {\n        res.writeHead(400, 'Bad Request');\n        res.end();\n        return false; // This is an invalid request\n    }\n    console.log('in lettingEnquiry');\n\n    let json = {}\n    if(req.body) {\n        // console.log(\"req.body\")\n        // console.log(req.body)\n        json = req.body;\n        json = JSON.stringify(json);\n        // console.log(typeof json);\n        // console.log(json);\n        try{\n            json = JSON.parse(json);\n        }catch(e){\n            console.log('Parse failed');\n            console.log(e)\n            res.writeHead(400, 'Bad Request');\n            res.end();\n            return;\n        }\n    }else{\n\n    }\n    \n    if(!json){\n        res.writeHead(400);\n        res.end('Invalid input');\n        return;\n    }\n    processEmail = processEmail.bind(this);\n    let ret = processEmail(json);\n    if(!ret.status ){\n        res.writeHead(400);\n        console.log('Invalid input. Error: '+ret.message);\n        res.end('Invalid input. Error: '+ret.message);\n        return;\n    }\n    \n    res.writeHead(200);\n    res.end('success');\n});\nfunction processEmail(json){\n    //How to handle spam, email \n    // console.log(json);\n    // console.log(json.recipient);\n    // console.log(json['recipient']);\n    let enq = {}\n    try{\n        enq.fullname = json.subject.split('from ')[1].split(' on')[0];//Enquiry from Anthony Bloomer on Daft.ie | Flat share in Rockfield, Dundrum, Co. Dublin\n    }\n    catch(e){\n        console.log('failed to retrive full name')\n    }\n    // enq.date = new Date(json.Date);\n    try{\n        enq.message = json['body-plain'].split('Message:')[1].split('Please be aware of suspicious')[0].trim();\n        // enq.message = json['body-plain'].split('Message:')[1].split('</tr>')[0].trim();\n    }\n    catch(e){\n        console.log('failed to retrive message')\n        console.log(e)\n    }\n    // enq.recipient = json.recipient;\n    let propKey = '';\n    try{\n        propKey = json.recipient.split('let-')[1].split('@')[0];\n        if(propKey.length!=5) throw \"Invalid property Key\";\n        propKey = propKey.toUpperCase();\n    }\n    catch(e){\n        return {\n            status:false,\n            message:'failed to retrieve property Key'\n        }\n    }\n    enq.propKey = propKey;\n    // console.log(json['body-plain'].replace(/\\n/g, \" \") );\n    // console.log('more deeper');\n    // console.log(json['body-plain'].replace(/\\n/g, \" \").replace(/ {1,}/g,\" \") );\n    // console.log('with split');\n    // console.log(json['body-plain'].replace(/\\n/g, \" \").replace(/ {1,}/g,\" \").split('Email: ')[1] );\n    try{\n        enq.email = json['body-plain'].match(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\\.[a-zA-Z0-9._-]+)/gi)[0]\n        // enq.email = json['body-plain'].replace(/\\n/g, \" \").replace(/ {1,}/g,\" \").split('Email: ')[1].split(' ')[0];\n        if(enq.email.indexOf('supportdesk@daft.ie')!=-1){//it took dafts email. use 2nd logic now.\n            console.log('Using 2nd logic to fetch email')\n            enq.email = json['body-plain'].split('Email:')[1].split(' ')[1].trim();\n            if( !validateEmail(enq.email) ){\n                console.log('Using 3rd logic to fetch email')\n                enq.email = json['body-plain'].split('Email:')[1].split(' ')[0].trim();\n            }\n            if( !validateEmail(enq.email) ){\n                console.log('Using 4rd logic to fetch email')\n                enq.email = enq.email.match(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\\.[a-zA-Z0-9._-]+)/gi)[0]\n            }\n            console.log('Email is: '+enq.email)\n        }\n    }catch(e){}\n    if( !validateEmail(enq.email) ) {\n        return {\n            status:false,\n            message:'failed to retrieve email'\n        }\n    }\n    console.log(enq.email);\n\n\n\n    try{\n        enq.mobile = json['body-plain'].split('Phone number:')[1].split('Property')[0].trim();\n        // enq.mobile = json['body-plain'].split('Phone number: ')[1].split(' ')[0];\n    }catch(e){}\n    // console.log(enq);\n\n    let auction = Collections.Auctions.findOne({lettingAuctionCode: enq.propKey});\n    if(!auction ){\n        //Auction not found, don't process this \n        return {\n            status:false,\n            message:'Auction not found'\n        }\n    }\n    let property = false;\n    if(auction.propertyId) property = Collections.Properties.findOne({_id:auction.propertyId})\n    if(!property ){\n        //Auction not found, don't process this \n        return {\n            status:false,\n            message:'Property not found'\n        }\n    }\n    let user = Meteor.users.findOne({'profile.email': enq.email})\n    if(!user){//User not found, so insert a new emailEnquiry, send emailEnquiryReceived\n        let existingEnquiry = Collections.EmailEnquiries.findOne({email: enq.email,propertyId: property._id,auctionId: auction._id})\n\n        if(!existingEnquiry){//Not existing, insert new one\n            let emailEnquiryId = Collections.EmailEnquiries.insert({\n                fullname: enq.fullname,\n                email: enq.email,\n                mobile: enq.mobile,\n                // propKey: enq.propKey,\n                propertyId: property._id,\n                auctionId: auction._id,\n                createdAt: new Date(),\n                message: enq.message,\n                isArchived: false\n            })\n            console.log(\"emailEnquiry placed: \"+emailEnquiryId);\n            var data = {\n                userEmail: enq.email,\n                fullname: enq.fullname,\n                requestType: 'emailEnquiryReceived',//This is an Ack email for all the emailEnqueries placed by user in a group of 15mns. \n                emailEnquiryId:emailEnquiryId,\n                propertyId: property._id,\n            }\n            Meteor.call('requestEmail',data);\n\n            if(isNaN(auction.enquiryCount)){//if its not a number ; for first time scenarios.\n                Collections.Auctions.update(auction._id, {\n                    $set: {\n                        \"enquiryCount\": 1\n                    }\n                });\n            }else{\n                Collections.Auctions.update(auction._id, {\n                    $inc: {\n                        \"enquiryCount\": 1\n                    }\n                });\n            }\n\n            //////////////LANDLORD EMAIL\n            let address = titleCase(property.address.address);\n            if (property.address.area) address +=', '+titleCase(property.address.area)\n            if (property.address.county) address +=', '+titleCase(property.address.county)\n            let subject = 'Enquiry received for '+address;\n\n            let agent = Meteor.users.findOne({_id:property.createdByAgent})\n            let userFirstName = agent.profile.name;\n            if(userFirstName){\n                userFirstName = titleCase(userFirstName.split(' ')[0]);\n            }\n            let ec = auction.enquiryCount;\n            if(!ec)ec=1;\n            else ec+=1;\n            let ac = auction.bids;\n            let subHeading = 'This letting has received '+ec+' email '+(ec>1 ? 'enquiries':'enquiry')+' and '+(ac==0 ? 'no':ac)+' '+(ac!=1 ? 'applications':'application')+' so far.'\n            let sluggedName = slugifyEmailAddress(agent.profile.name);\n            if(!sluggedName)sluggedName = 'rent'\n            let propertyEmail = sluggedName+'-let-'+auction.lettingAuctionCode.toLowerCase()+\"@spotmycrib.ie\";\n            let user = {\n                \"profile\":{\n                    name:enq.fullname,\n                    email:enq.email,\n                    userFirstName:userFirstName\n                }\n            }\n            var mailData     = {\n                template    : 'emailEnquiryReceivedLandlord',\n                subject     : subject,\n                mailTo      : agent.profile.email,//mailTo: 'srikanth681@gmail.com',\n                replyTo      : enq.email,\n                property: property,\n                bedsCount   : property.bedrooms.length,\n                rentFormated: numDifferentiation(auction.price),\n                auction: auction,\n                enquiry:enq,\n                propertyKeys     : auction.lettingAuctionCode,\n                agent        : agent,\n                user        : user,\n                propertyImage:false,//dont need it here\n                propertyUrl:FlowRouter.url('rent', { slug: property.slug, key: auction.lettingAuctionCode }),\n                propertyApplicationsUrl:FlowRouter.url('account/propertyApplications', { id: property._id }),\n                propertyEmail:propertyEmail,\n                subHeading: subHeading\n            };\n            try{\n                Meteor.call('sendNotificationEmail', mailData);//Keep it asynchronous for speed\n                // Meteor.call('sendNotificationEmail', mailData,true);//if you don't want it to fail and need it to be sync, use email queues instead.\n            }catch(e){\n                console.log('Mail sending failed. ')\n                console.log(e)\n                return {\n                    status:false,\n                    message:'Mail sending failed'\n                }\n            }\n\n\n        }else{//There is an existing enquiry\n            return {\n                status:false,\n                message:'Request already exists'\n            }\n        }\n    }else if(user){// User found, insert bid, send uploadRefsReminder\n        this.placeBidCallback = function(error, result){\n            if(error){\n                console.log(\"emailEnquiry bid failed\");\n                console.log(error);\n                return false;\n            }\n            if(result.status=='Success'){\n                console.log(\"emailEnquiry bid success\");\n            }\n        }\n        this.placeBidCallback = this.placeBidCallback.bind(this);\n        Meteor.call('placeBid',[auction._id, auction.price, enq.message,user._id],this.placeBidCallback);\n        if(getUserProfileScore(user)< 70){\n            var mailData = {\n                userEmail: enq.email,\n                fullname: enq.fullname,\n                requestType: 'uploadRefsReminder',//This is a reminder email for the user to complete their profile. \n                propertyId: property._id,\n                auctionId: auction._id,\n            }\n            // Meteor.call('requestEmail',mailData);//Temporarly disabling the reminder emails.\n        }\n    }\n    \n    return {\n        status:true,\n        message:'end of method'\n    }\n}\n\nfunction getUserProfileScore (user) {\n    let score = 0;\n\n    if(user.profile.mobile){score += 15;}\n    if(!user.services)user.services={}\n    if(user.services.facebook){score += 15;}\n    // if(user.services.google){score += 10;}\n    if(user.services.twitter){score += 10;}\n    if(user.services.linkedin){score += 15;}\n    if(user.profile.references.hasPassport){score += 10;}\n    if(user.profile.references.employerName){score += 3;}\n    if(user.profile.references.employerTakeHome){score += 2;}\n    if(user.profile.references.hasWorkRef){score += 10;}\n    if(user.profile.references.hasLandlordRef){score += 10;}\n    if(user.profile.references.hasPPS){score += 3;}\n    // if(user.profile.references.hasFinancialRef){score += 0;}\n    if(user.profile.references.hasGovtID){score += 4;}\n    if(user.profile.references.hasResume){score += 3;}\n\n    if(score>100)score = 100;\n    return score;\n}\nfunction numDifferentiation(val) {\n    if(val >= 1000000000) val = (val/1000000000).toFixed(2) + ' Billion';\n    else if(val >= 1000000) val = (val/1000000).toFixed(2) + ' Million';\n    return val.toString().replace(/\\B(?=(\\d{3})+(?!\\d))/g, \",\");\n}\nfunction slugifyEmailAddress (text) {\n    if(!text)return '';\n    const a = 'àáäâèéëêìíïîòóöôùúüûñçßÿœæŕśńṕẃǵǹḿǘẍźḧ/_,:;'\n    const b = 'aaaaeeeeiiiioooouuuuncsyoarsnpwgnmuxzh------'\n    const p = new RegExp(a.split('').join('|'), 'g')\n\n    return text.toString().toLowerCase()\n        .replace(/\\s+/g, '.')           // Replace spaces with \".\"\n        .replace(p, c =>\n            b.charAt(a.indexOf(c)))     // Replace special chars\n        .replace(/&/g, '-and-')         // Replace & with ''\n        // .replace(/[^\\w\\-]+/g, '')       // Remove all non-word chars\n        .replace(/\\-\\-+/g, '-')         // Replace multiple - with single ''\n        .replace(/^-+/, '')             // Trim - from start of text\n        .replace(/-+$/, '')             // Trim - from end of text\n}\nfunction titleCase(str){\n    if(!str)return;\n    return str.charAt(0).toUpperCase() + str.toLowerCase().substring(1);\n}\n/*\nUrl {\n            I20181205-20:24:53.640(0)?   protocol: null,\n            I20181205-20:24:53.640(0)?   slashes: null,\n            I20181205-20:24:53.642(0)?   auth: null,\n            I20181205-20:24:53.644(0)?   host: null,\n            I20181205-20:24:53.645(0)?   port: null,\n            I20181205-20:24:53.646(0)?   hostname: null,\n            I20181205-20:24:53.646(0)?   hash: null,\n            I20181205-20:24:53.647(0)?   search: null,\n            I20181205-20:24:53.648(0)?   query: null,\n            I20181205-20:24:53.649(0)?   pathname: '/account/profile',\n            I20181205-20:24:53.649(0)?   path: '/account/profile',\n            I20181205-20:24:53.651(0)?   href: '/account/profile',\n            I20181205-20:24:53.651(0)?   _raw: '/account/profile' }\n\n\n */"]},"sourceType":"module","hash":"f8c5f43d70805f24bd5af4e390a53c581cf05bb0"}
